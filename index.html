<!DOCTYPE html>
<html lang=zh>
<head>
    <meta charset="utf-8">
    
    <title>Limoer的记事小本</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta property="og:type" content="website">
<meta property="og:title" content="Limoer的记事小本">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Limoer的记事小本">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Limoer的记事小本">
    

    
        <link rel="alternate" href="/" title="Limoer的记事小本" type="application/atom+xml" />
    

    

    <link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/libs/open-sans/styles.css">
    <link rel="stylesheet" href="/libs/source-code-pro/styles.css">

    <link rel="stylesheet" href="/css/style.css">

    <script src="/libs/jquery/2.1.3/jquery.min.js"></script>
    
    
        <link rel="stylesheet" href="/libs/lightgallery/css/lightgallery.min.css">
    
    
        <link rel="stylesheet" href="/libs/justified-gallery/justifiedGallery.min.css">
    
    
    
    


</head>

<body>
    <div id="container">
        <header id="header">
    <div id="header-main" class="header-inner">
        <div class="outer">
            <a href="/" id="logo">
                
                <span class="site-title">Limoer的记事小本</span>
            </a>
            <nav id="main-nav">
                
                    <a class="main-nav-link" href="/.">Home</a>
                
                    <a class="main-nav-link" href="/archives">Archives</a>
                
                    <a class="main-nav-link" href="/categories">Categories</a>
                
                    <a class="main-nav-link" href="/tags">Tags</a>
                
                    <a class="main-nav-link" href="/about">About</a>
                
            </nav>
            
                
                <nav id="sub-nav">
                    <div class="profile" id="profile-nav">
                        <a id="profile-anchor" href="javascript:;">
                            <img class="avatar" src="/css/images/62.png" />
                            <i class="fa fa-caret-down"></i>
                        </a>
                    </div>
                </nav>
            
            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="搜索" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="想要查找什么..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div>
        </div>
    </div>
    <div id="main-nav-mobile" class="header-sub header-inner">
        <table class="menu outer">
            <tr>
                
                    <td><a class="main-nav-link" href="/.">Home</a></td>
                
                    <td><a class="main-nav-link" href="/archives">Archives</a></td>
                
                    <td><a class="main-nav-link" href="/categories">Categories</a></td>
                
                    <td><a class="main-nav-link" href="/tags">Tags</a></td>
                
                    <td><a class="main-nav-link" href="/about">About</a></td>
                
                <td>
                    
    <div class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="搜索" />
    </div>

                </td>
            </tr>
        </table>
    </div>
</header>

        <div class="outer">
            
                

<aside id="profile">
    <div class="inner profile-inner">
        <div class="base-info profile-block">
            <img id="avatar" src="/css/images/62.png" />
            <h2 id="name">Limoer</h2>
            <h3 id="title">A student from SDU, focusing on browser side developing.</h3>
            <span id="location"><i class="fa fa-map-marker"></i>Jinan, China</span>
            <a id="follow" target="_blank" href="http://weibo.com/u/2994244652?refer_flag=1001030101_">关注我</a>
        </div>
        <div class="article-info profile-block">
            <div class="article-info-block">
                61
                <span>文章</span>
            </div>
            <div class="article-info-block">
                14
                <span>标签</span>
            </div>
        </div>
        
        <div class="profile-block social-links">
            <table>
                <tr>
                    
                    
                    <td>
                        <a href="http://github.com/xiaomoer/" target="_blank" title="github" class=tooltip>
                            <i class="fa fa-github"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="/" target="_blank" title="twitter" class=tooltip>
                            <i class="fa fa-twitter"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="/" target="_blank" title="facebook" class=tooltip>
                            <i class="fa fa-facebook"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="/" target="_blank" title="dribbble" class=tooltip>
                            <i class="fa fa-dribbble"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="/" target="_blank" title="rss" class=tooltip>
                            <i class="fa fa-rss"></i>
                        </a>
                    </td>
                    
                </tr>
            </table>
        </div>
        
    </div>
</aside>

            
            <section id="main">
    <article id="post-barrage" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2019/08/07/barrage/">从globalCompositeOperatio到蒙版弹幕</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2019/08/07/barrage/">
            <time datetime="2019-08-07T12:29:05.000Z" itemprop="datePublished">2019-08-07</time>
        </a>
    </div>


                        
                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/canvas/">canvas</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h1 id="从globalCompositeOperation到蒙版弹幕"><a href="#从globalCompositeOperation到蒙版弹幕" class="headerlink" title="从globalCompositeOperation到蒙版弹幕"></a>从<code>globalCompositeOperation</code>到<strong>蒙版弹幕</strong></h1><h2 id="globalCompositeOperation属性"><a href="#globalCompositeOperation属性" class="headerlink" title="globalCompositeOperation属性"></a><code>globalCompositeOperation</code>属性</h2><p><em>Canvas</em> 有一个不那么常用的属性<code>globalCompositeOperation</code>，作用是<strong>设置如何将一个源图像绘制到目标图像上</strong>。该如何理解？</p>
<p>在使用<em>Canvas</em>绘制图像时，我们可以多次调用<code>ctx.drawImage()</code>或者是其它绘图函数<code>ctx.fillRect()</code>等进行绘制。而<code>globalCompositeOperation</code>属性就指定了当前将要绘制的图像在画布上如果和已绘制的图形重合该怎样显示。该属性有多个可选值：</p>
<ul>
<li><code>source-over</code>默认值，目标图像重合部分将显示在上方(源图像被覆盖)。</li>
<li><code>source-in</code>目标图像中显示源图像。源图像只显示重合的部分，目标图像透明。</li>
<li><code>source-out</code>在目标图像之外显示源图像。只会显示非重合的部分，目标图像透明。</li>
<li><code>lighter</code> 显示源图像+目标图像。</li>
<li><code>copy</code> 只显示源图像。</li>
<li><code>xor</code> 亦或。</li>
<li><code>destination-*</code></li>
</ul>
<p>例如：当设置属性值为<code>source-over</code>时，下例将会显示为：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> canvas = <span class="built_in">document</span>.getElementById(<span class="string">'canvas'</span>);</span><br><span class="line"><span class="keyword">const</span> ctx = canvas.getContext(<span class="string">'2d'</span>);</span><br><span class="line">ctx.fillStyle = <span class="string">'red'</span>;</span><br><span class="line">ctx.fillRect(<span class="number">10</span>, <span class="number">10</span>, <span class="number">80</span>, <span class="number">40</span>);</span><br><span class="line">ctx.globalCompositeOperation = <span class="string">'source-over'</span>;</span><br><span class="line">ctx.fillStyle = <span class="string">'green'</span>;</span><br><span class="line">ctx.fillRect(<span class="number">20</span>, <span class="number">20</span>, <span class="number">80</span>, <span class="number">40</span>);</span><br></pre></td></tr></table></figure></p>
<p><img src="sourceover.jpg" alt="source-over"></p>
<p>可以看到，后绘制的绿色图像(源图像)和先绘制的红色图像(目标图像)发生了重叠，而源图像在层叠上层。</p>
<p>再来看看属性值为<code>source-in</code>的情况：</p>
<p><img src="sourcein.bmp" alt="source-in"></p>
<p>源图像和目标图像发生了重合，结果只显示了源图像的重合部分。</p>
<h2 id="蒙版弹幕"><a href="#蒙版弹幕" class="headerlink" title="蒙版弹幕"></a><strong>蒙版弹幕</strong></h2><p>不考虑弹幕内容、显示等因素，使用<code>Canvas</code>实现弹幕就是一个不断擦除和绘制的过程，弹幕本身是绘制在画布上的，和内容(视频、图片等)是分层显示的，并无直接关系。</p>
<p><code>Canvas</code>弹幕且不论性能，如果弹幕过多往往会挡住内容本身，体验并不好。<em>B站</em>的弹幕使用了名为<strong>蒙版弹幕</strong>的技术，这种技术可以让弹幕不遮挡内容主体。这里不讨论<em>B站</em>的<strong>蒙版弹幕</strong>是如何实现的，先来看看<code>CSS</code>中一个名叫<code>mask</code>的属性。</p>
<p><code>mask</code>属性用来设置<strong>遮罩</strong>，那么何为遮罩呢？简单点来说就是使用一张图片来遮住另一张图片，并且如果用于遮罩的图片包含透明的部分，透明部分将会被遮住，非透明部分将会显示为被遮罩图片的内容。</p>
<p><code>mask</code>的内容到此为止，是不是和<code>globalCompositeOperation = &#39;source-in&#39;</code>很像？其实我认为不是很像。</p>
<p>修改上面的例子，如果将两个图形绘制的区域完全重合，那么设置<code>globalCompositeOperation = &#39;source-in&#39;</code>后，不出意外，源图像将会完全覆盖目标图像。</p>
<p>如果我们把目标图像和源图像均换成两张等宽高的图片，那么源图片将会完全遮挡目标图片。</p>
<p>如果目标图像和源图像存在透明区域(<em>RGBA</em> 中 <em>Alpha</em> 为<code>0</code>的区域)，那么源图像会完全遮住目标图像，但是目标图像的透明区域仍然是透明的。</p>
<p>如果反向抠图后，目标图像只有主体是透明的，那么源图像将会覆盖目标图像的非主体区域，主体区域由于是透明的，无能为力。</p>
<p>把目标图像换成蒙版图片，把源图像换成包含弹幕的图像，那么，蒙版图像透明区域不会被覆盖。</p>
<p>此时再把覆盖后的图片渲染在<code>Canvas</code>上，大功告成。</p>
<p>回顾一下<code>globalCompositeOperation = &#39;source-in&#39;</code>的解释：<br><strong>目标图像中显示源图像。源图像只显示重合的部分，目标图像透明。</strong><br>目标图像会被完全覆盖，而源图像只显示重合的部分，由于透明区域并不属于目标图像，所以在透明区域并不会显示源图像。</p>
<p>先来看一个例子：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ctx.fillStyle = <span class="string">'red'</span>;</span><br><span class="line">ctx.beginPath();</span><br><span class="line">ctx.moveTo(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">ctx.lineTo(<span class="number">0</span>, <span class="number">150</span>);</span><br><span class="line">ctx.lineTo(<span class="number">150</span>, <span class="number">0</span>);</span><br><span class="line">ctx.fill();</span><br><span class="line">ctx.moveTo(<span class="number">150</span>, <span class="number">0</span>);</span><br><span class="line">ctx.lineTo(<span class="number">300</span>, <span class="number">150</span>);</span><br><span class="line">ctx.lineTo(<span class="number">300</span>, <span class="number">0</span>);</span><br><span class="line">ctx.fill();</span><br></pre></td></tr></table></figure>
<p>在<code>300</code>*<code>150</code>的画布上先绘制两个红色的三角形，作为目标图像，此时画布中间的区域是透明的。</p>
<p><img src="source.bmp" alt="目标图像"></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ctx.globalCompositeOperation = <span class="string">'source-in'</span>;</span><br><span class="line">ctx.fillStyle = <span class="string">'green'</span>;</span><br><span class="line">ctx.fillRect(<span class="number">0</span>, <span class="number">0</span>, <span class="number">300</span>, <span class="number">150</span>);</span><br></pre></td></tr></table></figure>
<p>然后再绘制一个充满画布的矩形覆盖到目标图像上，此时的结果是这样的：</p>
<p><img src="result.bmp" alt="覆盖结果"></p>
<p>目标图像(两个红色的三角形)已经被完全覆盖了，而透明区域仍然透明。</p>
<h2 id="简易实现"><a href="#简易实现" class="headerlink" title="简易实现"></a>简易实现</h2><p>为了实现<strong>蒙版弹幕</strong>，需要准备：</p>
<ul>
<li>原版图像</li>
<li>蒙版图像</li>
<li>Canvas弹幕</li>
</ul>
<p>这里原版图像使用下面这张<strong>菊花图</strong>：</p>
<p><img src="flower.jpg" alt="原版图片"></p>
<p>经过抠图(主体变成透明)，生成的蒙版图片如下：</p>
<p><img src="flower1.png" alt="蒙版图像"></p>
<p>弹幕系统的实现不做过多的介绍，这里只关注绘制，和上例的绘制过程一致，首先绘制蒙版图像，再绘制弹幕内容到蒙版上进行覆盖。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">drawBarrages() &#123;</span><br><span class="line">  <span class="keyword">let</span> context = <span class="keyword">this</span>.useMask ? <span class="keyword">this</span>.bgCtx : <span class="keyword">this</span>.ctx;</span><br><span class="line">  <span class="keyword">if</span>(<span class="keyword">this</span>.barrageList.length) &#123;</span><br><span class="line">    context.clearRect(<span class="number">0</span>, <span class="number">0</span>, <span class="keyword">this</span>.width, <span class="keyword">this</span>.height);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>; i &lt; <span class="keyword">this</span>.barrageList.length; i++) &#123;</span><br><span class="line">      <span class="comment">// 此时弹幕将要移除画布</span></span><br><span class="line">      <span class="keyword">let</span> barrage = <span class="keyword">this</span>.barrageList[i];</span><br><span class="line">      <span class="keyword">if</span>(barrage.left + barrage.width &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.barrageList.splice(i, <span class="number">1</span>); <span class="comment">// 移除该弹幕</span></span><br><span class="line">        i -= <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span>((barrage.left + barrage.width+<span class="number">600</span>) &lt; <span class="keyword">this</span>.width &amp;&amp; barrage.isChecked === <span class="literal">false</span>) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 此时已经完全出跑道并且还没有发起检查。</span></span><br><span class="line">        <span class="keyword">let</span> index = vm.statics.findIndex(<span class="function">(<span class="params">item</span>) =&gt;</span> item === barrage.top);</span><br><span class="line">        barrage.isChecked = <span class="literal">true</span>;</span><br><span class="line">        used[index] = <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      barrage.left = barrage.left - barrage.offset;</span><br><span class="line">      <span class="keyword">this</span>.drawOneBarrage(barrage);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// #1 擦除上次绘制</span></span><br><span class="line">    <span class="keyword">this</span>.ctx.clearRect(<span class="number">0</span>, <span class="number">0</span>, <span class="keyword">this</span>.width, <span class="keyword">this</span>.height);</span><br><span class="line">    <span class="comment">// #2 绘制蒙版图像</span></span><br><span class="line">    <span class="keyword">this</span>.ctx.putImageData(<span class="keyword">this</span>.maskImage, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// #3 设置compose类型</span></span><br><span class="line">    <span class="keyword">this</span>.ctx.globalCompositeOperation = <span class="string">'source-in'</span>;</span><br><span class="line">    <span class="comment">// #4 绘制弹幕</span></span><br><span class="line">    <span class="keyword">this</span>.ctx.drawImage(<span class="keyword">this</span>.bgCanvas, <span class="number">0</span>, <span class="number">0</span>, <span class="keyword">this</span>.width, <span class="keyword">this</span>.height);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">this</span>.stop = requestAnimationFrame(<span class="keyword">this</span>.drawBarrages.bind(<span class="keyword">this</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的代码是完整绘制一帧的逻辑，跳过绘制弹幕文本的循环，关注整体绘制和层叠逻辑。其中绘制总分为四步，擦除上一帧结果，绘制蒙版(作为目标图像)，设置<code>compose</code>类型为<code>source-in</code>，绘制弹幕(作为源图像)。</p>
<p>注意到，蒙版图像使用<code>ctx.putImageData</code>绘制，这表示蒙版图像是<code>ImageData</code>类型，可以通过<code>ctx.getImageData()</code>拿到(需先绘制在画布上)，这里也可以<code>png</code>图片作为蒙版图片直接绘制在画布上。</p>
<p><code>this.ctx.drawImage(this.bgCanvas, 0, 0, this.width, this.height)</code>用于绘制弹幕，<code>this.bgCanvas</code>是绘制了弹幕文本的<code>Canvas</code>画布，这里使用了<em>离屏Canvas</em> 技术，该画布并不会单独绘制在屏幕上。</p>
<p>绘制结果如下图：</p>
<p><img src="maskdemo.bmp" alt="弹幕绘制结果"></p>
<p>可以看到，弹幕并没有遮挡我们的主体(<strong>菊花</strong>)，实现了<strong>蒙版弹幕</strong>的预期效果。</p>
<h2 id="尾巴"><a href="#尾巴" class="headerlink" title="尾巴"></a>尾巴</h2><p>我们的确实现了蒙版弹幕，其主体是使用<em>Canvas</em>绘制蒙版图片和弹幕在同一张画布上，并且设置<code>globalCompositeOperation = &#39;source-in&#39;</code>来达到弹幕完全覆盖蒙版的效果。</p>
<p>简易实现的内容主体是一张静态的图片，如果要实现视频<strong>蒙版弹幕</strong>效果，需要提供每一帧的蒙版图像。在渲染某一帧时，最终的结果使用该帧的蒙版图像和实时弹幕组合而成。</p>
<p>其实<strong>蒙版弹幕</strong>的关键是提供蒙版图像，对于单个图片还好，我们可以针对这张图片单独制作一张蒙版图像。但是对于视频<strong>蒙版弹幕</strong>，我们需要逐帧生成蒙版图像，工作量之大可想而知。并且如何生成蒙版图像，如何标注主体是关键中的关键。这一部分理应借助机器学习，进行图像识别和分割。</p>
<p>一个可行的办法是事先针对每个视频，先逐帧生成蒙版图像，在进行流媒体播放的时候同时传递蒙版图像，最终在前端进行组装，完成视频<strong>蒙版弹幕</strong>。</p>
<p>完。</p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://yoursite.com/2019/08/07/barrage/" data-id="cjz18hg4s000el8j6onwr28x0" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://yoursite.com/2019/08/07/barrage/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://yoursite.com/2019/08/07/barrage/">评论</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-hooks" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2019/07/07/hooks/">记一次React Hooks的使用</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2019/07/07/hooks/">
            <time datetime="2019-07-07T00:48:50.000Z" itemprop="datePublished">2019-07-07</time>
        </a>
    </div>


                        
                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/React/">React</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <blockquote>
<p>有这么一个需求：需要渲染一个表格，表格的内容会随着用户的操作而重新请求数据，并且在用户离开这个表格所在的页面(路由)后缓存数据，再次进入该页面的时使用已缓存数据。</p>
</blockquote>
<blockquote>
<p>目前在使用的表格组件是纯函数组件，只负责渲染，数据请求则写在其父组件，数组则存在<code>Redux</code>中。经过考虑，需要把数据请求的逻辑移入表格组件中，使得表格组件承担更多的职责，在<code>React 16.8</code>之前，我们不得不把表格组件写成<code>class</code>组件。</p>
</blockquote>
<p>而现在，可以使用<code>hooks</code>，以最少的更改，来实现这一需求。</p>
<h3 id="需要哪些hooks"><a href="#需要哪些hooks" class="headerlink" title="需要哪些hooks?"></a>需要哪些<code>hooks</code>?</h3><p>我们的需求是把请求数据的逻辑移入到表格组件中，表格的数据仍然保存在<code>Redux</code>中。众所周知，<em>数据获取</em>是一个有副作用的操作，而<code>useEffect</code>这个<code>hooks</code>就是用来处理有副作用的操作。</p>
<p>在使用<code>hooks</code>之前，我们一般在<code>componentDidMount</code>和<code>componentDidUpdate</code>或者是很少使用的<code>componentWillUnMount</code>来进行DOM操作，数据请求等副作用操作。而<code>useEffect</code>则可以简单的看做是这三个生命周期函数的合集，其在组件的这三个生命周期时，都会被调用到。</p>
<p>所以，使用<code>useEffect</code>解决了所有问题。</p>
<h4 id="“真”解决了所有问题？"><a href="#“真”解决了所有问题？" class="headerlink" title="“真”解决了所有问题？"></a>“真”解决了所有问题？</h4><p>先把代码写起来:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useEffect &#125; <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">const</span> MyTable = <span class="function">(<span class="params">&#123; fetchData, param &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    fetchData(param);</span><br><span class="line">  &#125;, [param])</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;Table /&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> connect(stateToProps,actionToProps)(MyTable);</span><br></pre></td></tr></table></figure></p>
<p>仅仅三行代码，就搞定了。更改<code>params</code>，一切正常；从其它页面进入，看起来也很正常。可为什么是看起来正常呢？因为你打开控制台，查看<code>network xhr</code>，再进入页面，请求发送了！并没有使用缓存的数据！</p>
<p>所以，问题并没有解决。</p>
<h3 id="如何更好的利用缓存数据"><a href="#如何更好的利用缓存数据" class="headerlink" title="如何更好的利用缓存数据"></a>如何更好的利用缓存数据</h3><blockquote>
<p>问题：既然<code>useEffect</code>能够在上述三个生命周期中都执行，那么有没有办法区分出首次渲染和更新呢？</p>
</blockquote>
<p>答案是肯定的！在上面的代码中，我们使用了<code>useEffect(func, [param])</code>的形式，其实<code>useEffect</code>的第二个参数如果指定，那么<code>useEffect</code>就不是每次都执行了，而是只有<code>param</code>改变了才会执行。并且特别的，如果第二个参数传入<code>[]</code>空数组，那么<code>useEffect</code>只会执行一次，也就是说，<code>useEffect</code>只会在<code>componentDidMount</code>执行！代码写起来：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 其它代码不变，再加一个hook</span></span><br><span class="line">useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (data.status !== <span class="string">'fulfilled'</span>) &#123;</span><br><span class="line">    fetchData(param);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;, [])</span><br></pre></td></tr></table></figure></p>
<p>上面的<code>hook</code>会在初次渲染完成后执行，如果缓存数据的状态不是<code>fulfilled</code>，才请求数据。</p>
<h3 id="问题仍然没有解决"><a href="#问题仍然没有解决" class="headerlink" title="问题仍然没有解决"></a>问题仍然没有解决</h3><blockquote>
<p>很显而易见的是，即便是加了一个<code>hook</code>，而第二个<code>useEffect</code>仍然会执行，所以仍然会在初次加载完成后请求数据。</p>
</blockquote>
<p>这时候，就需要另一个<code>hook</code>出场了，那就是<code>useState</code>，我们需要在组件中维持一个是否是首次渲染的状态，只有当非首次渲染的时候，才会去执行第一个<code>hook</code>，因此可以避免不必要的的数据请求。代码码起来：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> [isInitial, changeInitialToFalse] = useState(<span class="literal">true</span>);</span><br><span class="line">useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (!isInitial) &#123;</span><br><span class="line">    fetchData(param);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;, [param]);</span><br><span class="line">useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  changeInitialToFalse(<span class="literal">false</span>);</span><br><span class="line">  <span class="keyword">if</span> (data.status !== <span class="string">'fulfilled'</span>) &#123;</span><br><span class="line">    fetchData(param);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;, []);</span><br></pre></td></tr></table></figure></p>
<p>经过测试，这一次是真一切正常了，缓存也已经用上。</p>
<h3 id="尾巴"><a href="#尾巴" class="headerlink" title="尾巴"></a>尾巴</h3><p>这是一次再普通不过的组件改造，这也是我在实际项目中第一次使用<code>hooks</code>。并且经历了从最开始遇到需求到决定使用<code>hooks</code>来最小化修改，到遇到问题差点改成更熟悉的<code>class</code>组件，到最终解决问题。最大的收货是，我对<code>useEffect</code>的了解又深刻了一些。把数据请求逻辑移到组件内部，除了降低组件间的耦合，更大程度上可以配合前一篇提到的<code>ScrollLoad</code>来做真正的滚动加载。毕竟数据才是组件的灵魂，数据都不懒加载，组件懒加载的意义就减了一半，手动狗头。</p>
<p>完。</p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://yoursite.com/2019/07/07/hooks/" data-id="cjz18hg4z000pl8j68ium66ap" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://yoursite.com/2019/07/07/hooks/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://yoursite.com/2019/07/07/hooks/">评论</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-resolve" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2019/07/07/resolve/">Webpack resolve解析</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2019/07/07/resolve/">
            <time datetime="2019-07-07T00:48:39.000Z" itemprop="datePublished">2019-07-07</time>
        </a>
    </div>


                        
                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/Webpack/">Webpack</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <blockquote>
<p>虽然在实际开发过程中，我们经常会使用<em>脚手架</em>来初始化一个项目，而<em>脚手架</em>一般都包含了完善的<code>webpack</code>配置，例如<strong>create-react-app</strong>这个脚手架，其把所有关于构建的内容封装在了<code>react-scripts</code>包中，在实际开发中，我们只需要运行<code>yarn run start/build/test</code>即可，它就可以帮我们搞定代码压缩、分隔，<code>jsx</code>和<code>es6</code>代码编译到<code>es5</code>等。</p>
</blockquote>
<p>回到<code>webpack</code>，我们都知道一个完整的<code>webpack</code>配置必定是要包含<em>入口(entry)</em>、<em>输出(output)</em>，可能还需要<em>模块-加载器(loader)</em>来处理不同类型的模块、或是使用<em>插件(plugin)</em>来在构建过程中自定义某些动作。除此之外，还有<code>webpack4</code>中才引入的用于性能和构建优化的<em>optimization</em>，还有用于开发环境的<em>开发服务器(devServer)</em>。还有不那么常用和深入人心的<em>解析(resolve)</em>。本篇将以<code>react-scripts</code>包的webpack配置中关于<code>resolve</code>的使用为基础，介绍如何在实际项目中可能会用到的自定义解析。</p>
<h4 id="他们是怎么写的"><a href="#他们是怎么写的" class="headerlink" title="他们是怎么写的"></a>他们是怎么写的</h4><p>首先来看看<code>react-scripts</code>关于<code>resolve</code>的配置：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">resolve: &#123;</span><br><span class="line">  modules: [<span class="string">'node_modules'</span>, paths.appNodeModules].concat(</span><br><span class="line">    modules.additionalModulePaths || []</span><br><span class="line">  ),</span><br><span class="line">  extensions: paths.moduleFileExtensions</span><br><span class="line">    .map(<span class="function"><span class="params">ext</span> =&gt;</span> <span class="string">`.<span class="subst">$&#123;ext&#125;</span>`</span>)</span><br><span class="line">    .filter(<span class="function"><span class="params">ext</span> =&gt;</span> useTypeScript || !ext.includes(<span class="string">'ts'</span>)),</span><br><span class="line">  alias: &#123;</span><br><span class="line">    <span class="string">'react-native'</span>: <span class="string">'react-native-web'</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  plugins: [</span><br><span class="line">    PnpWebpackPlugin,</span><br><span class="line">    <span class="keyword">new</span> ModuleScopePlugin(paths.appSrc, [paths.appPackageJson]),</span><br><span class="line">  ],</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure></p>
<ol>
<li><p><code>modules</code>属性：其指定了<code>webpack</code>在进行模块解析时应该搜索的目录，该属性可通过数组的方式指定一系列的路径，默认值是: <code>[&quot;node_modules&quot;]</code>，也就是说，在不指定该属性的情况下，如果我们引入<code>import xx from xx</code>，则<code>webpack</code>会默认在根目录的<code>node_modules</code>目录下查找该模块。上面的配置中指定了额外两种模块解析路径，其分别是<code>path.appNodeModules</code>和<code>modules.additionalModulePaths</code>，其中<code>path.appNodeModules</code>最终指向的是<code>path.resolve(fs.realpathSync(process.cwd()), &#39;node_modules&#39;)</code>也就是说，在默认情况下，该路径是<code>node_modules</code>的<strong>决定路径</strong>。<code>modules.additionalModulePaths</code>指向一个自定义路径，并通过<code>getAdditionalModulePaths(config)</code>方法生成该路径，如果<code>config</code>等于<code>{}</code>，则返回<code>process.env.NODE_PATH</code>(经过一些列的处理)，否则的话如果<code>config.baseUrl</code>存在且等于<code>modules.additionalModulePaths</code>或者<code>appSrc</code>则返回，否则抛出错误。也就是说，我们可以通过<code>jsconfig.json</code>来指定<code>baseUrl</code>属性，并且该属性只能是<code>node_modules</code>目录或<code>src</code>目录。</p>
</li>
<li><p><code>extensions</code>属性：自动解析的确定的扩展，默认值是<code>[&#39;.js&#39;, &#39;.json&#39;]</code>，也就是说，在默认情况下，我们<code>import ClsA from &#39;./clsa&#39;</code>，可以解析到<code>clsa.js</code>或是<code>cls.json</code>。上面的配置重写了<code>extensions</code>，定义了更多的扩展，并根据当前是否是<code>typescript</code>项目而是用对应的拓展。<code>paths.moduleFileExtensions</code>定义如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> moduleFileExtensions = [</span><br><span class="line">  <span class="string">'web.mjs'</span>,</span><br><span class="line">  <span class="string">'mjs'</span>,</span><br><span class="line">  <span class="string">'web.js'</span>,</span><br><span class="line">  <span class="string">'js'</span>,</span><br><span class="line">  <span class="string">'web.ts'</span>,</span><br><span class="line">  <span class="string">'ts'</span>,</span><br><span class="line">  <span class="string">'web.tsx'</span>,</span><br><span class="line">  <span class="string">'tsx'</span>,</span><br><span class="line">  <span class="string">'json'</span>,</span><br><span class="line">  <span class="string">'web.jsx'</span>,</span><br><span class="line">  <span class="string">'jsx'</span>,</span><br><span class="line">];</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>如何判别当前项目是<code>typescript</code>项目呢？<br><code>useTypeScript</code>是这样定义的：<code>const useTypeScript = fs.existsSync(paths.appTsConfig);</code>，很明显，通过判断是否存在<code>paths.appTsConfig</code>指向的文件也就是<code>tsconfig.json</code>，如果存在该文件，则表示该项目是中可以引用那些以<code>ts</code>为后缀的文件而不需要指定扩展名。</p>
<ol start="3">
<li>alias属性：创建模块的别名，确保在引入某些模块时可以变得简单。在上面中<code>alias</code>的配置是：<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">alias: &#123;</span><br><span class="line">  <span class="string">'react-native'</span>: <span class="string">'react-native-web'</span>,</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>也就是在我们使用名为<code>react-native</code>的模块时，其默认指向的是<code>react-native-web</code>模块，例如：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; View &#125; <span class="keyword">from</span> <span class="string">'react-native'</span>;</span><br></pre></td></tr></table></figure></p>
<p>此时项目中根本没安装<code>react-native</code>，仅安装了<code>react-native-web</code>，也就是说<code>react-native</code>成了<code>react-native-web</code>的别名。那么问题来了：为什么我们不直接写<code>import { View } from &#39;react-native-web&#39;</code>呢？</p>
<p>其实这涉及到<code>React-Native</code>强调的<code>一次编写，处处使用</code>，这里的使用并不仅仅是<strong>iOS</strong>和<strong>Android</strong>代码共用，而是<code>React-Native</code>和<code>Web</code>之间的代码共享。<code>react-native-web</code>就是这样一个库，它把<code>react-native</code>实现的组件实现成为<code>Web</code>组件，并且表现和<code>react-native</code>组件一致。这样，如果我们拿到的是一份<code>react-native</code>的代码，添加别名过后，就无需把所有的<code>react-native</code>全都改成<code>react-native-web</code>，这样就保证了两端代码的统一。</p>
<p>扯远了，继续。</p>
<ol start="4">
<li><code>plugins</code>属性：如果在配置解析的过程中需要插件的话，就可以在这里指定。上面的代码使用了<code>pnp-webpack-plugin</code>和<code>react-dev-utils/ModuleScopePlugin</code>，<code>pnp-webpack-plugin</code>是为了解决<code>require()</code>时过多的<code>I/O</code>操作带来的性能消耗，<code>pnp</code>思想来自<code>Yarn</code>团队，目的是为了解决安装和引用依赖效率过低问题。其建立了一张映射表，这张表记录了依赖版本关联和依赖与依赖之间的关联以及依赖存放的位置。有了这张表，就可以跳过繁琐的查找过程直接确定依赖在文件中的位置，从而提高性能。详情见<a href="https://stackoverflow.com/questions/53135221/what-does-yarn-pnp" target="_blank" rel="noopener">stackoverflow</a>。<code>ModuleScopePlugin</code>插件的官方解释是：该插件可以确保来自源程序目录(也就是<code>/src</code>)的相对导入不会使用到外部依赖。<code>new ModuleScopePlugin(paths.appSrc, [paths.appPackageJson])</code>接收两个参数，分别指定了源程序目录<code>/src</code>和<code>allowedFiles</code>指向了<code>package.json</code>文件。</li>
</ol>
<h4 id="更多的配置"><a href="#更多的配置" class="headerlink" title="更多的配置"></a>更多的配置</h4><ol>
<li><code>mainFields</code>属性：该属性是为了指定在不同环境中，默认使用哪个<code>webpack</code>的字段作为导入的入口。例如某个模块的<code>package.json</code>文件中执行了以下入口:<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="built_in">module</span>: <span class="string">'index.js'</span>,</span><br><span class="line">  main: <span class="string">'build/index.node.js'</span>,</span><br><span class="line">  browser: <span class="string">'build/index.js'</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>那么在<code>Node</code>环境下，默认会使用<code>build/index.node.js</code>导入，而在浏览器环境中，默认使用<code>build/index.js</code>导入。</p>
<ol start="2">
<li><code>mainFiles</code>属性：解析目录是默认使用的文件名。这个在实际开发中使用得比较多，例如我们开发的某个页面，文件路径为<code>/src/views/Home/index.js</code>，那么在实际使用这个页面的时候直接使用<code>import Home from &#39;./src/views/Home&#39;</code>即可，因为<code>mainFiles</code>默认的配置是：<code>[&#39;index&#39;]</code>，这个属性不建议自定义。</li>
</ol>
<p><code>resolve</code>还有很多属性，可以让我们充分自定义整个解析过程，但从<code>react-scripts</code>的实践上来看，其也是针对某些属性进行了定制，并没有一味的自定义。在对某个属性不是很熟悉并且没有过实践，建议不要盲目的修改。并且<code>resolve</code>的所有属性都提供了适应绝普通场景的默认值。最后，<code>resolve</code>使用愉快。</p>
<p>完。</p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://yoursite.com/2019/07/07/resolve/" data-id="cjz18hg4v000jl8j6q2fquwtc" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://yoursite.com/2019/07/07/resolve/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://yoursite.com/2019/07/07/resolve/">评论</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-scrollload" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2019/06/27/scrollload/">来，实现一个“滚动加载”</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2019/06/27/scrollload/">
            <time datetime="2019-06-27T12:37:20.000Z" itemprop="datePublished">2019-06-27</time>
        </a>
    </div>


                        
                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/React/">React</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h3 id="从问题入手，实现一个滚动加载"><a href="#从问题入手，实现一个滚动加载" class="headerlink" title="从问题入手，实现一个滚动加载"></a>从问题入手，实现一个滚动加载</h3><h4 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h4><p>懒加载的实现很简单，例如图片需要懒加载的时候，在初始加载时并不直接加载图片，而是用一个其它的图片或者占位符占位，当其它优先级更高的内容加载完成后，再使用真实的图片替换占位图。具体呢就是在初始加载时并不知道图片的<code>src</code>或者<code>src</code>指向一个占位图片，而真实图片的路径则是放在<code>data-src</code>这样的自定义属性中，当需要加载时，使用<code>data-src</code>替换<code>src</code>即可。</p>
<p>在React中，如果我们需要懒加载一个组件，实现原理也类似：当不需要加载的时候渲染占位符，当需要加载的时候再去加载真正的加载。滚动加载就是懒加载的一种特殊情况，其触发方式是滚动，只有当组件在可视区域中时，才开始加载。</p>
<p>实现滚动加载并不简单，我们需要考虑以下几个问题：</p>
<ol>
<li>如何找到组件所处的滚动容器。</li>
<li>如何判定组件是否可见。</li>
<li>如何使用“更好”组件占位符。</li>
<li>处理性能瓶颈。</li>
</ol>
<h4 id="ScrollLoad实现"><a href="#ScrollLoad实现" class="headerlink" title="ScrollLoad实现"></a>ScrollLoad实现</h4><p>懒加载使用最为广泛的实现是<a href="https://www.npmjs.com/package/react-lazy-load" target="_blank" rel="noopener">react-lazy-load</a>，使用起来也很方便：<code>&lt;LazyLoad&gt;&lt;MyComponent /&gt;&lt;/LazyLoad&gt;</code>，使用提供的<code>LazyLoad</code>组件包裹需要懒加载的组件即可，并且它提供了多个属性，例如<code>height</code>可以设置当内容未加载时的高度，<code>offset</code>则可以指定组件开始加载时需要偏移的距离(单位:<code>px</code>)，除此之外，我们还可以指定懒加载是否使用防抖和节流来提升性能，具体的使用见<a href="https://www.npmjs.com/package/react-lazy-load" target="_blank" rel="noopener">react-lazy-load</a>。</p>
<p>虽然<code>react-lazy-load</code>是一个使用广泛的懒加载解决方案，但是在最近的项目中，我却不得不放弃使用它。因为<code>react-lazy-load</code>会更改<strong>原有的DOM结构!!!</strong>，所以如果要使用<code>react-lazy-load</code>，我必须更改原本的样式，这将会是一个浩大的工程。</p>
<p>所以，接下来将会实现一个不需要额外DOM结构的滚动加载组件<code>ScrollLoad</code>组件。</p>
<h5 id="问题1：如果找到组件所在的可滚动元素"><a href="#问题1：如果找到组件所在的可滚动元素" class="headerlink" title="问题1：如果找到组件所在的可滚动元素"></a>问题1：如果找到组件所在的可滚动元素</h5><p>这个问题其实是：<em>如何找到组件所在的最近的可滚动的父元素</em>。</p>
<p>但是为什么需要找到那个可滚动的父元素呢？因为需要在该父元素上绑定<code>scroll eventListener</code>，当父元素在滚动时，就可以根据监听函数实时获取滚动的距离，并依此决定组件显示与否。</p>
<p>那怎么样才能找到<strong>最近可滚动父元素</strong>呢？为了定位父元素，我们需要定位当前元素，然后再向上遍历，去查找<code>overflow</code>显式设置为<code>auto|scroll</code>的元素。</p>
<p>查找可滚动父元素代码如下：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getScrollParent</span>(<span class="params">element</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> style = <span class="function">(<span class="params">elem, prop</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (getComputedStyle !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> getComputedStyle(elem, <span class="literal">null</span>).getPropertyValue(prop);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> elem.style[prop];</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">const</span> overflow = <span class="function"><span class="params">node</span> =&gt;</span> style(node, <span class="string">'overflow'</span>) + style(node, <span class="string">'overflow-x'</span>) + style(node, <span class="string">'overflow-y'</span>);</span><br><span class="line">  <span class="comment">// 循环判断父节点是否可滚动这里暂不添加，直接去直接父元素</span></span><br><span class="line">  <span class="keyword">if</span> (!(element <span class="keyword">instanceof</span> HTMLElement)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">window</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> parent = element;</span><br><span class="line">  <span class="keyword">while</span> (parent) &#123;</span><br><span class="line">    <span class="comment">// 当前节点是body或者document</span></span><br><span class="line">    <span class="keyword">if</span> (parent === <span class="built_in">document</span>.body || parent === <span class="built_in">document</span>.documentElement) &#123;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 当期元素无父节点</span></span><br><span class="line">    <span class="keyword">if</span> (!parent.parentNode) &#123;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 判断节点是否含有overflow等属性的值</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="regexp">/(scroll|auto|inherit)/</span>.test(overflow(parent))) &#123;</span><br><span class="line">      <span class="keyword">return</span> parent;</span><br><span class="line">    &#125;</span><br><span class="line">    parent = parent.parentNode;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">window</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>实现参考了<code>react-lazy-load</code>的实现，通过当前节点向上查找直到找到第一个可滚动的父元素或遍历到顶层元素，并且每进行一次遍历，会通过正则检查当前元素的样式的<code>overflow overflow-x overflow-y</code>，如果为<code>scroll|auto</code>，则返回该父元素。</p>
<p>那么怎么得到当前元素呢？可以通过<code>ReactDOM.findDOMNode(component)</code>访问真实的DOM节点，如果有多个子节点的话，默认返回第一个。因为<code>ScrollLoad</code>组件并没有添加额外的DOM结构，所以通过<code>findDOMNode(this)</code>拿到的节点就是目标节点，也就是占位节点(因为就算组件初始状态下可见，那么也要等应用挂载后才去判断，所以首次渲染的是占位组件)。</p>
<h5 id="问题2：如何判定组件是否可见"><a href="#问题2：如何判定组件是否可见" class="headerlink" title="问题2：如何判定组件是否可见"></a>问题2：如何判定组件是否可见</h5><p>如果只考虑上下滚动的话，一个很简单的判断公式是：<code>offsetTop &lt; seenHeight + scrollTop</code>，就是：<strong>组件相对于可滚动父元素的偏移</strong> &lt; <strong>可滚动父元素的可视高度</strong> + <strong>可滚动父元素的滚动距离</strong>。上面的三个计算量中<code>offsetTop</code>和<code>seenHeight</code>都是固定不变的，所以一个组件是否可见取决于父元素当前滚动的距离。<code>seenHeight</code>很好计算：<code>parent.clientHeight</code>即可，<code>scrollTop</code>也很简单：<code>parent.scrollTop</code>，<code>offsetTop</code>计算稍微复杂。</p>
<p>如何计算<code>offsetTop</code>？如果最近可滚动父元素是直接父元素的话，直接通过<code>elem.offsetTop</code>就可以得到，如果包含多层嵌套，那么<code>offsetTop</code>就需要每一层元素相对于父元素的<code>offsetTop</code>相加，直到父元素等于目标父元素。简单的实现如下：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 该函数没有考虑节点异常的情况</span></span><br><span class="line"><span class="keyword">let</span> getNodeOffsetTop = <span class="function">(<span class="params">node, parent</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> current = node;</span><br><span class="line">  <span class="keyword">let</span> offsetTop = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> (current !== parent) &#123;</span><br><span class="line">    offsetTop += current.offsetTop;</span><br><span class="line">    current = current.parentElement;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> offsetTop;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>最后是判断组件是否可见的实现：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> checkVisible = <span class="function">(<span class="params">node, parent</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (!node || !parent) &#123;</span><br><span class="line">    <span class="keyword">this</span>.setState(&#123; <span class="attr">visible</span>: <span class="literal">true</span> &#125;);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; visible &#125; = <span class="keyword">this</span>.state;</span><br><span class="line">    <span class="keyword">if</span> (visible) &#123;</span><br><span class="line">      <span class="keyword">this</span>.parent.removeEventListener(<span class="string">'scroll'</span>, <span class="keyword">this</span>.scrollHandler);</span><br><span class="line">      <span class="keyword">return</span>; <span class="comment">// 直接返回不执行当次eventListener</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> seenHeight = parent.clientHeight;</span><br><span class="line">    <span class="keyword">let</span> scrollHeight = parent.scrollTop;</span><br><span class="line">    <span class="keyword">let</span> currentNode = findDOMNode(<span class="keyword">this</span>); <span class="comment">// 获取最新的dom结构</span></span><br><span class="line">    <span class="keyword">let</span> offsetTop = <span class="keyword">this</span>.getNodeOffsetTop(currentNode, parent);</span><br><span class="line">    <span class="comment">// 1. 当偏移高度小于可见高度</span></span><br><span class="line">    <span class="comment">// 2. 初始不可见的时候，当可视高度+滚动高度大于了偏移高度</span></span><br><span class="line">    <span class="keyword">if</span> (offsetTop &lt;= seenHeight + scrollHeight) &#123;</span><br><span class="line">      <span class="keyword">this</span>.setState(&#123; <span class="attr">visible</span>: <span class="literal">true</span> &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h5 id="问题3：如何使用“更好”组件占位符"><a href="#问题3：如何使用“更好”组件占位符" class="headerlink" title="问题3：如何使用“更好”组件占位符"></a>问题3：如何使用“更好”组件占位符</h5><p>理想情况下，一个好的占位组件应该是和真实组件一样大的<code>size</code>，这样的话初始情况和加载完成的情况下滚动条的长度都是一样长的，且在组件由不可见到可见这个过程中页面并不会因为组件前后的<code>size</code>而出现抖动。</p>
<p>而实际的情况是，我们并不能很好的拿到目标组件的样式并作用到占位组件上，因为占位组件总是先渲染。所以折中的做法是让<code>ScrollLoad</code>的使用者去提供占位组件，这样就把如何提供一个好的占位组件交给了使用者。</p>
<p>还有一种办法是，既然一个好的(只是我认为的)占位组件的<code>size</code>是等于目标组件的，那么我直接把用于布局的样式从目标组件上拿过来不就行了！所以无论是目标组件渲染后的真实DOM上的<code>className id style...</code>全部拿过来，如果高度是内容撑开的话，我们就拿渲染完成的高度直接设置到占位组件上。经过尝试，这种方法的确可行，但是需要付出的代价是需要花费时间在获取目标组件的样式和样式整理上，并且代码的可读性将一定程度的降低。</p>
<p>所以，关于占位组件，我暂时没有好的方法。</p>
<h5 id="问题4：性能瓶颈"><a href="#问题4：性能瓶颈" class="headerlink" title="问题4：性能瓶颈"></a>问题4：性能瓶颈</h5><p>在前面介绍<code>react-lazy-load</code>的时候提到过我们可以决定是否使用节流或防抖来解决性能问题。所以，在<code>ScrollLoad</code>上，也是用了<em>节流</em>来控制<code>scroll</code>触发的频率。代码如下：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.scrollHandler = throttle(<span class="keyword">this</span>.checkVisible(dom, parent), <span class="number">100</span>);</span><br><span class="line">parent.addEventListener(<span class="string">'scroll'</span>, <span class="keyword">this</span>.scrollHandler, &#123; <span class="attr">passive</span>: <span class="literal">true</span> &#125;);</span><br></pre></td></tr></table></figure></p>
<p>这里使用了<code>lodash/throttle</code>来实现节流，这样默认情况下，<code>scroll</code>事件只会每隔<code>100ms</code>触发一次。</p>
<p>上面的代码在使用<code>addEventListener</code>绑定监听函数时还是用到了该函数的第三个参数：<code>{ passive: true }</code>，<code>passive</code>的意思是<code>消极的、被动的</code>，如果不指定，在新版的<code>Chrome</code>中会有性能提示：<code>[Violation] Added non-passive event listener to a scroll-blocking &lt;some&gt; event. Consider marking event handler as &#39;passive&#39; to make the page more responsive.</code></p>
<p>其实在监听滚动事件是，我们可以通过<code>event.preventDefault()</code>来阻止浏览器的默认滚动行为，可当滚动触发时，浏览器并不知道我们的监听函数中是否阻止了默认行为，所以浏览器会等待，直到监听函数执行完，此时浏览器才会选择滚动与否。而执行监听函数往往需要时间，性能就会受到影响。</p>
<p>而设置<code>{ passive: true }</code>，可以在执行监听函数之前就告诉浏览器，并没有阻止默认滚动，因此在滚动触发时，浏览器就不会等待，直接滚动。显然<code>ScrollLoad</code>是需要执行浏览器滚动的，因此设置<code>{ passive: true }</code>可以提升性能。</p>
<p>在<code>checkVisible</code>函数中，有一段代码：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; visible &#125; = <span class="keyword">this</span>.state;</span><br><span class="line"><span class="keyword">if</span> (visible) &#123;</span><br><span class="line">  <span class="keyword">this</span>.parent.removeEventListener(<span class="string">'scroll'</span>, <span class="keyword">this</span>.scrollHandler);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这段代码很好理解，除了在组件卸载之前需要移除<code>listener</code>之外，一旦当某个组件可见，那么此时就没必要再监听滚动了，所以需要移除监听函数。</p>
<p>上面的代码还有一个问题，如果当某两次触发监听函数组件的状态刚好从<code>visible</code>为<code>false</code>切换到<code>true</code>，此时移除了监听函数，但当次函数还会再次执行，所以在移除监听函数后，直接返回，可以避免执行下面不必要的逻辑。因此，这段代码应该是：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; visible &#125; = <span class="keyword">this</span>.state;</span><br><span class="line"><span class="keyword">if</span> (visible) &#123;</span><br><span class="line">  <span class="keyword">this</span>.parent.removeEventListener(<span class="string">'scroll'</span>, <span class="keyword">this</span>.scrollHandler);</span><br><span class="line">  <span class="keyword">return</span>; <span class="comment">// 直接返回不执行当次eventListener</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="结尾"><a href="#结尾" class="headerlink" title="结尾"></a>结尾</h3><p>到此为止，一个基本可用的<code>ScrollLoad</code>组件就实现了，其实对于不同的使用场景，<code>ScrollLoad</code>的实现也可以略有不同，例如如果当前需要<code>scrollload</code>的组件是一些列表项组件，每个组件的样式外观都是一致的。这样的话，我们在写<code>lazyload</code>组件的时候，就可以把所有组件使用一个<code>LazyLoad</code>组件包裹起来，然后绑定一个监听函数，使用可显示的组件个数作为组件状态，每次滚动时监听函数根据已经滚动的高度去计算可见组件的个数，最后在渲染的时候遍历<code>this.props.children</code>，选择渲染组件或是占位组件即可。</p>
<p>附 <code>LazyLoad</code>实现代码：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; findDOMNode &#125; <span class="keyword">from</span> <span class="string">'react-dom'</span>;</span><br><span class="line"><span class="keyword">import</span> throttle <span class="keyword">from</span> <span class="string">'lodash/throttle'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Spin &#125; <span class="keyword">from</span> <span class="string">'@xx/xx-ui'</span>;</span><br><span class="line"><span class="keyword">import</span> ReactPlaceHolder <span class="keyword">from</span> <span class="string">'react-placeholder'</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getScrollParent</span>(<span class="params">element</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> style = <span class="function">(<span class="params">elem, prop</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (getComputedStyle !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> getComputedStyle(elem, <span class="literal">null</span>).getPropertyValue(prop);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> elem.style[prop];</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">const</span> overflow = <span class="function"><span class="params">node</span> =&gt;</span> style(node, <span class="string">'overflow'</span>) + style(node, <span class="string">'overflow-x'</span>) + style(node, <span class="string">'overflow-y'</span>);</span><br><span class="line">  <span class="comment">// 循环判断父节点是否可滚动这里暂不添加，直接去直接父元素</span></span><br><span class="line">  <span class="keyword">if</span> (!(element <span class="keyword">instanceof</span> HTMLElement)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">window</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> parent = element;</span><br><span class="line">  <span class="keyword">while</span> (parent) &#123;</span><br><span class="line">    <span class="comment">// 当前节点是body或者document</span></span><br><span class="line">    <span class="keyword">if</span> (parent === <span class="built_in">document</span>.body || parent === <span class="built_in">document</span>.documentElement) &#123;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 当期元素无父节点</span></span><br><span class="line">    <span class="keyword">if</span> (!parent.parentNode) &#123;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 判断节点是否含有overflow等属性的值</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="regexp">/(scroll|auto|inherit)/</span>.test(overflow(parent))) &#123;</span><br><span class="line">      <span class="keyword">return</span> parent;</span><br><span class="line">    &#125;</span><br><span class="line">    parent = parent.parentNode;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">window</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> EmptyCompBox = <span class="function">(<span class="params">&#123; ...props &#125;</span>) =&gt;</span> (</span><br><span class="line">  &lt;div &#123;...props&#125;&gt;</span><br><span class="line">    &lt;Spin size=<span class="string">"large"</span> className=<span class="string">"lazyload-center-spin"</span> /&gt;</span><br><span class="line">  &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">);</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">class ScrollLoad extends React.Component &#123;</span></span><br><span class="line"><span class="regexp">  state = &#123;</span></span><br><span class="line"><span class="regexp">    visible: false,</span></span><br><span class="line"><span class="regexp">  &#125;;</span></span><br><span class="line"><span class="regexp">  componentDidMount() &#123;</span></span><br><span class="line"><span class="regexp">    let dom = findDOMNode(this); /</span><span class="regexp">/ 取得当前节点</span></span><br><span class="line"><span class="regexp">    let parent = getScrollParent(dom);</span></span><br><span class="line"><span class="regexp">    this.parent = parent;</span></span><br><span class="line"><span class="regexp">    let visible = this.checkVisible(dom, parent); /</span><span class="regexp">/ 初始化检查是否可见</span></span><br><span class="line"><span class="regexp">    visible();</span></span><br><span class="line"><span class="regexp">    this.scrollHandler = throttle(this.checkVisible(dom, parent), 100);</span></span><br><span class="line"><span class="regexp">    parent.addEventListener('scroll', this.scrollHandler, &#123; passive: true &#125;);</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">  componentWillUnmount() &#123;</span></span><br><span class="line"><span class="regexp">    this.parent.removeEventListener('scroll', this.scrollHandler);</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">  getNodeOffsetTop = (node, parent) =&gt; &#123;</span></span><br><span class="line"><span class="regexp">    let current = node;</span></span><br><span class="line"><span class="regexp">    let offsetTop = 0;</span></span><br><span class="line"><span class="regexp">    while (current !== parent) &#123;</span></span><br><span class="line"><span class="regexp">      offsetTop += current.offsetTop;</span></span><br><span class="line"><span class="regexp">      current = current.parentElement;</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">    return offsetTop;</span></span><br><span class="line"><span class="regexp">  &#125;;</span></span><br><span class="line"><span class="regexp">  checkVisible = (node, parent) =&gt; &#123;</span></span><br><span class="line"><span class="regexp">    if (!node || !parent) &#123;</span></span><br><span class="line"><span class="regexp">      this.setState(&#123; visible: true &#125;);</span></span><br><span class="line"><span class="regexp">      return null;</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">    let seenHeight = parent.clientHeight;</span></span><br><span class="line"><span class="regexp">    let scrollHeight = parent.scrollTop;</span></span><br><span class="line"><span class="regexp">    return () =&gt; &#123;</span></span><br><span class="line"><span class="regexp">      const &#123; visible &#125; = this.state;</span></span><br><span class="line"><span class="regexp">      if (visible) &#123;</span></span><br><span class="line"><span class="regexp">        this.parent.removeEventListener('scroll', this.scrollHandler);</span></span><br><span class="line"><span class="regexp">        return; /</span><span class="regexp">/ 直接返回不执行当次eventListener</span></span><br><span class="line"><span class="regexp">      &#125;</span></span><br><span class="line"><span class="regexp">      let currentNode = findDOMNode(this); /</span><span class="regexp">/ 获取最新的dom结构</span></span><br><span class="line"><span class="regexp">      let offsetTop = this.getNodeOffsetTop(currentNode, parent);</span></span><br><span class="line"><span class="regexp">      /</span><span class="regexp">/ 1. 当偏移高度小于可见高度</span></span><br><span class="line"><span class="regexp">      /</span><span class="regexp">/ 2. 初始不可见的时候，当可视高度+滚动高度大于了偏移高度</span></span><br><span class="line"><span class="regexp">      if (offsetTop &lt;= seenHeight + scrollHeight) &#123;</span></span><br><span class="line"><span class="regexp">        this.setState(&#123; visible: true &#125;);</span></span><br><span class="line"><span class="regexp">      &#125;</span></span><br><span class="line"><span class="regexp">    &#125;;</span></span><br><span class="line"><span class="regexp">  &#125;;</span></span><br><span class="line"><span class="regexp">  render() &#123;</span></span><br><span class="line"><span class="regexp">    const &#123; visible &#125; = this.state;</span></span><br><span class="line"><span class="regexp">    const &#123; id, className, style &#125; = this.props;</span></span><br><span class="line"><span class="regexp">    return (</span></span><br><span class="line"><span class="regexp">      &lt;ReactPlaceHolder</span></span><br><span class="line"><span class="regexp">        ready=&#123;visible&#125;</span></span><br><span class="line"><span class="regexp">        customPlaceholder=&#123;&lt;EmptyCompBox id=&#123;id&#125; className=&#123;className&#125; style=&#123;style&#125; /</span>&gt;&#125;</span><br><span class="line">      &gt;</span><br><span class="line">        &#123;<span class="keyword">this</span>.props.children&#125;</span><br><span class="line">      &lt;<span class="regexp">/ReactPlaceHolder&gt;</span></span><br><span class="line"><span class="regexp">    );</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">export default ScrollLoad;</span></span><br></pre></td></tr></table></figure></p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://yoursite.com/2019/06/27/scrollload/" data-id="cjz18hg53000wl8j6kfwjxrgt" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://yoursite.com/2019/06/27/scrollload/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://yoursite.com/2019/06/27/scrollload/">评论</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-eject" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2019/06/05/eject/">关于eject需要知道的</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2019/06/05/eject/">
            <time datetime="2019-06-05T00:37:22.000Z" itemprop="datePublished">2019-06-05</time>
        </a>
    </div>


                        
                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/Webpack/">Webpack</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <p>整理：使用<code>create-react-app</code>构建的项目在<code>yarn run eject</code>后的一些问题。</p>
<h3 id="eject之前"><a href="#eject之前" class="headerlink" title="eject之前"></a>eject之前</h3><p><code>create-react-app</code>脚手架把关于<code>webpack</code>配置和其它脚本封装到了一个叫做<code>react-scripts</code>的<code>package</code>里。默认情况下所有的配置是不可见的，但是可以通过<code>react-app-rewired</code>在不<code>eject</code>的条件下修改某些<code>webpack</code>配置。这样的方式在绝大多数情况下是可行的，但是如果我们想更精确的控制，比如修改默认的css打包方式、使用<code>less</code>、组件库按需加载等，即使也能够做，但或多或少会用到<code>hack</code>的方式。</p>
<p>在运行<code>yarn run eject</code>后，所有关于<code>webpack</code>配置将会暴露出来，在根目录会生成<strong>config</strong>和<strong>scripts</strong>两个目录，并且<code>react-script</code>将不复存在，所有<code>react-script</code>的依赖都将注入到项目中。</p>
<p><code>eject</code>是单项操作，一旦完成，就没办法还原，这就意味着复杂的<code>webpack</code>管理将交由我们自己管理。</p>
<h3 id="eject进行时"><a href="#eject进行时" class="headerlink" title="eject进行时"></a>eject进行时</h3><ol>
<li><p>步骤1 运行<code>yarn run eject</code>，稍等片刻，观察到生成新增了<strong>config</strong>和<strong>scripts</strong>两个目录，并且<code>package.json</code>文件被修改。</p>
</li>
<li><p>打开<code>package.json</code>文件，由于我们已经不使用<code>react-scripts</code>了，所以这里需要修改<code>start build test</code>等命令。使用<code>scripts</code>目录中对应的脚本即可，例如：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"scripts"</span>: &#123;</span><br><span class="line">  <span class="string">"start"</span>: <span class="string">"node scripts/start.js"</span>,</span><br><span class="line">  <span class="string">"build"</span>: <span class="string">"node scripts/build.js"</span>,</span><br><span class="line">  <span class="string">"test"</span>: <span class="string">"node scriprs/test.js"</span></span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>运行<code>yarn start</code>，不出意外的话，项目正常运行，如果提示<em>can’t find module xxx</em>，删除<code>node_modules</code>和<code>yarn.lock</code>(如果有的话)，重新运行<code>yarn install</code>安装依赖即可。</p>
</li>
</ol>
<h3 id="eject后出现了问题"><a href="#eject后出现了问题" class="headerlink" title="eject后出现了问题"></a>eject后出现了问题</h3><p>如果是<code>eject</code>后运行项目报错，重新安装依赖后仍然报错，那么就要考虑是依赖版本的问题了。就比如笔者的这个项目，使用老版本的<code>react-react-app</code>生成，并且在中期升级了<code>react-scripts</code>和<code>react</code>等，且使用了特定版本的<code>eslint</code>规则。在根据报错提示进行修复后，运行项目仍然报错且无任何报错提示。</p>
<p>我们需要弄清楚到底是什么依赖有问题，这个过程是复杂且繁琐的，并且可能由于依赖前后版本已经发生了巨大的变化，即使找到存在问题的依赖也可能不能仅通过升级该依赖的版本解决问题。</p>
<p>所以一个备选方案是把项目整体迁移到新版本的<code>create-react-app</code>上，这里有两个做法：使用<code>create-react-app</code>新生成一个项目，我们把源码和依赖都迁移到新项目中，在新的项目中进行<code>eject</code>；使用<code>create-react-app</code>生成一个空的项目并<code>eject</code>，使用新的<em>config</em>和<em>scripts</em>替换当前项目的脚本和配置，并且比较<code>packahe.json</code>，更新依赖的版本，重新安装依赖，大功告成。</p>
<p>在实际的情况下，受制于项目版本控制、团队协作、迁移成本等，第一种方式，基本不可用。</p>
<p>解决完问题，接下来我们需要将写在<code>config-overrides.js</code>中的自定义配置进行迁移。</p>
<h3 id="自定义配置"><a href="#自定义配置" class="headerlink" title="自定义配置"></a>自定义配置</h3><blockquote>
<p>在进行自定义配置之前，如果项目因<code>eslint</code>规则，无法运行成功，可以尝试在<code>config/webpack.config.js</code>中找到<code>eslint-loader</code>并且注释掉这个配置，此时在开发模式下，<code>eslint</code>并不会对源码进行规则校验。</p>
</blockquote>
<h4 id="less支持"><a href="#less支持" class="headerlink" title="less支持"></a>less支持</h4><p>因为<code>create-react-app</code>脚手架并不支持<code>less</code>，我们需要手动添加对<code>less</code>的支持。首先安装<code>less-loader</code>，并在<code>webpack.config.js</code>中的<code>module.rules</code>下添加：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> lessRegex = <span class="regexp">/\.less$/</span>;</span><br><span class="line"><span class="built_in">module</span>: &#123;</span><br><span class="line">  rules: [</span><br><span class="line">    ...</span><br><span class="line">    &#123;</span><br><span class="line">      test: lessRegex,</span><br><span class="line">      use: getStyleLoaders(</span><br><span class="line">        &#123;</span><br><span class="line">          importLoaders: <span class="number">2</span>,</span><br><span class="line">          sourceMap: isEnvProduction &amp;&amp; shouldUseSourceMap,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">'less-loader'</span></span><br><span class="line">      ),</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>注意到这里使用到了一个封装好的函数<code>getStyleLoaders</code>，其针对不同的css预处理器，生成适用的<code>loader</code>，源码非常简单：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> getStyleLoaders = <span class="function">(<span class="params">cssOptions, preProcessor</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> loaders = [</span><br><span class="line">      isEnvDevelopment &amp;&amp; <span class="built_in">require</span>.resolve(<span class="string">'style-loader'</span>),</span><br><span class="line">      isEnvProduction &amp;&amp; &#123;</span><br><span class="line">        loader: MiniCssExtractPlugin.loader,</span><br><span class="line">        options: shouldUseRelativeAssetPaths ? &#123; <span class="attr">publicPath</span>: <span class="string">'../../'</span> &#125; : &#123;&#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        loader: <span class="built_in">require</span>.resolve(<span class="string">'css-loader'</span>),</span><br><span class="line">        options: cssOptions,</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        loader: <span class="built_in">require</span>.resolve(<span class="string">'postcss-loader'</span>),</span><br><span class="line">        options: &#123;</span><br><span class="line">          ident: <span class="string">'postcss'</span>,</span><br><span class="line">          plugins: <span class="function"><span class="params">()</span> =&gt;</span> [</span><br><span class="line">            <span class="built_in">require</span>(<span class="string">'postcss-flexbugs-fixes'</span>),</span><br><span class="line">            <span class="built_in">require</span>(<span class="string">'postcss-preset-env'</span>)(&#123;</span><br><span class="line">              autoprefixer: &#123;</span><br><span class="line">                flexbox: <span class="string">'no-2009'</span>,</span><br><span class="line">              &#125;,</span><br><span class="line">              stage: <span class="number">3</span>,</span><br><span class="line">            &#125;),</span><br><span class="line">            postcssNormalize(),</span><br><span class="line">          ],</span><br><span class="line">          sourceMap: isEnvProduction &amp;&amp; shouldUseSourceMap,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">    ].filter(<span class="built_in">Boolean</span>);</span><br><span class="line">    <span class="keyword">if</span> (preProcessor) &#123;</span><br><span class="line">      loaders.push(&#123;</span><br><span class="line">        loader: <span class="built_in">require</span>.resolve(preProcessor),</span><br><span class="line">        options: &#123;</span><br><span class="line">          sourceMap: isEnvProduction &amp;&amp; shouldUseSourceMap,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> loaders;</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure></p>
<p>我们知道如果使用了<code>css</code>预处理器，在设置<code>loader</code>的时候，可能需要多个<code>loaders</code>，例如:</p>
<ul>
<li><code>less-loader</code>: 把<code>less</code>编译成<code>css</code></li>
<li><code>css-loader</code>: 解决<code>css</code>使用<code>import</code>、<code>require</code>引入的问题</li>
<li><code>style-loader</code>: 通过style标签把<code>css</code>注入到<code>DOM</code>中。</li>
<li>生产环境下可能还需要生成单独的css文件，css压缩等。</li>
</ul>
<p>而<code>getStyleLoaders</code>就是生成这些<code>loaders</code>的一个公共方法。</p>
<h4 id="组件库按需加载"><a href="#组件库按需加载" class="headerlink" title="组件库按需加载"></a>组件库按需加载</h4><p>在开发过程中，如果使用到了组件库且该组件库支持按需加载(例如<em>antd</em>)，那么我们可以根据相关的教程配置即可。</p>
<p>比如在当前项目中使用到了<code>xx-ui</code>这个组件库，该组件库支持<code>babel-plugin-import</code>按需加载，在安装好依赖后，我们只需要在<code>package.json</code>的<code>babel</code>下配置<code>plugin</code>：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"babel"</span>: &#123;</span><br><span class="line">  <span class="string">"presets"</span>: [</span><br><span class="line">    <span class="string">"react-app"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"plugins"</span>: [</span><br><span class="line">    [</span><br><span class="line">      <span class="string">"import"</span>,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">"libraryName"</span>: <span class="string">"@wind/xx-ui"</span>,</span><br><span class="line">        <span class="string">"libraryDirectory"</span>: <span class="string">"es"</span>,</span><br><span class="line">        <span class="string">"style"</span>: <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这和传统的<code>.babelrc</code>中进行<code>plugin</code>配置无区别，但总算不用再维护额外的一个文件了。</p>
<h4 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h4><p>比如我们在构建时需要对代码进行拆分，我们可以在<code>webpack.config.js</code>的<code>optimization</code>中使用<code>splitChunks</code>进行自定义、分离<code>runtimeChunk等</code>。</p>
<p>比如我们构建时不想使用默认的<code>static/js/[name].[contenthash:8].chunk.js</code>作为<code>chunks</code>的文件名，直接修改即可。注意，在代码分割时，相应的<code>css</code>也会被分割，如果想修改<code>css</code>的配置可以直接找到<code>MiniCssExtractPlugin</code>进行修改即可。</p>
<h3 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h3><p>经过上面所有的步骤，项目已经能够完全正常运行，和<code>eject</code>之前一样。接下来我们可以详细阅读<code>webpack.config.js</code>，进行更进一步的定制，也可以删除某些项目中不需要的配置，减轻<code>webpack.config.js</code>的复杂性。</p>
<p>如果项目是老项目的话，为了项目能够在<code>eject</code>后不会因为<code>eslint</code>报错而无法正常运行，可以注释掉<code>eslint-loader</code>来避免每次构建时候的预检，但此时对代码风格的约束只限于编辑器本身<code>eslint</code>的支持，对代码质量和团队代码风格可能造成一定的影响。</p>
<p>更好的方式是使用一个适合这个项目的<code>eslint</code>规则，如<code>eslint-config-airbnb-base</code>，并且对这个第三方规则进行定制，直至这个规则适合这个项目。</p>
<p>完。</p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://yoursite.com/2019/06/05/eject/" data-id="cjz18hg4y000nl8j6zyljxbp3" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://yoursite.com/2019/06/05/eject/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://yoursite.com/2019/06/05/eject/">评论</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-老项目Webpack构建优化" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2019/06/01/老项目Webpack构建优化/">老项目Webpack构建优化</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2019/06/01/老项目Webpack构建优化/">
            <time datetime="2019-06-01T14:34:56.000Z" itemprop="datePublished">2019-06-01</time>
        </a>
    </div>


                        
                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/Webpack/">Webpack</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <p>最近在接手一个项目的时候，由于其开发已经一年有余，整个项目使用了<code>create-react-app</code>脚手架，<em>Webpack</em>版本停留在3.x，<em>React</em>版本15.x，并且在线上使用效果并不好，首页加载缓慢。对于这样一个典型的<strong>老项目</strong>，进行构建优化。</p>
<blockquote>
<p>在<code>webpack 3.x</code>之前的构建中，该项目使用<code>CommonChunkPlugin</code>对特定的<code>package</code>进行了抽取，例如<code>react</code>、图表库、组件库，其余使用到的<code>package</code>和业务代码被打包在了一起，<em>Gzip</em>过后差不多<code>1MB</code>。通过分析可以得知，分离出的第三方库和业务代码存在重复打包的情况，并且页面初始加载并不需要用到图标库，而组件库只使用到了部分组件却被完全打包了。</p>
</blockquote>
<h3 id="升级Webpack"><a href="#升级Webpack" class="headerlink" title="升级Webpack"></a>升级Webpack</h3><p>由于使用的是<code>create-react-app</code>脚手架，其自带了<code>react-scripts</code>作为<code>webpack</code>的配置，本项目使用的是老版本脚手架生成，<em>Webpack</em>版本是<code>3.x</code>。分析后，在不更新脚手架的前提下，直接升级<em>Webpack</em>，可以使用<code>splitChunk</code>进行代码分隔，配合新版本的<em>React</em>的<code>lazy &amp; Suspense</code>，可不引入三方库的情况下实现按需加载。</p>
<p>升级<em>Webpack</em>比较容易，直接升级最新版的<code>react-scripts</code>即可（注意不是<code>react-script</code>）。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add --exact react-scripts@2.1.1</span><br></pre></td></tr></table></figure></p>
<p>安装完后<code>yarn start</code>运行项目，不出意外会有报错提示，因为某些<code>react-scripts</code>依赖的库版本过低，此时只要删除<code>yarn.lock</code>和<code>package-lock.json</code>和<code>node_modules</code>，并且运行<code>yarn install</code>重新安装依赖即可。</p>
<p>安装完成后，不出意外项目可以正常运行了，此时<em>Webpack</em>已升级。</p>
<h3 id="代码分隔"><a href="#代码分隔" class="headerlink" title="代码分隔"></a>代码分隔</h3><ol>
<li><p>考虑到初次构建的时候仅仅分离部分第三方库导致第三方包和业务代码之间存在代码冗余，在新构建的版本中，需要对公用代码进行抽取，这样可以直接避免冗余。具体的<code>splitChunk</code>配置这里不再列出，抽取完成后例如<code>lodash</code>、<code>moment</code>这样的公共库被抽取到了公共包中，构建完成后生成了三个包：业务代码及未抽取的第三方包、特定的第三方包、公共代码包，构建体积明显减少。</p>
</li>
<li><p>由于业务的特殊性，首页并不包含任何图表，因此不需要加载图表库，并且图表库打包完成后大小为<code>700KB</code>（未Gzip），因此考虑使用基于路由的按需加载来去除首页不需要加载的资源。</p>
</li>
<li><p>进行代码分隔依赖于运行时加载，也就是<code>import()</code>，这是一个<code>ES</code>提案，目前还未标准化(<em>babel</em>已实现)。不同于<code>import</code>语法在预编译时链接代码，<code>import()</code>可以在运行时异步加载资源。而<em>Webpack</em>在解析到这种语法的时候，就会自动的进行代码分隔。</p>
</li>
<li><p>目前<em>React</em>懒加载的方案有很多，比如<code>react-loadable</code>，但由于新版的<em>React</em>已经支持了代码分隔，就没必要引入额外的库。<code>React.lazy</code>函数能够让你像处理常规组件一样处理懒加载组件。该函数接收一个函数作为参数，这个函数必须使用到<code>import()</code>动态加载组件，<code>import()</code>返回一个<code>Promise</code>，在<code>resolve</code>后返回这个React组件。<code>Suspense</code>是一个组件，其主要的作用是在懒加载块没有加载完成时使用占位组件进行UI 的优雅降级。</p>
</li>
<li><p>经过分析，基于路由的分隔可能最适合本项目。涉及到图表库的三个页面使用懒加载进行代码分隔，其余页面打包在一起，并且完全分离第三方库和业务代码。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; lazy, Suspense &#125; <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; render &#125; <span class="keyword">from</span> <span class="string">'react-dom'</span>;</span><br><span class="line"><span class="keyword">import</span> Loading <span class="keyword">from</span> <span class="string">'@/components/loading'</span></span><br><span class="line"><span class="keyword">const</span> ChartPage = lazy(<span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">import</span>(<span class="comment">/* webpackChunkName: "detail" */</span><span class="string">'@/views/chartPage'</span>));</span><br><span class="line"><span class="keyword">const</span> App = <span class="function"><span class="params">()</span> =&gt;</span> (</span><br><span class="line">  &lt;Router&gt;</span><br><span class="line">    &lt;Suspense fallback=&#123;Loading&#125;&gt;</span><br><span class="line">      &lt;Switch&gt;</span><br><span class="line">        &lt;Route path=<span class="string">'/detail'</span> component=&#123;ChartPage&#125; /&gt;</span><br><span class="line">        ...</span><br><span class="line">      &lt;<span class="regexp">/Switch&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>Suspense&gt;</span><br><span class="line">  &lt;<span class="regexp">/Router&gt;</span></span><br><span class="line"><span class="regexp">);</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>直接运行<code>yarn start</code>，观察打包结果，发现已经按照路由进行了分隔，在总打包大小基本不变的情况下，初始加载的包只有<code>230KB</code>，减少了一大半。</p>
<ol start="6">
<li>观察打包结果，发现公共包的命名是<code>0.hash.chunk.js</code>，对于已经在注释中指定了<code>webpackChunkName</code>，这显然是不正常的，可能是<code>react-scripts</code>默认分隔策略的问题。为了修复这个命名问题并且进一步分隔<code>runtime chunk</code>，对<code>splitChunk</code>进行少量的配置。<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> SplitCodeConfig = &#123;</span><br><span class="line">  optimization: &#123;</span><br><span class="line">    splitChunks: &#123;</span><br><span class="line">      chunks: <span class="string">'all'</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    runtimeChunk: &#123;</span><br><span class="line">      name: <span class="string">'runtime'</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>只需要进行简单的配置，设置<code>splitChunks</code>的<code>chunks</code>为<code>all</code>, <em>Webpack</em>就会使用默认的规则进行打包：抽取公共包，抽取<code>node_modules</code>第三方包等等，具体见<em>Webpack</em>官网 -&gt; <em>文档</em> -&gt; <em>代码分离</em>。</p>
<p>至此，项目构建已经完成，构建的包可以直接用于生产换环境。</p>
<h3 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h3><ol>
<li><p>在项目中使用到的组件库包含近百个通用组件和业务组件，但是项目中只使用到了十余个，并且通过观察打包结果，可以看到未被使用到的组件也被打包进来了，这显然不合理。针对这个问题，我们可以查看对应组件库的按需加载方案，并且在<em>Webpack</em>进行相应的配置即可。这里由于使用的是内部开发的组件库，就不在举例。</p>
</li>
<li><p>除了使用的组件库，我们需要找到所有能够按需加载却在项目中没有使用的第三方库。例如我要使用<code>lodash</code>的<code>debounce</code>函数进行防抖，我在项目中是这样使用的：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> _ <span class="keyword">from</span> <span class="string">'lodash'</span>;</span><br><span class="line"><span class="built_in">window</span>.onscroll = _.debounce(handler);</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>在构建的时候，整个<code>lodash</code>会被打包，如果只需要打包<code>debounce</code>函数，在<code>import</code>的时候直接<code>import debounce from &#39;lodash/debounce&#39;</code>即可。</p>
<h3 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h3><ol>
<li><p>为了直观的查看构建结果，推荐使用<code>webpack-bundle-analyzer</code>插件，它会在构建完成后打开一个页面，该页面可以看到每个<code>bundle</code>的打包情况。使用也很简单:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> BundleAnalyzerPlugin = <span class="built_in">require</span>(<span class="string">'webpack-bundle-analyzer'</span>).BundleAnalyzerPlugin;</span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">  plugins: [</span><br><span class="line">    <span class="keyword">new</span> BundleAnalyzerPlugin(),</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果想测试<code>Gzip</code>后的文件大小，在<code>webpack-dev-server</code>的配置项中添加<code>compress: true</code>即可。但如果查看生产环境下构建的<code>Gzip</code>包大小，可以使用<code>compression-webpack-plugin</code>插件，该插件会在构建完成后生成对应<code>bundle</code>的<code>Gzip</code>包。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> CompressionPlugin = <span class="built_in">require</span>(<span class="string">'compression-webpack-plugin'</span>);</span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">  plugins: [</span><br><span class="line">    <span class="keyword">new</span> CompressionPlugin(&#123; <span class="attr">threshold</span>: <span class="number">8192</span> &#125;), <span class="comment">// 只有大于8KB的资源才压缩</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>在一般的情况下开启<code>Gzip</code>只需要设置生产服务器即可，并不需要在构建时生成<code>Gzip</code>包，但如果每次请求时再<code>Gzip</code>无疑会加大服务器的负担，因此事先准备好<code>gzip</code>包，服务器不必压缩而是直接返回，这不失为一个好的选择。</p>
<p>开启<code>Gzip</code>会极大的减小传输体积，但无论是压缩还是解压都需要大量的运算，对于某些较小的资源，使用<code>Gzip</code>可能反而会降低性能，因此建议只对较大的资源进行<code>Gzip</code>压缩，而较小的资源直接传输。</p>
<p>完。</p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://yoursite.com/2019/06/01/老项目Webpack构建优化/" data-id="cjz18hg6k003jl8j6aanlkrpw" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://yoursite.com/2019/06/01/老项目Webpack构建优化/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://yoursite.com/2019/06/01/老项目Webpack构建优化/">评论</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-webpack-in-thinking" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2019/02/25/webpack-in-thinking/">Webpack 4.x 简易使用指南</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2019/02/25/webpack-in-thinking/">
            <time datetime="2019-02-25T12:54:33.000Z" itemprop="datePublished">2019-02-25</time>
        </a>
    </div>


                        
                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/webpack/">webpack</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <blockquote>
<p>本篇来自于之前在团队内部分享<code>webpack</code>时的笔记，内容比较浅显，主要讲<code>webpack</code>基本配置，同时<code>webpack</code>运行原理，自定义<code>loader</code>和<code>plugin</code>也有涉及。</p>
</blockquote>
<h3 id="Webpack4-x使用指南"><a href="#Webpack4-x使用指南" class="headerlink" title="Webpack4.x使用指南"></a>Webpack4.x使用指南</h3><h4 id="零配置使用Webpack"><a href="#零配置使用Webpack" class="headerlink" title="零配置使用Webpack"></a>零配置使用Webpack</h4><blockquote>
<p>从Webpack4开始支持零配置，在不进行任何配置的形式下，直接运行<code>webpack</code>，<code>webpack</code>从<code>src/index.js</code>作为入口，最终结果输出到<code>/dist</code>。</p>
</blockquote>
<p>在默认情况下，<code>webpack</code>只会对只会从入口开始遍历所有依赖文件，由于没有配置<code>loaders</code>，因此无法处理<code>jsx</code>/<code>css</code>/图片等。</p>
<p>在默认情况下运行<code>webpack</code>，打包完成后控制台会提示在配置打包的模式。在cli中通过设置<code>--mode=production|development</code>可以指定默认，在开发模式|产品模式下，webpack会默认启用不同插件对打包进行优化。</p>
<h4 id="webpack基本配置"><a href="#webpack基本配置" class="headerlink" title="webpack基本配置"></a>webpack基本配置</h4><ol>
<li><p>入口(entry)<br>入口的配置形式有多种，例如：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">entry: <span class="string">'./src/index.js'</span>, <span class="comment">// #1</span></span><br><span class="line">entry: &#123;</span><br><span class="line">  home: <span class="string">'./home.js'</span>,</span><br><span class="line">  about: <span class="string">'./about.js'</span>,</span><br><span class="line">&#125;, <span class="comment">// #2</span></span><br><span class="line">entry: [<span class="string">'./home.js'</span>, <span class="string">'./about.js'</span>] <span class="comment">// #3</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>第一种方式配置单一入口，所有文件将会被打包到同一个文件中，例如默认将会打包到<code>main.js</code>中；第二种方式是多页面(MPA)的配置方式，配置多个入口，最终将会生成多个<code>bundle</code>，配合<code>html-webpack-plugin</code>可以将对应的<code>bundle</code>注入到对应的<code>html</code>中；第三种配置的形式指定了多个入口，但是会将最终结果打包到一个文件中。</p>
</blockquote>
</li>
<li><p>输出(output)<br>输出指定了<em>webpack</em>将结果输出到哪里，如何进行输出，甚至是使用何种方式构建等，配置比较复杂。常用配置举例：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">output: &#123;</span><br><span class="line">  filename: <span class="string">'[name].[hash].js'</span>,</span><br><span class="line">  path: path.resolve(__dirname, <span class="string">'dist'</span>),</span><br><span class="line">&#125;, <span class="comment">// #1</span></span><br><span class="line">output: &#123;</span><br><span class="line">  filename: <span class="string">'[name].[hash].js'</span>,</span><br><span class="line">  path: path.resolve(__dirname, <span class="string">'dist'</span>),</span><br><span class="line">  library: <span class="string">'xxLibrary'</span>,</span><br><span class="line">  libraryTarget: <span class="string">'amd'</span>,</span><br><span class="line">&#125;, <span class="comment">// #2</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>第一种配置方式是最基本的输出配置，它配置了输入文件的存放的目录以及文件命名，<em>filename</em>支持模板语法，<code>[name].[hash].js</code>表示使用模块名称(入口配置)以及模块标识符来命名文件。<br>第二种配置增加了’library’, ‘libraryTarget’两个属性，而<code>library</code>值的作用取决于<code>libraryTarget</code>的值。例2中配置<code>libraryTarget: &#39;amd&#39;</code>表示使用<code>amd</code>的方式打包，而<code>library</code>的值将作为模块名。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">define(<span class="string">'xxLibrary'</span>, [], <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> _entry_return_;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>而当<code>libraryTarget: &#39;commonjs2&#39;</code>时，表示该模块将使用<code>commonjs</code>的方式打包，用于<em>node</em>环境，而<code>library</code>将不起作用。此外<code>libraryTarget</code>的值还可以是<code>var(默认)</code>、<code>this</code>等。</p>
</blockquote>
</li>
<li><p>加载器(loader)<br>在webpack中<code>module</code>决定了如何处理项目中不同类型的模块，而加载器(loader)则是具体的处理逻辑。</p>
<blockquote>
<p>noParse：指定不需要进行构建的文件。例如，指定项目中不需要对<code>jquery</code>进行构建，可以进行如下配置:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">noParse: <span class="function"><span class="keyword">function</span>(<span class="params">content</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="regexp">/jquery/</span>.test(content);</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
</blockquote>
<p>规则(rules)的配置同样比较复杂，常用的配置如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">rules: [</span><br><span class="line">  &#123;</span><br><span class="line">    test: <span class="regexp">/\.(js|jsx)$/</span>,</span><br><span class="line">    exclude: <span class="regexp">/(node_modules|bower_components)/</span>,</span><br><span class="line">    include: <span class="regexp">/src/</span>,</span><br><span class="line">    use: <span class="string">'babel-loader'</span></span><br><span class="line">  &#125;, <span class="comment">// #1</span></span><br><span class="line">  &#123;</span><br><span class="line">    test: <span class="regexp">/\.(png|jpeg|gif)$/</span>,</span><br><span class="line">    oneOf: [</span><br><span class="line">      &#123;</span><br><span class="line">        resourceQuery: <span class="regexp">/inline/</span>,</span><br><span class="line">        use: <span class="string">'url-loader'</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        resourceQuery: <span class="regexp">/external/</span>,</span><br><span class="line">        use: <span class="string">'file-loader'</span>,</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;, <span class="comment">// #2</span></span><br><span class="line">  &#123;</span><br><span class="line">    test: <span class="regexp">/\.css$/</span>,</span><br><span class="line">    use: ExtractTextPlugin.extract(&#123;</span><br><span class="line">      fallback: <span class="string">'style-loader'</span>,</span><br><span class="line">      use: [</span><br><span class="line">        &#123;</span><br><span class="line">          loader: <span class="string">'css-loader'</span>,</span><br><span class="line">          options: &#123;</span><br><span class="line">            modules: <span class="literal">true</span></span><br><span class="line">          &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">      ],</span><br><span class="line">    &#125;),</span><br><span class="line">  &#125;,</span><br><span class="line">], <span class="comment">// #3</span></span><br></pre></td></tr></table></figure>
<p>上面列举了常用的配置<em>loader</em>的三种情况，第一种处理<code>js|jsx</code>文件时，使用<code>exclude</code>和<code>include</code>指定构建目录和不需要构建的目录，对于明确不需要构建的模块进行指定可以加快构建速度。第二种情况则是根据具体情况选择对应的loader进行处理。例如当我们使用<code>import emoj from &#39;./emoj.png?inline&#39;</code>时，则会使用<code>url-loader</code>对该<code>png</code>文件进行处理，对于<code>external</code>类型的图片，则使用<code>file-loader</code>处理。第三种情况则是使用多个<em>loader</em>并且可以传递<em>options</em>，例如处理css文件，这里使用了<code>style-loader</code>和<code>css-loader</code>两个加载器，并且配置了<code>css-loader</code>的options<code>modules: true</code>。这里需要关注<code>loader</code>执行顺序，<em>loader</em>执行的顺序是<strong>先配置后执行</strong>，例如这里先使用<code>css-loader</code>解析<code>css</code>，再使用<code>style-loader</code>配置将生成好的<em>css</em>文件通过<code>&lt;style&gt;</code>标签注入到DOM中。<code>options</code>配置了<code>modules: true</code>，则开启<code>css-modules</code>，写法如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> style <span class="keyword">from</span> <span class="string">'index.css'</span>;</span><br><span class="line"><span class="keyword">let</span> IButton = <span class="function">(<span class="params">&#123;children&#125;</span>) =&gt;</span> (</span><br><span class="line">  &lt;span className=&#123;style.btn&#125;&gt;&#123;children&#125;&lt;<span class="regexp">/span&gt;</span></span><br><span class="line"><span class="regexp">);</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>插件(plugin)<br>插件(plugin)用于以各种方式自定义webpack构建过程。webpack附带了非常多的插件，可以直接使用<code>webpack.pluginname</code>使用，也存在非常多的第三方插件。例如：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">plugins: [</span><br><span class="line">   <span class="keyword">new</span> CleanWebpackPlugin([<span class="string">'dist'</span>]), <span class="comment">// #1</span></span><br><span class="line">   <span class="keyword">new</span> HtmlWebpackPlugin(&#123;</span><br><span class="line">     title: <span class="string">'index'</span>,</span><br><span class="line">     chunks: [<span class="string">'index'</span>],</span><br><span class="line">   &#125;), <span class="comment">// #2</span></span><br><span class="line">   <span class="keyword">new</span> BundleAnalyzerPlugin(&#123;</span><br><span class="line">     analyzerMode: <span class="string">'server'</span>,</span><br><span class="line">     analyzerHost: <span class="string">'127.0.0.1'</span>,</span><br><span class="line">     analyzerPort: <span class="number">8889</span>,</span><br><span class="line">   &#125;), <span class="comment">// #3</span></span><br><span class="line">],</span><br></pre></td></tr></table></figure>
</li>
</ol>
<blockquote>
<p>上例使用了三个插件，第一个插件<code>CleanWebpackPlugin</code>作用是在构建输出前清空文件夹；第二个插件用于生成入口<em>html</em>，例如该<code>html</code>的<em>title</em>，指定其需要注入的<code>bundle</code>(MPA)。第三个插件则是用于分析构建结果的插件，它会在本地启动一个开发服务器，并且通过<code>canvas</code>来绘制构建可视化结果，方便进行构建分析和优化。</p>
</blockquote>
<ol start="5">
<li>开发服务器(devServer)<br><code>webpack-dev-server</code>方便我们进行快速开发应用，它会对代码进行监控，一旦发生更改，它会立即构建，并通过补丁的方式应用更改，使得应用能够快速应用更改。并且其提供了一个基于<code>Express</code>开发的简易服务器，所有资源文件都存在内存中，访问速度极快，并且通过配置可以支持热替换。介绍一下常见的<em>webpack-dev-server</em>配置。<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">devServer: &#123;</span><br><span class="line">  contentBase: path.join(__dirname, <span class="string">'dist'</span>),</span><br><span class="line">  compress: <span class="literal">true</span>,</span><br><span class="line">  inline: <span class="literal">true</span>,</span><br><span class="line">  historyApiFallback: <span class="literal">true</span>,</span><br><span class="line">  allowedHosts: [<span class="string">'host1.com'</span>, <span class="string">'host2.com'</span>],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><code>contentBase</code>主要用于指定静态文件的存放路径，例如所需要图片等，如不指定则无法找到对应文件;</p>
<p><code>compress</code>表示是否开启<code>Gzip</code>压缩;</p>
<p><code>inline</code>表示是否启用内联模式，内联模式：实时重载的脚本会被插入到<code>bundle</code>中，构建消息将会出现在控制台。此外还有<em>iframe</em>模式。</p>
<p><code>historyApiFallback</code>主要针对的是访问不存在的页面时的活动，<code>historyApiFallback: true</code>时访问不存在的页面会直接跳转到<code>index.html</code>，也可以传入一个对象更精确的进行控制跳转。</p>
<p><code>allowedHosts</code>用于指定允许该<em>devServer</em>的主机。</p>
<p><code>hot</code>是否开启<em>热替换</em>，如果为true的话，则会使用<code>webpack.HotModuleReplacementPlugin</code>插件。通过CLI的方式传递。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">webpack-dev-server --hot</span><br></pre></td></tr></table></figure></p>
<h4 id="Webpack-运行流程"><a href="#Webpack-运行流程" class="headerlink" title="Webpack 运行流程"></a>Webpack 运行流程</h4><blockquote>
<p>概括上来说：<br>初始化配置参数 -&gt; 绑定事件钩子回调 -&gt; 确定Entry开始遍历 -&gt; 使用loader编译文件 -&gt; 输出</p>
</blockquote>
<p>webpack就像一条生产线，经过一系列处理流程后才能将源文件转换成输出结果。</p>
<p>每个流程的处理职责是单一的，流程之间存在依赖关系，只有当前处理完成后才能交由下一个流程处理。</p>
<p>插件像是插入到生产线上的一个功能，在特定的时机对资源进行处理。</p>
<p>webpack 通过 <em>Tapable</em>来组织这一切。</p>
<p>Webpack在运行过程中会广播事件，插件只监听它关心的事件。</p>
<p>—《深入浅出webpack》</p>
<p><em>Tapable</em>的核心代码可以简化成。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SyncHook</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>() &#123;</span><br><span class="line">    <span class="keyword">this</span>.hooks = [];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 订阅事件</span></span><br><span class="line">  tap(name, func) &#123;</span><br><span class="line">    <span class="keyword">this</span>.hook.push(func);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 发布</span></span><br><span class="line">  call() &#123;</span><br><span class="line">    <span class="keyword">this</span>.hooks.forEach(<span class="function"><span class="params">hook</span> =&gt;</span> hook(...arguments));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Webpack具体的流程如图所示。<br><img src="flow.png" alt="流程"></p>
<ol>
<li><p>初始化构建参数(依据webpack.config.js)，插件实例化，生成<code>Compiler</code>供插件使用，挂载自定义钩子。</p>
</li>
<li><p>依据入口递归遍历文件，并且使用对应的loader进行编译。</p>
</li>
<li><p>将编译好的文件解析成AST(抽象语法树)，分析依赖逐个拉取济源。</p>
</li>
<li><p>编译完成，输出。</p>
</li>
</ol>
<h4 id="编写自定义loader"><a href="#编写自定义loader" class="headerlink" title="编写自定义loader"></a>编写自定义loader</h4><blockquote>
<p>在webpack中，真正起编译作用的就是各种各样的loader。loader其实是一个function，其传入匹配到的文件内容(String)，然后对这些内容做处理即可。</p>
</blockquote>
<p>一个最简单的loader可以使下面这样：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">content</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">"&#123;&#125;;"</span> + content;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在<em>config</em>中进行配置如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>: &#123;</span><br><span class="line">  rules: [</span><br><span class="line">    &#123;</span><br><span class="line">      test: <span class="regexp">/\.js$/</span>,</span><br><span class="line">      loader: path.resolve(__dirname, <span class="string">'./loaders/index.js'</span>),</span><br><span class="line">      options: &#123;</span><br><span class="line">        param1: <span class="number">1</span>,</span><br><span class="line">        param2: <span class="number">2</span>,</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这样在编译JS的时候就会在每个JS文件前加上<code>{};</code></p>
<hr>
<blockquote>
<p>获取自定义配置</p>
</blockquote>
<p>可以使用<code>loader-utils</code>模块来拿到自定义配置。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> loaderUtils = <span class="built_in">require</span>(<span class="string">'loader-utils'</span>);</span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">content</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> options = loaderUtils.getOptions(<span class="keyword">this</span>);</span><br><span class="line">  <span class="built_in">console</span>.log(options.param1); <span class="comment">// 1</span></span><br><span class="line">  <span class="built_in">console</span>.log(options.param2); <span class="comment">// 2</span></span><br><span class="line">  <span class="keyword">return</span> <span class="string">"&#123;&#125;;"</span> + content;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<hr>
<blockquote>
<p>数据导出</p>
</blockquote>
<p>loader可以通过return来返回处理后的结果；当然，更好的方式是使用<code>this.callback</code>的形式。因为它更加灵活，除了content以外，还可以传递其它参数。</p>
<p><code>this.callback(error, content, sourceMap, ast)</code>可以传入四个参数：</p>
<ul>
<li>error loader向外抛出一个错误</li>
<li>content 经过loader编译后的内容</li>
<li>sourceMap</li>
<li>ast 本次编译生成的AST，之后执行的loader可以直接使用，而不需要再次生成</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> loaderUtils = <span class="built_in">require</span>(<span class="string">'loader-utils'</span>);</span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">content</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> options = loaderUtils.getOptions(<span class="keyword">this</span>);</span><br><span class="line">  <span class="built_in">console</span>.log(options.param1); <span class="comment">// 1</span></span><br><span class="line">  <span class="built_in">console</span>.log(options.param2); <span class="comment">// 2</span></span><br><span class="line">  <span class="keyword">this</span>.callback(<span class="literal">null</span>, <span class="string">"&#123;&#125;;"</span> + content);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<blockquote>
<p>异步loader<br>对于异步loader，可以使用<code>this.async</code>来获取<br><code>callback</code>函数。</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> loaderUtils = <span class="built_in">require</span>(<span class="string">'loader-utils'</span>);</span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">content</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> options = loaderUtils.getOptions(<span class="keyword">this</span>);</span><br><span class="line">  <span class="keyword">let</span> callback = <span class="keyword">this</span>.async();</span><br><span class="line">  <span class="keyword">this</span>.cacheable(<span class="literal">false</span>); <span class="comment">// 是否缓存结果</span></span><br><span class="line">  <span class="built_in">console</span>.log(options.param1); <span class="comment">// 1</span></span><br><span class="line">  <span class="built_in">console</span>.log(options.param2); <span class="comment">// 2</span></span><br><span class="line">  setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    callback(<span class="literal">null</span>, <span class="string">"&#123;&#125;;"</span> + content);</span><br><span class="line">  &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<blockquote>
<p>pitch钩子<br>可以在loader文件中exports一个名为<em>pitch</em>的函数，它会先于所有的loaders执行。可以在这个过程中传参，而<strong>当前rule的所有loaders</strong>都可以拿到这个参数。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> loaderUtils = <span class="built_in">require</span>(<span class="string">'loader-utils'</span>);</span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">content</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> options = loaderUtils.getOptions(<span class="keyword">this</span>);</span><br><span class="line">  <span class="keyword">let</span> callback = <span class="keyword">this</span>.async();</span><br><span class="line">  <span class="keyword">this</span>.cacheable(<span class="literal">false</span>); <span class="comment">// 是否缓存结果</span></span><br><span class="line">  <span class="built_in">console</span>.log(options.param1); <span class="comment">// 1</span></span><br><span class="line">  <span class="built_in">console</span>.log(options.param2); <span class="comment">// 2</span></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="keyword">this</span>.data.hello); <span class="comment">// hello</span></span><br><span class="line">  setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    callback(<span class="literal">null</span>, <span class="string">"&#123;&#125;;"</span> + content);</span><br><span class="line">  &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">module</span>.exports.pitch = <span class="function"><span class="keyword">function</span>(<span class="params">remaining, preceding, data</span>) </span>&#123;</span><br><span class="line">  data.hello = <span class="string">'hello'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<h4 id="Plugin-初探"><a href="#Plugin-初探" class="headerlink" title="Plugin 初探"></a>Plugin 初探</h4><blockquote>
<p>Plugin起始是一个简单的<em>class</em>，有一个必须要实现的<em>apply</em>方法。</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LPlugin</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(options) &#123;</span><br><span class="line">    <span class="keyword">this</span>.options = options;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'options'</span>, options);</span><br><span class="line">  &#125;</span><br><span class="line">  apply(compiler) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'run this plugin'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> LPlugin = <span class="built_in">require</span>(<span class="string">'./plugins/LPlugin'</span>);</span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  ...,</span><br><span class="line">  plugins: [</span><br><span class="line">    <span class="keyword">new</span> LPlugin(&#123;</span><br><span class="line">      param1: <span class="number">1</span>,</span><br><span class="line">      param2: <span class="number">2</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>plugin在初始化参数就进行实例化(事件流开始时)，因此类似于<code>CleanWebpackPlugin</code>在构建之前进行文件操作删除掉某些目录也是很好实现的。</p>
<hr>
<blockquote>
<p>Tapable &amp; Hook Tapable是Webpack构建过程中的核心所在，其暴露了<code>tap tapAsync tapPromoise</code>等方法，可以使用这些方法，来注入一些逻辑，这些逻辑将会在构建过程的不同时机触发。</p>
</blockquote>
<p>例如:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">compiler.hooks.compile.tap(<span class="string">'LPlugin'</span>, params =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'触发了钩子函数'</span>);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>该钩子函数将会在<code>compile</code>阶段触发。</p>
<p>*** 自定义钩子函数<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; SyncHook &#125; = <span class="built_in">require</span>(<span class="string">'tapable'</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LPlugin</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(options) &#123;</span><br><span class="line">    <span class="keyword">this</span>.options = options;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'options'</span>, options);</span><br><span class="line">  &#125;</span><br><span class="line">  apply(compiler) &#123;</span><br><span class="line">    compiler.hooks.LPlugin = <span class="keyword">new</span> SyncHook([<span class="string">'data'</span>]);</span><br><span class="line">    compiler.hooks.enviroment.tap(<span class="string">'MyPlugin'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      compiler.hooks.LPlugin.call(<span class="string">'hello'</span>);</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'run this plugin'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LLPlugin</span> </span>&#123;</span><br><span class="line">  apply(compiler) &#123;</span><br><span class="line">    compiler.hooks.LPlugin.tap(<span class="string">'LLPlugin'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'data'</span>, data); <span class="comment">// data hello</span></span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://yoursite.com/2019/02/25/webpack-in-thinking/" data-id="cjz18hg5k001rl8j6b56r2rfs" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://yoursite.com/2019/02/25/webpack-in-thinking/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://yoursite.com/2019/02/25/webpack-in-thinking/">评论</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-webpack-dllplugin" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2019/01/06/webpack-dllplugin/">使用Webpack DllPlugin</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2019/01/06/webpack-dllplugin/">
            <time datetime="2019-01-06T11:52:32.000Z" itemprop="datePublished">2019-01-06</time>
        </a>
    </div>


                        
                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/Webpack/">Webpack</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h2 id="DllPlugin-简易使用指南"><a href="#DllPlugin-简易使用指南" class="headerlink" title="DllPlugin 简易使用指南"></a>DllPlugin 简易使用指南</h2><ol>
<li>创建<code>webpack.dll.config.js</code> 用于对特定的模块打包成dll</li>
<li><code>webpack --config webpack.dll.config.js</code> 生成dll以及其描述文件</li>
<li>在<code>webpack.common.config.js</code>中使用DllReferencePlugin引入打包好的dll文件。</li>
<li>打包。此时遇到相应的模块时直接引入而不会重新打包。</li>
</ol>
<h3 id="创建webpack-dll-config-js"><a href="#创建webpack-dll-config-js" class="headerlink" title="创建webpack.dll.config.js"></a>创建<code>webpack.dll.config.js</code></h3><blockquote>
<p>这里以分别打包<code>moment</code>和<code>lodash</code>为例</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// config.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  entry: &#123;</span><br><span class="line">    lodash: [<span class="string">'lodash'</span>],</span><br><span class="line">    moment: [<span class="string">'moment'</span>],</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// webpack.dll.config.js</span></span><br><span class="line"><span class="keyword">const</span> webpack = <span class="built_in">require</span>(<span class="string">'webpack'</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">const</span> config = <span class="built_in">require</span>(<span class="string">'./config'</span>);</span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  entry: config.entry,</span><br><span class="line">  output: &#123;</span><br><span class="line">    path: path.resolve(__dirname, <span class="string">'/static/dll'</span>),</span><br><span class="line">    filename: <span class="string">'[name].dll.js'</span>,</span><br><span class="line">    library: <span class="string">'[name]_library'</span></span><br><span class="line">  &#125;,</span><br><span class="line">  plugins: [</span><br><span class="line">    <span class="keyword">new</span> webpack.DllPlugin(&#123;</span><br><span class="line">      path: path.join(__dirname, <span class="string">'/static/dll'</span>, <span class="string">'[name]-manifest.json'</span>),</span><br><span class="line">      name: <span class="string">'[name]_library'</span>,</span><br><span class="line">      context: __dirname,</span><br><span class="line">    &#125;)</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>解释：</p>
<ol>
<li>推荐把入口配置信息写在单独文件中，易于维护。</li>
<li>DllPlugin类接受一个配置对象，该对象有三个属性：<code>context</code>(绝对路径), manifest文件中请求上下文；<code>name</code>,暴露的dll函数名；<code>path</code>：manifest文件存放的位置(绝对路径)。</li>
</ol>
<h3 id="使用DllReferencePlugin"><a href="#使用DllReferencePlugin" class="headerlink" title="使用DllReferencePlugin"></a>使用DllReferencePlugin</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.common.config.js</span></span><br><span class="line"><span class="keyword">const</span> config = <span class="built_in">require</span>(<span class="string">'./config'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  ... <span class="comment">// 省略其它配置</span></span><br><span class="line">  plugins: [</span><br><span class="line">    ...Object.keys(dllConfig.entry).map(<span class="function">(<span class="params">name</span>) =&gt;</span> <span class="keyword">new</span> <span class="keyword">new</span> webpack.DllReferencePlugin(&#123;</span><br><span class="line">      context: __dirname,</span><br><span class="line">      manifest: <span class="built_in">require</span>(<span class="string">`./static/dll/<span class="subst">$&#123;name&#125;</span>-manifest.json`</span>),</span><br><span class="line">    &#125;))</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>DllReferencePlugin 接受一个对象用于初始化</p>
</blockquote>
<ol>
<li>context: manifest的上下文(绝对路径)，需和DllPlugin中的context一致</li>
<li>manifest: manifest文件，使用require引入或指定绝对路径</li>
</ol>
<p>可选参数：</p>
<ol>
<li>content：模块id的映射，默认为 manifest.content</li>
<li>name: dll文件的名称，默认为 manifest.name</li>
<li>scope: dll 内容前缀</li>
<li>sourceType: dll如何暴露的？amd commonjs2 …</li>
</ol>
<p>scope: ‘abc’， 则该dll中的xyz文件可以通过require(‘abc/xyz’)来引用<br>例如在一个dll中打包了<code>lodash</code>和<code>axios</code>两个库，并且指定了<code>{scope: &#39;lib&#39;}</code>，则在需要使用axios的时候使用<code>require(&#39;lib/axios&#39;)</code>即可。</p>
<h3 id="测试1：把echarts，windui，react及其周边分别抽取成dll文件。"><a href="#测试1：把echarts，windui，react及其周边分别抽取成dll文件。" class="headerlink" title="测试1：把echarts，windui，react及其周边分别抽取成dll文件。"></a>测试1：把<code>echarts</code>，<code>windui</code>，<code>react</code>及其周边分别抽取成dll文件。</h3><p>抽取的dll文件大小分别为：753KB 1603KB，385KB。</p>
<table>
<thead>
<tr>
<th style="text-align:left">构建方式</th>
<th style="text-align:right">平均构建时间</th>
<th style="text-align:right">包大小</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">普通</td>
<td style="text-align:right">97s</td>
<td style="text-align:right">4.1MB</td>
</tr>
<tr>
<td style="text-align:left">使用Dll</td>
<td style="text-align:right">71s</td>
<td style="text-align:right">2.6MB</td>
</tr>
<tr>
<td style="text-align:left">dll文件</td>
<td style="text-align:right">24s</td>
<td style="text-align:right">2.7MB</td>
</tr>
</tbody>
</table>
<blockquote>
<p>经过对比发现，由于无法使用按需加载，所以整个<code>windui</code>打包的大小差不多为1.6MB，而普通的打包方式<code>windui</code>的大小仅为365KB。</p>
</blockquote>
<blockquote>
<p>在使用<code>windui</code>链接库后生成的打包，发现vendors模块中仍然含有<code>windui</code>，大小为<code>330KB</code>，仅<code>windui</code>中的<code>node_modules</code>文件夹下的<code>rc-trigger</code>和<code>rc-dropdown</code>被重用，因此这里可能重复打包了。</p>
</blockquote>
<blockquote>
<p><code>windui</code>中依赖的<code>rc-*</code>部分模块仍然被打包。</p>
</blockquote>
<h3 id="方式二-仅对react相关模块和echarts进行打包"><a href="#方式二-仅对react相关模块和echarts进行打包" class="headerlink" title="方式二 仅对react相关模块和echarts进行打包"></a>方式二 仅对<code>react</code>相关模块和<code>echarts</code>进行打包</h3><p>抽取的两个dll文件的大小为393KB 769KB</p>
<table>
<thead>
<tr>
<th style="text-align:left">构建方式</th>
<th style="text-align:right">平均构建时间</th>
<th style="text-align:right">包大小</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">普通</td>
<td style="text-align:right">97s</td>
<td style="text-align:right">4.1MB</td>
</tr>
<tr>
<td style="text-align:left">使用DLL</td>
<td style="text-align:right">77s</td>
<td style="text-align:right">3.08MB</td>
</tr>
<tr>
<td style="text-align:left">dll</td>
<td style="text-align:right">11s</td>
<td style="text-align:right">1.16MB</td>
</tr>
</tbody>
</table>
<blockquote>
<p><code>windui</code>的大小基本不变，而<code>windui</code>依赖的<code>rc-*</code>系列组件基本没被打包。</p>
</blockquote>
<blockquote>
<p><code>vendors</code>模块从<em>0.61MB</em>到<em>1.67MB</em></p>
</blockquote>
<h3 id="使用html-webpack-include-assets-plugin-把dll注入到index-html"><a href="#使用html-webpack-include-assets-plugin-把dll注入到index-html" class="headerlink" title="使用html-webpack-include-assets-plugin 把dll注入到index.html"></a>使用<code>html-webpack-include-assets-plugin</code> 把dll注入到<code>index.html</code></h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> HtmlWebpackIncludeAssetsPlugin = <span class="built_in">require</span>(<span class="string">'html-webpack-include-assets-plugin'</span>);</span><br><span class="line"><span class="keyword">const</span> dllIntoHtml = <span class="keyword">new</span> HtmlWebpackIncludeAssetsPlugin(&#123;</span><br><span class="line">  assets: [<span class="string">'./static/dll/echarts.dll.js'</span>, <span class="string">'./static/dll/react.dll.js'</span>], <span class="comment">// 需要注入的dll文件路径</span></span><br><span class="line">  append: <span class="literal">false</span>, <span class="comment">// 是否尾注入？push ： unshift</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>因为先构建dll，再进行项目构建，在项目构建过程中会删除整个build目录，所以在构建完后再把<em>dll文件夹</em>拷贝进<em>build/static/</em>。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ol>
<li><p><code>windui</code>进行dll打包后会因为无法按需加载而导致总大小偏高(且可能会产生冗余)；而不进行的话，包的总大小基本不变。</p>
</li>
<li><p>初始时需要加载的chunk从3个变为6个/5个</p>
</li>
</ol>
<h3 id="升级到webpack4-x"><a href="#升级到webpack4-x" class="headerlink" title="升级到webpack4.x"></a>升级到webpack4.x</h3><p>升级到webpak4.x后无论是<code>dll</code>还是最终生成块，都有小幅度的下降。与此同时，构建总时间(dll构建时间+项目build时间)略微减小。</p>
<h3 id="关于使用已存在的模块直接作为dll文件引入的可能性"><a href="#关于使用已存在的模块直接作为dll文件引入的可能性" class="headerlink" title="关于使用已存在的模块直接作为dll文件引入的可能性"></a>关于使用已存在的模块直接作为dll文件引入的可能性</h3><ol>
<li>目前无相关方面的实践。</li>
<li>DllPlugin抽取特定的模块构建dll文件后会生成一个<code>manifest</code>文件。该存储了各个模块的和公共模块的对应关系。<br>该文件会对已经打包成dll的模块中的文件进行描述，会给每个文件指定id，并且该<code>json</code>文件中的<code>name</code>属性对应dll的<code>library</code>。</li>
<li>在进行项目构建的时候，如需要打包某个模块，会在<code>manifest</code>文件中查找，如果该模块已经存在于dll中，依据manifest中的信息进行链接即可，不必重新打包。</li>
</ol>
<p>构建的dll块和使用<code>splitChunk</code>或者直接使用babel打包出来的块不一致。其依赖构建dll时指定的<code>library</code>等，而manifest文件也是和该块一一对应的。所以从理论上，使用其它方式提供dll文件由于构建方式和无法提供<code>manifest</code>文件，在构建过程中并不能被重用。</p>
<p>PS: 本片文章来自于我在团队内部分享的笔记，任何关于<code>webpack-dll-plugin</code>的理解和使用方式请在该插件的<a href="https://webpack.js.org/plugins/dll-plugin/" target="_blank" rel="noopener">Webpack介绍页查看</a>。</p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://yoursite.com/2019/01/06/webpack-dllplugin/" data-id="cjz18hg580016l8j61bdb33nm" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://yoursite.com/2019/01/06/webpack-dllplugin/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://yoursite.com/2019/01/06/webpack-dllplugin/">评论</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-this-year" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2018/12/31/this-year/">我的这一年</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2018/12/31/this-year/">
            <time datetime="2018-12-31T06:17:36.000Z" itemprop="datePublished">2018-12-31</time>
        </a>
    </div>


                        
                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/心灵记事/">心灵记事</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <blockquote>
<p>好一个寒冷的假期！</p>
</blockquote>
<h3 id="最后一日"><a href="#最后一日" class="headerlink" title="最后一日"></a>最后一日</h3><blockquote>
<p>早上七点，闹钟开始吵个不停，我习惯性按下锁屏键，并快速蜷缩到被窝中，十分钟后，我再次重复这两个动作，直到不得不起。可是，虽然是周一，可毕竟是假期呢。这次我直接打开了闹钟，取消了激活状态，这下，可以好好睡一觉了。</p>
</blockquote>
<p>再次醒来的时候，已经快十一点了，湖人的比赛已经开打，也没了吃早饭的必要。我摸出手机，打开“掘金”，果然，技术社区唯一的小说也停更了；今天是周一啊，我似乎忘记了点什么啊。没错！“龙五”更了，看饿了看进度条99.1%，果然，老贼可不会因为今天是18年最后一天，就爆更的。剧情延续上一章，雪救下了阿巴斯，拯救了整个船上的人，而现在船员都知道雪是一个怪物了，要处决她。现在该由阿巴斯救雪了，阿巴斯夹带着言灵“因陀罗”登场，本章完。按照老贼的尿性，在阿巴斯救下雪这个过程中再水个三五章不无可能。哎，什么时候到个头呢！</p>
<p>好不容易起了床，洗漱完毕，打开电脑，开始了一天的“工作”。打开<em>NBA 2K Online2</em>，先晚上两把，发现我已经<code>11</code>连胜了；打开<strong>某鱼</strong>直播平台，看狗贼叔叔打两把“沙包战”；同性交友社区<code>GitHub</code>当然也不可少，看看<strong>前端娱乐圈</strong>，今天是否又有猛料。一切完毕，吃饭的点到了，刚刚好。</p>
<p>要是在上班，直接电梯直下十层，食堂的饭虽然不好吃又凉，但架不住便宜并且还少了奔波，所以单从填饱肚子的角度上来说，还行。而周末或是假期就不一样了，自己做饭是不可能的，那么除了点外卖就只好出去吃了，还是在这寒风刺骨的冬天。</p>
<p>穿好厚重的羽绒服，匆匆下了楼，今天我并不想图近就在附近随便吃点，而是要走过好几个路口去公司旁边的小店吃。虽然说实话，作为一个重庆人，从小色香味俱全的菜吃多了，反而觉得这边的什么都不好吃，并且还贵。可是呢，生活还得继续，所以在吃这方面，我能选的只有分量大/价格便宜，如果能够稍微好吃点，那可就是极好的了。</p>
<p>去公司的有两条街最近一直在施工，这不，路过红绿灯的时候，送外卖的小哥把车开进刚铺好的水泥路上，直接连人带车陷进去了。这么冷的天，弄得双腿都是未干的水泥，车也暂时开不了了，不知又会耽搁几个外卖，损失多少收入呢。前天晚上给母亲打电话，都很晚了父亲还在工地上没下班，并且他们基本上是没有休息日的，连节假日也不例外。在我心中，劳动人民都是伟大的，值得所有人的尊重。</p>
<p>刚开始写这篇文章的时候，我开着窗户，吹着寒风；可是不一会儿，就冻得受不了，只好打开空调，顿时暖风阵阵，僵住的双手得以解冻，恢复了往日的活力，然后电费飙升，令人心疼。</p>
<p>预计我会在写完文章过后玩两把<strong>吃鸡</strong>，到了饭点，我会叫上一顿<em>丰盛</em>的外卖，整个晚上，会找一些还没看过且是科幻/战争题材的电影看看，往后还有让人拍案叫绝的<strong>2K</strong>剁手环节。我的2018最后一天，会这样度过。</p>
<h3 id="毕业设计"><a href="#毕业设计" class="headerlink" title="毕业设计"></a>毕业设计</h3><blockquote>
<p>我已经不记得2018年的第一天，我具体干了什么。按时间来算，应该在准备期末答辩，然后开始享受学生时代的最后一个寒假？</p>
</blockquote>
<p>我记得春节刚过，我就来到了学校，那个时候软件园水池里还结着厚厚的冰，健身房的门还没开。我选的毕业设计是一款Web应用的开发，并且要求的是使用<em>Vue</em>开发，那个时候我对<em>Vue</em>的了解仅限于听过它的名字，仔细看完一遍官方文档，我就和导师的研究生们开始开发这个应用了。其实对于这个合作的项目，我多有吐槽，这本是一个为收集用户行为数据并进行进一步分析的应用，从应用本身的规划来说没什么问题，但问题就出在开发者本身上面，效率真的很低。每次9点到实验室结果研究生哥哥姐姐们还没到；约好时间进行接口对接，结果竟然在玩手游；一周下来，一个页面都没做好。鉴于此，我决定给我的导师摊牌，我可以协助完成整个应用的开发，但是对于我的毕业设计，我想自己开发。后来，我花了差不多一周时间完成了管理员端的开发，协助完成了接口开发，解决他们遇到的几乎所有问题，然后，脱离了这个合作项目。</p>
<p>其实，不应该只有吐槽。负责接口开发的学长才研一，跨专业考的软工，并且我们的后端使用的是<code>Spring Boot</code>,对于一个<code>Java</code>都怎么熟悉的人，能够在短时间之内完成任务，并且每次我们交流的时候他都在工作，就冲这股认真劲，给他点赞。另外一个就是负责开发应用的学姐了，在整个应用中，我和她接触最多。她对前端也不怎么了解，一个月下来也能做得有模有样，并且干起活来特别认真，一个特别热心肠的人。认真努力的人，值得我们尊重，并抱有敬意！</p>
<p>我的毕业设计脱胎于这个合作项目，是一款基于位置感知的任务众包平台。至于位置感知，就是对于绝大多数本地线下任务而言，推送给用于是基于位置的。此外，还构建了基于统一交易凭证的支付平台，内容审核，用户论坛等。从前端到接口，完全由我一个人开发。当然，直到最后毕业答辩，拿到优秀后，我仍然觉得这个应用还只是一个<code>demo</code>，只完成了所有设想的功能，页面也仅符合直男审美。</p>
<p>这是我的一次尝试，我设想着把想法付诸行动，并且在二十多个下午，我完全进入了编程状态，带上耳机，排除一切干扰，尽量把工作做好。而这样的体验，也只有15年在<strong>西电</strong>的一年时光。除此之外，对于在项目中用到的技术/框架，我加深了理解，我开始了解到单页应用服务端渲染，对web前端，以前可能只是开了一户小窗，而现在简直是开了一扇门。</p>
<h3 id="毕业季"><a href="#毕业季" class="headerlink" title="毕业季"></a>毕业季</h3><blockquote>
<p>在毕业前几天，我来到上海，租好房，开始迎接新的生活，在此之前，似乎还重要的事情等待去做。</p>
</blockquote>
<p>其实放在以前这件事是我想都不敢想的，这当然不是向喜欢的女孩子表白，更谈不上惊天动地。说到底，是我一个人的执念罢了。在22岁这个年纪，在开始一段全新生活之前，想要解开的心结。</p>
<p>而来到上海入职的前几天，我买了到福州的火车票，然后在那里呆了一天，见到了熟悉的陌生人和她所见的世界。回上海的那一天晚上，刚下过大雨，我从地铁站回公寓，听见小区里的蛙鸣，在这个寂静的夜里，我把什么都抛到了脑后，一切都在那一刻结束了。</p>
<p>不枉我耿耿于怀那么多年。</p>
<h3 id="工作"><a href="#工作" class="headerlink" title="工作"></a>工作</h3><blockquote>
<p>我准备好了工作，可是真到了那一天，我发现这不是我想要的。</p>
</blockquote>
<p>其实工作说得很多了，在很多<strong>周记</strong>里，我都提到这周完成什么样的工作。半年下来我的态度也在慢慢发生改变，我不得不去做自己不那么感兴趣的事，我对重复性劳动也没那么排斥。我能够利用工作中空余的时间片段，学到更多的知识。</p>
<p>其实自己对工作还是多有不满的，这种不满最初来自于对工作预期的落差，后又因为莫名其妙的转岗雪上加霜，现在因为重复性的劳动。除此之外，我接触到的同事，都非常<em>nice</em>；还有我们的小伙伴们，真的幸运能够和你们认识。</p>
<p>说说最近吧，部门新来了一名实习生，说是做后端的，但是由于我们项目缺人，所以就过来搞前端。大概工位离我很近的原因，我成了他指定导师。说是导师，其实也就是他遇到工作中的问题，我负责给他解答而已。小明才来了几天，一天趁晚饭时间，和他聊了不少。从在校，学习到面试基本都问了下。这位小明同学给我的印象就是，他仅仅是一张白纸而已，说是做后端，但一问到也说不出个所以然来；前端？抱歉也许以前做课程设计的时候可能写过<code>JSP</code>。所以说，我打心底里根本没想让他在短时间加入到这个项目中。这种他最主要的任务就是学习，从<code>JavaScript</code>语法开始；可刚学一天，他就给我说，学习没有目的性；刚过一周，他不但把<code>JavasScript</code>看得差不多了，<code>React</code>也加入了技能树。可是当我问的时候，我说React的生命周期有没有理解，<code>props</code>和<code>state</code>是怎么回事，<strong>命令式</strong>和<strong>声明式</strong>区分开了吗，他却说不出个一二。然后我又花很多时间给他讲。我想到我自己，从大二开始接触前端，很久也对<code>JS</code>不怎么理解，<code>React</code>差不多接触了一年多，写了好多<code>Demo</code>才能达到熟练使用用的程度，是我太笨了，还是他们他浮躁呢？所以，小明在下个迭代会加入我们，并且我给他安排了差不多我<code>1/3</code>的任务量，希望他能够快速成长吧。</p>
<p>关于我正在做的这个项目，经历了刀耕火种的时代，在开发过程中大家逐步填坑，并且为了解决开发过程中的痛点，开发了许多轮子；直到现在，我们打开发效率很高了。除了免不了成为配置工程师或者说流水线工人，我想说，我喜欢这个团队。希望项目早日完成/找到接盘侠，脱离苦海。</p>
<h3 id="生活"><a href="#生活" class="headerlink" title="生活"></a>生活</h3><p>生活也在<strong>周记</strong>中提到很多了，每天除了工作，下班了我基本上不会选择继续学习，可能会看看直播玩玩游戏。周末，多睡睡觉，打打篮球，看看电影放松放松。可不是不知为何，一到周一上班特别累。</p>
<p>本来想着来工作了继续健身，所以办了健身卡，每周4次的量，可是奈何健身房跑路这种奇葩的事情都能让我碰见，所以健身就搁置了。每周会花一些时间利用弹力绳保持下身材，所以到现在还没变成肥宅，可是看见日渐隆起的小腹，心中的担忧又来了~</p>
<h3 id="未来"><a href="#未来" class="headerlink" title="未来"></a>未来</h3><p>当初我憧憬魔都才选择来到这里工作，可是半年过去了，我丝毫没有归属感。除了同事和舍友，我基本不认识其它什么人；土著们操着一口你怎么也听不懂的方言；这里的物价水平也高到离谱，房租花费3000+，随便吃点什么也都得花费两倍于家乡甚至更高。最奇葩的是，隔壁的老太遇到过我两次，每次都问很久，结果他担心的是外来租客可能导致不安全的问题。虽然老太并没有恶意，但是我却心底拔凉拔凉的，我们是怀着梦想来到魔都，给魔都带来活力，我们买不起房，上下班骑<em>摩拜</em>，我们蜗居在10平米的小屋里却交着巨额房租，而现在他们不欢迎我们，担心我们打破他们的生活宁静，可那又有什么办法呢，就算是这样，生活还得继续不是吗？</p>
<p>所以我每次都认真回答老太的问题，并且打消老太这方面的顾虑。我喜欢魔都的生活节奏，但我看到每个月到手的工资和交完房租和生活必须花费后存下的钱，我想，我的未来不会在这里。至于下一站在哪里，何时到站，还没有计划，但可以预见的是，不会太久。</p>
<p>无论是到哪里，都要不虚此行，所以珍惜每个平常的一天，让自己能更进一步，变得更加优秀。</p>
<h3 id="尾巴"><a href="#尾巴" class="headerlink" title="尾巴"></a>尾巴</h3><p>还有不到7个小时就2019年了，在2018年我结束了学生时代，并且在22岁的年龄开始独挡一面。我以前说过，我从小到大几乎所有的决定都是我自己做的，而家人们总是尊重我的决定并且无条件的支持我。我想，什么时候他们能给我一个决定呢？好吧，就让它在2019年吧，说到做到！</p>
<p>愿好，明年见！</p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://yoursite.com/2018/12/31/this-year/" data-id="cjz18hg51000sl8j6wdxwsdzs" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://yoursite.com/2018/12/31/this-year/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://yoursite.com/2018/12/31/this-year/">评论</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-month-record-1202" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2018/12/02/month-record-1202/">每周一记？</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2018/12/02/month-record-1202/">
            <time datetime="2018-12-02T07:10:02.000Z" itemprop="datePublished">2018-12-02</time>
        </a>
    </div>


                        
                        
                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <blockquote>
<p>最近总想着升级，比如玩2K阵容想升级，为了追剧想升级成为XX视频会员，为了得到更好的电竞体验，想升级我这台还不怎么过时的PC。当然，其实写周记也要升级了，升为月记可好？</p>
</blockquote>
<p>废话少说，不然电竞时间不够用啦。</p>
<h3 id="学习"><a href="#学习" class="headerlink" title="学习"></a>学习</h3><blockquote>
<p>项目在迭代后期照例改改bug划划水，所以空出来大把大把的时间，去掉刷微博看NBA，貌似还剩点时间片，所以还是装模做样，假装学习。</p>
</blockquote>
<ol>
<li>DOM Element 位置相关的属性</li>
</ol>
<p>这可是学了又忘，用到查资料的东西，总是会把这么些属性搞混。</p>
<p><code>client-*</code>: 不用说，这个还是记得住的。</p>
<p><code>scroll-*</code>：如果是描述形状的话(width&amp;height)，那就是元素(及padding)和溢出区的宽/高度，如果是位置，则表示向下/右滚动的距离。</p>
<p><code>offset-*</code>: 基于元素的<code>offsetParent</code>来进行形状和位置的计算。而<code>offsetParent</code>则表示距离元素最靠近的上层元素，且其<code>position</code>不为<code>static。如果是表示形状，则表示其水平/竖直方向上的高度(包含padding和border)；
如果表示位置，则表示距</code>offsetParent`的距离。</p>
<p>再认识一下<code>getBoundingClientRect()</code>用于获取盒模型的各种属性。<br>其中<code>x</code>,<code>y</code>表示其相对视口的距离，<code>width</code>，<code>height</code>等于(content+padding+border)。其余四个表示位置的属性分别表示据左上角/右下角的距离。</p>
<ol start="2">
<li>Node.js 核心模块回顾</li>
</ol>
<h4 id="net-用于创建TCP-Server和Client"><a href="#net-用于创建TCP-Server和Client" class="headerlink" title="net 用于创建TCP Server和Client."></a>net 用于创建TCP Server和Client.</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">net.createServer(<span class="function"><span class="keyword">function</span>(<span class="params">socket</span>)</span>&#123;</span><br><span class="line">   socket.on(<span class="string">'data'</span>, (chunk) =&gt; &#123;</span><br><span class="line">       <span class="built_in">console</span>.log(<span class="string">'data from client: '</span>, chunk.toString())</span><br><span class="line">   &#125;)</span><br><span class="line">   socket.write(<span class="string">'hello'</span>);</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">const</span> client = net.createConnection(options)</span><br><span class="line">client.on(<span class="string">'data'</span>, (chunk) =&gt; &#123;</span><br><span class="line">   <span class="built_in">console</span>.log(<span class="string">'data from server: '</span>, chunk.toString())</span><br><span class="line">&#125;)</span><br><span class="line">client.send(<span class="string">'hello server'</span>)</span><br></pre></td></tr></table></figure>
<h4 id="path-工具模块"><a href="#path-工具模块" class="headerlink" title="path 工具模块"></a>path 工具模块</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">path.basename() 文件名</span><br><span class="line">path.dirname() 目录名</span><br><span class="line">path.extname 扩展名</span><br><span class="line">path.format(ooption) 将一个对象格式化为一个路径</span><br><span class="line">path.parse(path) <span class="comment">// 将一个路径解析成为一个路径对象</span></span><br><span class="line">path.join() <span class="comment">// 路径拼接</span></span><br><span class="line">path.resolve() <span class="comment">// 将路径片段拼处理成绝对路径</span></span><br></pre></td></tr></table></figure>
<ol start="3">
<li>React 新特性学习</li>
</ol>
<blockquote>
<p>现在React存在的问题：包装地狱 庞大的组件 class组件</p>
</blockquote>
<p>hook：在function组件中使用到class组件中的很多特性</p>
<p><code>useState</code>为组件添加状态<br><code>useContent</code> 组件上下文<br><code>useEffect</code> 用于处理副作用</p>
<p>自定义hook</p>
<ol start="4">
<li>Webpack 4.x 之 code split</li>
</ol>
<p><code>webpack</code>默认的分割规则：</p>
<ul>
<li>新的代码块被共享，或是这些模块来自于<code>node_modules</code>文件夹</li>
<li>新的块压缩前大于30KB</li>
<li>按需加载的块，并行请求数小于等于5</li>
<li><p>初始加载的块，并行请求数小于等于3</p>
<p>默认情况下只会影响到按需加载模块，否则所有模块都会被打包到一起。</p>
<p>使用ES提案中的动态加载方案，<code>import()</code>，则会进行按需加载并单独打包。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">optimization: &#123;</span><br><span class="line">   splitChunk: &#123;</span><br><span class="line">       chunks: <span class="string">'all|initial|async'</span></span><br><span class="line">       minSize: number,</span><br><span class="line">       minChunks: number,</span><br><span class="line">       maxAsyncRequests: number,</span><br><span class="line">       maxInitialRequests: number,</span><br><span class="line">       name: string,</span><br><span class="line">       cacheGroup: &#123;</span><br><span class="line">           test: regexp,</span><br><span class="line">           priority: number,</span><br><span class="line">           reUseExitintChunk: boolean,</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>指定chunks为<code>all|initial</code>会把<code>node_modules</code>中的模块分配到<code>vendors</code>缓存组，而重复至少两次的代码将会被打包到<code>default</code>缓存组。</p>
<p><code>initial</code>和<code>all</code>的区别是：当按需加载时，<code>initial</code>会分开打包，而<code>all</code>会统一打包。</p>
<p>提取特性的第三方库，可以直接新建一个缓存。</p>
<h3 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h3><p>最近在看的番《史莱姆》和《猪头少年》。</p>
<p>最近在看的剧《人不彪悍枉少年》。</p>
<p>值得一看的美剧《地球百子》系列。</p>
<p>特别推荐科幻美剧《无垠的太空》系列。</p>
<p>绝对不推荐的游戏《绝地求生》，打到自闭。</p>
<h3 id="尾巴"><a href="#尾巴" class="headerlink" title="尾巴"></a>尾巴</h3><p>一个多月没打篮球了。还记得刚来上海的时候，几乎每周都要去一次甚至闲的时候还会去两次，那个时候打球，特别容易迷失。如果被分到了很强的队伍，很容易隐身，超没存在感；如果分到了较弱的队，需要我进攻的时候，总是犹豫不绝；再加上时准不准的投射水平，突破终结能力实在一般，几乎每次打球都不会体验很好。</p>
<p>后来，既然做不好进攻，那就好好防守。毕竟身体还算强壮，下盘还很稳，又不惧对抗，最近几次打篮球在防守端还是不错的，对位同等身高的人，一点都不虚。防守好了，也带动了进攻，更加坚决的出手，往往可以收到意想不到的效果。</p>
<p>我差不多从上初中就开始打球，天赋平平，基本功又不够扎实，所以这么多年来基本上没什么长进。以前我十分乐意分享球，想成为一名组织者，可慢慢打着变成了神经刀。最近小伙伴叫我<em>罗伯森</em>，因为我的表现的确像。而我也乐意接受这样的角色，专注于自己擅长的事，成为一名好队友，一名好的<em>角色球员</em>。</p>
<p>我曾经打篮球打到自闭，一度放弃篮球。可是，我还是喜欢玩篮球游戏，也无时不刻关注NBA，我也有我喜欢的球星（偶像）。说到底，我还是喜欢篮球啊。我的生活可少不了篮球。</p>
<p>生活也是这样，作为一个平庸的人，也要努力找到自己的擅长的点。</p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://yoursite.com/2018/12/02/month-record-1202/" data-id="cjz18hg52000ul8j6q45ccwp5" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://yoursite.com/2018/12/02/month-record-1202/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://yoursite.com/2018/12/02/month-record-1202/">评论</a>
    

        </footer>
    </div>
    
</article>



    <nav id="page-nav">
        <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/2/">下一页 &raquo;</a>
    </nav>
</section>
            
                
<aside id="sidebar">
   
        
    
        
    <div class="widget-wrap">
        <h3 class="widget-title">归档</h3>
        <div class="widget">
            <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">八月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">七月 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">六月 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">二月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">一月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">十二月 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">十一月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">十月 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">九月 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">八月 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">七月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">六月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">五月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">四月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">二月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">十月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">八月 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">七月 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">五月 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">四月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">三月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">二月 2017</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">一月 2017</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">十二月 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">十一月 2016</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">十月 2016</a><span class="archive-list-count">7</span></li></ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">标签</h3>
        <div class="widget">
            <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/About/">About</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CSS/">CSS</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JavaScript/">JavaScript</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Node-js/">Node.js</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/React/">React</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vue/">Vue</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Webpack/">Webpack</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/canvas/">canvas</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/webpack/">webpack</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/周记/">周记</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/心灵记事/">心灵记事</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/晨记/">晨记</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/杂谈/">杂谈</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/计算机网络/">计算机网络</a><span class="tag-list-count">2</span></li></ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">标签云</h3>
        <div class="widget tagcloud">
            <a href="/tags/About/" style="font-size: 10px;">About</a> <a href="/tags/CSS/" style="font-size: 11.43px;">CSS</a> <a href="/tags/JavaScript/" style="font-size: 20px;">JavaScript</a> <a href="/tags/Node-js/" style="font-size: 10px;">Node.js</a> <a href="/tags/React/" style="font-size: 18.57px;">React</a> <a href="/tags/Vue/" style="font-size: 10px;">Vue</a> <a href="/tags/Webpack/" style="font-size: 14.29px;">Webpack</a> <a href="/tags/canvas/" style="font-size: 10px;">canvas</a> <a href="/tags/webpack/" style="font-size: 10px;">webpack</a> <a href="/tags/周记/" style="font-size: 17.14px;">周记</a> <a href="/tags/心灵记事/" style="font-size: 15.71px;">心灵记事</a> <a href="/tags/晨记/" style="font-size: 12.86px;">晨记</a> <a href="/tags/杂谈/" style="font-size: 12.86px;">杂谈</a> <a href="/tags/计算机网络/" style="font-size: 11.43px;">计算机网络</a>
        </div>
    </div>

    
        
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">链接</h3>
        <div class="widget">
            <ul>
                
                    <li>
                        <a href="http://smithyang.cn">smithyang</a>
                    </li>
                
            </ul>
        </div>
    </div>


    
    <div id="toTop" class="fa fa-angle-up"></div>
</aside>

            
        </div>
        <footer id="footer">
    <div class="outer">
        <div id="footer-info" class="inner">
            &copy; 2019 Limoer<br>
            Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>. Theme by <a href="http://github.com/ppoffice">PPOffice</a>
        </div>
    </div>
</footer>
        
    
    <script>
    var disqus_config = function () {
        
        this.page.identifier = 'undefined';
    };
    (function() { 
        var d = document, s = d.createElement('script');  
        s.src = '//' + 'limoer' + '.disqus.com/count.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>




    
        <script src="/libs/lightgallery/js/lightgallery.min.js"></script>
        <script src="/libs/lightgallery/js/lg-thumbnail.min.js"></script>
        <script src="/libs/lightgallery/js/lg-pager.min.js"></script>
        <script src="/libs/lightgallery/js/lg-autoplay.min.js"></script>
        <script src="/libs/lightgallery/js/lg-fullscreen.min.js"></script>
        <script src="/libs/lightgallery/js/lg-zoom.min.js"></script>
        <script src="/libs/lightgallery/js/lg-hash.min.js"></script>
        <script src="/libs/lightgallery/js/lg-share.min.js"></script>
        <script src="/libs/lightgallery/js/lg-video.min.js"></script>
    
    
        <script src="/libs/justified-gallery/jquery.justifiedGallery.min.js"></script>
    
    



<!-- Custom Scripts -->
<script src="/js/main.js"></script>

    </div>
</body>
</html>