<!DOCTYPE html>
<html lang=zh>
<head>
    <meta charset="utf-8">
    
    <title>Limoer的记事小本</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta property="og:type" content="website">
<meta property="og:title" content="Limoer的记事小本">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Limoer的记事小本">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Limoer的记事小本">
    

    
        <link rel="alternate" href="/" title="Limoer的记事小本" type="application/atom+xml" />
    

    

    <link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/libs/open-sans/styles.css">
    <link rel="stylesheet" href="/libs/source-code-pro/styles.css">

    <link rel="stylesheet" href="/css/style.css">

    <script src="/libs/jquery/2.1.3/jquery.min.js"></script>
    
    
        <link rel="stylesheet" href="/libs/lightgallery/css/lightgallery.min.css">
    
    
        <link rel="stylesheet" href="/libs/justified-gallery/justifiedGallery.min.css">
    
    
    
    


</head>

<body>
    <div id="container">
        <header id="header">
    <div id="header-main" class="header-inner">
        <div class="outer">
            <a href="/" id="logo">
                
                <span class="site-title">Limoer的记事小本</span>
            </a>
            <nav id="main-nav">
                
                    <a class="main-nav-link" href="/.">Home</a>
                
                    <a class="main-nav-link" href="/archives">Archives</a>
                
                    <a class="main-nav-link" href="/categories">Categories</a>
                
                    <a class="main-nav-link" href="/tags">Tags</a>
                
                    <a class="main-nav-link" href="/about">About</a>
                
            </nav>
            
                
                <nav id="sub-nav">
                    <div class="profile" id="profile-nav">
                        <a id="profile-anchor" href="javascript:;">
                            <img class="avatar" src="/css/images/62.png" />
                            <i class="fa fa-caret-down"></i>
                        </a>
                    </div>
                </nav>
            
            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="搜索" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="想要查找什么..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div>
        </div>
    </div>
    <div id="main-nav-mobile" class="header-sub header-inner">
        <table class="menu outer">
            <tr>
                
                    <td><a class="main-nav-link" href="/.">Home</a></td>
                
                    <td><a class="main-nav-link" href="/archives">Archives</a></td>
                
                    <td><a class="main-nav-link" href="/categories">Categories</a></td>
                
                    <td><a class="main-nav-link" href="/tags">Tags</a></td>
                
                    <td><a class="main-nav-link" href="/about">About</a></td>
                
                <td>
                    
    <div class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="搜索" />
    </div>

                </td>
            </tr>
        </table>
    </div>
</header>

        <div class="outer">
            
                

<aside id="profile">
    <div class="inner profile-inner">
        <div class="base-info profile-block">
            <img id="avatar" src="/css/images/62.png" />
            <h2 id="name">Limoer</h2>
            <h3 id="title">A student from SDU, focusing on browser side developing.</h3>
            <span id="location"><i class="fa fa-map-marker"></i>Jinan, China</span>
            <a id="follow" target="_blank" href="http://weibo.com/u/2994244652?refer_flag=1001030101_">关注我</a>
        </div>
        <div class="article-info profile-block">
            <div class="article-info-block">
                43
                <span>文章</span>
            </div>
            <div class="article-info-block">
                12
                <span>标签</span>
            </div>
        </div>
        
        <div class="profile-block social-links">
            <table>
                <tr>
                    
                    
                    <td>
                        <a href="http://github.com/xiaomoer/" target="_blank" title="github" class=tooltip>
                            <i class="fa fa-github"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="/" target="_blank" title="twitter" class=tooltip>
                            <i class="fa fa-twitter"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="/" target="_blank" title="facebook" class=tooltip>
                            <i class="fa fa-facebook"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="/" target="_blank" title="dribbble" class=tooltip>
                            <i class="fa fa-dribbble"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="/" target="_blank" title="rss" class=tooltip>
                            <i class="fa fa-rss"></i>
                        </a>
                    </td>
                    
                </tr>
            </table>
        </div>
        
    </div>
</aside>

            
            <section id="main">
    <article id="post-local-search" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2020/08/07/local-search/">浏览器Ctrl+F功能的JS实现</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2020/08/07/local-search/">
            <time datetime="2020-08-07T06:24:15.000Z" itemprop="datePublished">2020-08-07</time>
        </a>
    </div>


                        
                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/JavaScript/">JavaScript</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <blockquote>
<p>浏览器提供的查找功能(<code>Ctrl+F</code>唤起)可以方便我们检索页面中的关键字以及标记它们出现在页面中的位置。在某个需求中，我需要实现一个类似的静态页面文本检索功能，<code>JS</code>并不能直接调用浏览器提供的检索功能，在不借助任何后端和云搜索(例如<code>Algolia</code>)的前提下，实现页面文本搜索。</p>
</blockquote>
<h3 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h3><blockquote>
<p>检索工具的运行流程是这样的：1）用户输入关键字，点击<code>搜索</code>按钮，检索完成，并标记第一个出现的位置；2）点击<code>下一个</code>按钮，页面滚动到下一个匹配关键字的元素的位置，并标记文本；3）使用中途，可以切换关键字，重新开始步骤 1)2)。</p>
</blockquote>
<p>我们要实现的<em>文本搜索工具</em>主要有两个功能：</p>
<ol>
<li>文本检索</li>
<li>文本标记</li>
</ol>
<p>此外，我们还可以在这两个基础功能上进行扩展，比如：</p>
<ul>
<li>既然支持了关键字查询，那么可以让是否模糊查询可选</li>
<li>同样，让搜索起点可选</li>
<li>增加对<code>CSS</code>选择器的支持</li>
</ul>
<p>确定了要实现的功能后，再想一下大致的实现方式，这里有几个问题，解决完所有的问题，文本检索工具就完成了。</p>
<ol>
<li>接口该如何设计？</li>
<li>为了保证搜索性能，需要建立<code>文本</code>到<code>HTMLElement</code>的映射，如何实现这个过程？</li>
<li>基于建立的映射，如何处理同一个元素下<strong>多个文本</strong>的标记？</li>
<li>其它可能遇到的问题。</li>
</ol>
<blockquote>
<p>带着这些问题，开始！</p>
</blockquote>
<h3 id="如何设计接口？"><a href="#如何设计接口？" class="headerlink" title="如何设计接口？"></a>如何设计接口？</h3><p>基于上面描述的检索工具的运行流程和将要实现的功能，在工具初始化时，可以配置用户初始输入<code>input</code>/是否模糊查询<code>useRegexp</code>/检索入口<code>scope</code>；初始化完成后，通过调用<code>search</code>接口，开始检索并返回检索结果；检索完成后，通过调用<code>next</code>接口，开始在页面中标记文本；最后，还需要一个<code>setSearch</code>接口来设置用户检索文本。</p>
<p>最终设计的接口如下：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">declare</span> <span class="keyword">const</span> TypeSelector = <span class="string">"selector"</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">declare</span> <span class="keyword">const</span> TypeText = <span class="string">"text"</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> IDomFormated &#123;</span><br><span class="line">  dom: HTMLElement;</span><br><span class="line">  <span class="keyword">type</span>: <span class="keyword">typeof</span> TypeSelector | <span class="keyword">typeof</span> TypeText;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">declare</span> <span class="keyword">type</span> KeywordsOrSelector =</span><br><span class="line">  | <span class="built_in">string</span></span><br><span class="line">  | keyof HTMLElementTagNameMap</span><br><span class="line">  | keyof SVGElementTagNameMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> IOptions &#123;</span><br><span class="line">  useRegexp?: <span class="built_in">boolean</span>;</span><br><span class="line">  scope?: HTMLElement | <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">interface</span> IProps <span class="keyword">extends</span> IOptions &#123;</span><br><span class="line">  input?: KeywordsOrSelector;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span> <span class="keyword">class</span> LocalSearch &#123;</span><br><span class="line">  <span class="keyword">private</span> input;</span><br><span class="line">  <span class="keyword">private</span> config;</span><br><span class="line">  <span class="keyword">private</span> current;</span><br><span class="line">  <span class="keyword">private</span> result;</span><br><span class="line">  <span class="keyword">private</span> prevDomText;</span><br><span class="line">  <span class="keyword">private</span> prevDom;</span><br><span class="line">  <span class="keyword">private</span> updateList;</span><br><span class="line">  <span class="keyword">constructor</span>(<span class="params">props: IProps</span>);</span><br><span class="line">  setSearch(<span class="params">input: KeywordsOrSelector</span>): void;</span><br><span class="line">  begin(<span class="params"></span>): Promise&lt;IDomFormated[]&gt; | undefined;</span><br><span class="line">  next(<span class="params"></span>): boolean;</span><br><span class="line">&#125;</span><br><span class="line">export default LocalSearch;</span><br></pre></td></tr></table></figure>
<h3 id="如何实现搜索过程？"><a href="#如何实现搜索过程？" class="headerlink" title="如何实现搜索过程？"></a>如何实现搜索过程？</h3><p>调用<code>localSearchInstance.begin</code>其内部会调用<code>search(input: KeywordsOrSelector, params?: IOptions): Promise&lt;IDomFormated[]&gt;</code>函数开始检索流程，整个流程又分为<em>关键字匹配</em>和<em>选择器查询</em>。</p>
<h4 id="选择器查询"><a href="#选择器查询" class="headerlink" title="选择器查询"></a>选择器查询</h4><p>选择器查询很简单，就是调用<code>dom.querSelectorAll(input)</code>，需要注意的是，如果<code>input</code>不是一个合法的<code>selectors</code>，会抛出错误，在实现的时候，捕获该错误，抛出<code>[]</code>即可。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">querySelector</span>(<span class="params">input: KeywordsOrSelector, scope: HTMLElement</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> doms: HTMLElement[] = [];</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    doms = <span class="built_in">Array</span>.from(scope.querySelectorAll(input));</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="built_in">console</span>.warn(<span class="string">"invalid selector"</span>);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Promise</span>.resolve(doms);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="关键字检索"><a href="#关键字检索" class="headerlink" title="关键字检索"></a>关键字检索</h4><p>关键字检索就是遍历已经建立好的文本与元素间的映射。首次检索时，映射未建立，需要从指定的根元素开始，进行 DOM 遍历。</p>
<p>在<code>DOM</code>遍历过程中，为了更好的建立映射，需要建立以下几条约定：</p>
<ul>
<li>当前节点如果是文本节点<code>nodeType = 3</code>和以及注释<code>nodeType = 8</code>和<code>[ &#39;SCRIPT&#39;, &#39;NOSCRIPT&#39;, &#39;BR&#39;, &#39;HR&#39;, &#39;IMG&#39;, &#39;INPUT&#39;, &#39;COL&#39;, &#39;FRAME&#39;, &#39;LINK&#39;, &#39;AREA&#39;, &#39;PARAM&#39;, &#39;EMBED&#39;, &#39;KEYGEN&#39;, &#39;SOURCE&#39;, ]</code>这些自闭合元素，不再向下遍历</li>
<li>如果元素的<code>display: inline*</code>，不在向下遍历</li>
<li>如果某个元素中只包含<code>TextNode</code>，不再向下遍历<br>代码如下：</li>
</ul>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">generateTextMapString</span>(<span class="params">parent: HTMLElement</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!first) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 非element类型</span></span><br><span class="line">  <span class="keyword">if</span> (!isValidNode(parent)) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> isInline = <span class="regexp">/^inline/</span>.test(getStyle(parent, <span class="string">"display"</span>));</span><br><span class="line">  <span class="comment">// 如果是行内元素</span></span><br><span class="line">  <span class="keyword">if</span> (isInline) &#123;</span><br><span class="line">    setCaches(parent.innerText, parent);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 如果某个元素中只包含TextNode，则取父元素的innerText</span></span><br><span class="line">  <span class="keyword">const</span> childNodes = <span class="built_in">Array</span>.from(parent.childNodes);</span><br><span class="line">  <span class="keyword">if</span> (childNodes.every(<span class="function">(<span class="params">node</span>) =&gt;</span> node.nodeType === <span class="number">3</span>)) &#123;</span><br><span class="line">    setCaches(parent.innerText, parent);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 遍历所有childNode</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> node of childNodes) &#123;</span><br><span class="line">    <span class="keyword">if</span> (node.nodeType === <span class="number">3</span> &amp;&amp; node.textContent !== <span class="string">""</span> &amp;&amp; !isWrapMark(node)) &#123;</span><br><span class="line">      setCaches(node.textContent!, parent);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      generateTextMapString(node <span class="keyword">as</span> HTMLElement);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意：考虑到可能存在多个元素有相同文本，在建立映射时，<code>value</code>需要被设置成一个数组。</p>
<p>待到两种搜索都完成后，返回所有检索到的<code>HTMLElement</code>即可。</p>
<h3 id="文本标记"><a href="#文本标记" class="headerlink" title="文本标记"></a>文本标记</h3><p>针对关键字检索和<code>CSS</code>选择器查询两种不同的类型，各设置了标记策略，如果是关键字检索，使用特定的背景和文字颜色标记<strong>文本</strong>，如果是<code>CSS</code>选择器查询，则改变<strong>元素</strong>的背景色。</p>
<p>挡调用<code>next</code>方法时，会对下一个匹配到的文本进行标记，这包含两个过程：1）清空上一个标记（如果有的话）， 2）标记当前文本</p>
<h4 id="清空上一个标记"><a href="#清空上一个标记" class="headerlink" title="清空上一个标记"></a>清空上一个标记</h4><p>与其说叫<code>清空上一个标记</code>，不如叫做<strong>还原到未标记时的状态</strong>，在此之前，我们需要保存上一次标记的元素以及该元素未标记时的文本，有了这两个数据，清空操作就很好实现了：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">restoreMarked</span>(<span class="params">domObj: IDomFormated | <span class="literal">null</span>, text?: <span class="built_in">string</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!domObj || !domObj!.dom) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> &#123; dom, <span class="keyword">type</span> &#125; = domObj;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">type</span> === TypeText) &#123;</span><br><span class="line">    dom.innerHTML = text!;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">type</span> === TypeSelector) &#123;</span><br><span class="line">    <span class="keyword">const</span> prevBgColor = dom.dataset[<span class="string">"bgc"</span>] || <span class="string">""</span>;</span><br><span class="line">    dom.style.backgroundColor = prevBgColor;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="标记当前元素文本"><a href="#标记当前元素文本" class="headerlink" title="标记当前元素文本"></a>标记当前元素文本</h4><p>由于第一步<code>search</code>返回的是匹配到的<strong>元素</strong>，那么当某个元素中的文本含有多个匹配时，应当多次标记。所以，在标记过程中，使用<code>updateList</code>保存该元素中所有匹配结果所对应次更新的文本。在每次调用<code>next</code>方法时，如果<code>updateList</code>不为空，则取<code>updateList</code>中第一项作为当次更新的文本，否则取下一个匹配到的元素。基本实现如下：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">markKeywords</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  keywords: KeywordsOrSelector,</span></span></span><br><span class="line"><span class="function"><span class="params">  domObj: IDomFormated,</span></span></span><br><span class="line"><span class="function"><span class="params">  useRegexp: <span class="built_in">boolean</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; dom, <span class="keyword">type</span> &#125; = domObj;</span><br><span class="line">  <span class="keyword">let</span> updateList: <span class="built_in">string</span>[] = [];</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">type</span> === TypeText) &#123;</span><br><span class="line">    <span class="keyword">let</span> newText;</span><br><span class="line">    <span class="keyword">if</span> (!useRegexp) &#123;</span><br><span class="line">      newText = dom.innerHTML.replace(</span><br><span class="line">        keywords,</span><br><span class="line">        <span class="string">`&lt;span style="background-color: #169fe6; color: #ffffff;"&gt;<span class="subst">$&#123;keywords&#125;</span>&lt;/span&gt;`</span></span><br><span class="line">      );</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 存入所有结果到更新队列</span></span><br><span class="line">      <span class="keyword">const</span> reg = <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">`(<span class="subst">$&#123;keywords&#125;</span>)`</span>, <span class="string">"g"</span>);</span><br><span class="line">      <span class="keyword">const</span> domString = dom.innerHTML;</span><br><span class="line">      <span class="keyword">let</span> result = reg.exec(domString);</span><br><span class="line">      <span class="keyword">while</span> (result) &#123;</span><br><span class="line">        <span class="keyword">const</span> updateString =</span><br><span class="line">          dom.innerHTML.substring(<span class="number">0</span>, result.index) +</span><br><span class="line">          <span class="string">`&lt;span style="background-color: #169fe6; color: #ffffff;"&gt;<span class="subst">$&#123;result[0]&#125;</span>&lt;/span&gt;`</span> +</span><br><span class="line">          dom.innerHTML.substring(result.index + result[<span class="number">0</span>].length);</span><br><span class="line">        updateList.push(updateString);</span><br><span class="line">        result = reg.exec(domString);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (newText) &#123;</span><br><span class="line">      dom.innerHTML = newText;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">type</span> === TypeSelector) &#123;</span><br><span class="line">    <span class="keyword">const</span> prevBgColor = dom.style.backgroundColor;</span><br><span class="line">    dom.dataset[<span class="string">"bgc"</span>] = prevBgColor!;</span><br><span class="line">    <span class="comment">// 保存背景色，便于后续恢复</span></span><br><span class="line">    dom.style.backgroundColor = <span class="string">"#169fe6"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> updateList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>标记完后，使用<code>dom.scrollIntoView()</code>即可滚动当前元素到标记位置</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>页面文本搜索工具主要包含两个流程：<em>文本检索</em>和<em>文本标记</em>，为了加快检索速度，构建了文本到<code>HTMLElement</code>的映射缓存，该映射的生成遵守几个约定(<code>可能会出现问题</code>)，文本标记则分为两个子步骤：1.还原到未标记状态；2.标记当前文本。如果遇到一个元素中有多个匹配结果，建立了一个更新列表(<code>updateList</code>)，将分多次标记。</p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://yoursite.com/2020/08/07/local-search/" data-id="ckdjzksew00003cj6v1t94exj" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://yoursite.com/2020/08/07/local-search/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://yoursite.com/2020/08/07/local-search/">评论</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-compiler-apis" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2020/02/29/compiler-apis/">使用TypeScript Compiler APIs</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2020/02/29/compiler-apis/">
            <time datetime="2020-02-29T04:53:02.000Z" itemprop="datePublished">2020-02-29</time>
        </a>
    </div>


                        
                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/TypeScript-AST/">TypeScript AST</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <blockquote>
<p>一个进行中或完成的<code>React</code>项目如果要进行国际化，那么第一步需要从源码中提取中文词条，这往往是一个体力活，并且有无法找到所有的中文词条的风险。我们可以开发工具来代替人工提取，简单点可以使用基于字符串和正则表达式查找就可以完成，这种方式有一个很大问题：中文词条的提取效率取决于你正则表达式有多强大，并且如果后续有词条替换的需求，实现起来相对复杂。下面要介绍另一种方式，从<code>String -&gt; AST -&gt; String</code>的方式，这里我使用了<code>TS Compiler API</code>。</p>
</blockquote>
<h2 id="认识Compiler-APIs"><a href="#认识Compiler-APIs" class="headerlink" title="认识Compiler APIs"></a>认识<code>Compiler APIs</code></h2><p><code>TS</code>早在<em>2.x</em>版本就提供了一系列的<code>API</code>来更好的操作<code>TypeScript AST</code>，利用这些API，可以很方便的编写插件来影响<code>TS</code>编译过程，当然这些<code>API</code>也可以单独使用。关于<code>AST</code>这里并不做过多介绍，推荐一篇文章：<a href="https://blog.csdn.net/weixin_34119545/article/details/91371156" target="_blank" rel="noopener">深入Babel，这一篇就够了</a>，以<code>Babel</code>举例，详细描述了<code>Babel</code>编译(转译)的过程，以及如何编写<code>Babel</code>插件，<code>TS</code>的工作流程和<code>Babel</code>某种程度上是相似的。</p>
<p>下面介绍几个常用的<code>API</code>。</p>
<h3 id="createSourceFile"><a href="#createSourceFile" class="headerlink" title="createSourceFile"></a><code>createSourceFile</code></h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createSourceFile</span>(<span class="params">fileName: string, sourceText: string, languageVersion: ScriptTarget, setParentNodes?: boolean, scriptKind: ScriptKind</span>): <span class="title">SourceFile</span>;</span></span><br></pre></td></tr></table></figure>
<p>该方法接受源代码(文件名/字符串)并返回<code>SourceFile</code>，那<code>SourceFile</code>是否就是<code>AST</code>呢？再看<code>SourceFile</code>的定义：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">interface SourceFile extends Declaration &#123;</span><br><span class="line">    kind: SyntaxKind.SourceFile;</span><br><span class="line">    statements: NodeArray&lt;Statement&gt;;</span><br><span class="line">    endOfFileToken: Token&lt;SyntaxKind.EndOfFileToken&gt;;</span><br><span class="line">    fileName: string;</span><br><span class="line">    text: string;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>通过查看<code>SourceFile</code>的定义，我们可以把<code>SourceFile</code>当做是<code>TypeScript</code>的<code>AST</code>，其中<code>statements</code>属性是源代码语句的数组，<code>Statement</code>也就是<code>AST</code>中的节点(<code>Node</code>)。</p>
<p>好了，如果我们有一份使用<code>TS</code>的<code>React</code>源代码，对于每个<code>.tsx</code>文件而言，使用下面的方式就可以得到<code>AST</code>了。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ast = ts.createSourceFile(<span class="string">''</span>, codeString, ts.ScriptTarget.ES2015, <span class="literal">true</span>, ts.ScriptKind.TSX)</span><br></pre></td></tr></table></figure></p>
<h3 id="Printer"><a href="#Printer" class="headerlink" title="Printer"></a>Printer</h3><p>使用<code>createSourceFile</code>可以将源代码转成<code>SourceFile</code>，那么<code>Printer</code>就是把<code>SourceFile/Node</code>转成字符串的<code>APIs</code>，其常用的几个<code>API</code>如下：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createPrinter</span>(<span class="params">printerOptions?: PrinterOptions, handlers?: PrintHandlers</span>): <span class="title">Printer</span>;</span></span><br><span class="line"><span class="function"><span class="title">interface</span> <span class="title">Printer</span> </span>&#123;</span><br><span class="line">  printFile(sourceFile: SourceFile): string;</span><br><span class="line">  printNode(hint: EmitHint, <span class="attr">node</span>: Node, <span class="attr">sourceFile</span>: SourceFile): string;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ul>
<li><code>createPrinter</code>返回一个<code>Printer</code>实例，该实例可使用既定的<code>printerOptions</code>对<code>Node</code>和<code>SourceFile</code>进行打印(生成字符串形式)</li>
<li><code>printFile</code>依据<code>SourceFile</code>打印字符串源码，不进行任何转换</li>
<li><code>printNode</code>打印节点</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sourceFile: ts.SourceFile = </span><br><span class="line">  ts.createSourceFile(<span class="string">'test.ts'</span>, <span class="string">''</span>, ts.ScriptTarget.ES2015, <span class="literal">true</span>, ts.ScriptKind.TS);</span><br><span class="line"><span class="comment">// printFile</span></span><br><span class="line"><span class="keyword">const</span> printer = ts.createPrinter()</span><br><span class="line"><span class="built_in">console</span>.log(printer.printFile(sourceFile)) <span class="comment">// test.ts源码</span></span><br><span class="line"><span class="comment">// printNode</span></span><br><span class="line"><span class="keyword">const</span> node = ts.createAdd(ts.createLiteral(<span class="number">1</span>), ts.createLiteral(<span class="number">2</span>))</span><br><span class="line"><span class="built_in">console</span>.log(printer.printNode(ts.EmitHint.Expression, node, sourceFile)); <span class="comment">// 1 + 2</span></span><br><span class="line"><span class="comment">// note: `printNode`第三个参数其实和打印节点无直接关系</span></span><br></pre></td></tr></table></figure>
<h3 id="transform"><a href="#transform" class="headerlink" title="transform"></a>transform</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">transform</span>&lt;<span class="title">T</span> <span class="title">extends</span> <span class="title">Node</span>&gt;(<span class="params">source: T | T[], transformers: TransformerFactory&lt;T&gt;[], compilerOptions?: CompilerOptions</span>): <span class="title">TransformationResult</span>&lt;<span class="title">T</span>&gt;;</span></span><br></pre></td></tr></table></figure>
<p>生成<code>AST</code>后就要开始处理了，<code>ts</code>也提供了一系列的<code>API</code>用于遍历<code>AST</code>，<code>forEachChild</code>和<code>visitEachChild</code>都可以遍历<code>AST</code>，初次之外<code>visitEachChild</code>还可以修改节点，并返回修改后节点。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">visitEachChild</span>&lt;<span class="title">T</span> <span class="title">extends</span> <span class="title">Node</span>&gt;(<span class="params">node: T, visitor: Visitor, context: TransformationContext</span>): <span class="title">T</span>;</span></span><br><span class="line"><span class="function"><span class="title">function</span> <span class="title">forEachChild</span>&lt;<span class="title">T</span>&gt;(<span class="params">node: Node, cbNode: (node: Node</span>) =&gt; <span class="title">T</span> | <span class="title">undefined</span>, <span class="title">cbNodes</span>?: (<span class="params">nodes: NodeArray&lt;Node&gt;</span>) =&gt; <span class="title">T</span> | <span class="title">undefined</span>): <span class="title">T</span> | <span class="title">undefined</span>;</span></span><br></pre></td></tr></table></figure>
<p><code>transform</code>方法就和其字面意思一样，使用该方法可以转换<code>AST</code>。它接收多个<code>transformer</code>，最简单的<code>transformer</code>可以是下面这样：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> transformer = <span class="xml"><span class="tag">&lt;<span class="name">T</span> <span class="attr">extends</span> <span class="attr">ts.Node</span>&gt;</span>(context: ts.TransformationContext) =&gt; (rootNode: T) =&gt; &#123;</span></span><br><span class="line"><span class="xml">  function visit(node: T) &#123;</span></span><br><span class="line"><span class="xml">    console.log(node.kind)</span></span><br><span class="line"><span class="xml">    return ts.visitEachChild(node, visit, context)</span></span><br><span class="line"><span class="xml">  &#125;</span></span><br><span class="line"><span class="xml">  return ts.visitNode(rootNode, visit)</span></span><br><span class="line"><span class="xml">&#125;</span></span><br></pre></td></tr></table></figure></p>
<p>上面的<code>transformer</code>访问了每个节点，并且打印出当前访问节点的<code>kind</code>。</p>
<p>下面再写一个比较实际的<code>transformer</code>，找到所有的中文字符串节点，并使用变量来替换该节点。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> transformer = <span class="xml"><span class="tag">&lt;<span class="name">T</span> <span class="attr">extends</span> <span class="attr">ts.Node</span>&gt;</span>(context: ts.TransformationContext) =&gt; (rootNode: T) =&gt; &#123;</span></span><br><span class="line"><span class="xml">  function visit(node: T) &#123;</span></span><br><span class="line"><span class="xml">    if (node.kind === ts.SyntaxKind.StringLiteral &amp;&amp; node.text.match(/[^\x00-\xff]/g)) &#123;</span></span><br><span class="line"><span class="xml">      return ts.createIdentifier('placeholder')</span></span><br><span class="line"><span class="xml">    &#125;</span></span><br><span class="line"><span class="xml">    return ts.visitEachChild(node, visit, context)</span></span><br><span class="line"><span class="xml">  &#125;</span></span><br><span class="line"><span class="xml">  return ts.visitNode(rootNode, visit)</span></span><br><span class="line"><span class="xml">&#125;</span></span><br></pre></td></tr></table></figure>
<p>使用上面的<code>transformer</code>，<code>var name = &#39;张三&#39;</code>将会被转换成<code>var name = placeholder</code>，文件中所有的<code>StringLiteral</code>节点中只要包含中文都会被转成指定的<code>Identifier</code>。</p>
<p><code>TS</code>还提供了<code>create*</code>和<code>update*</code>多个<code>API</code>用于创建和更新节点，当对<code>compiler API</code>更加了解后，我们就可以做更多的事，例如<code>var total = 1 + 2</code> 变成<code>var t = 3</code>类似的代码压缩，自定义lint规则等等。</p>
<h2 id="Compiler-APIs的应用"><a href="#Compiler-APIs的应用" class="headerlink" title="Compiler APIs的应用"></a><code>Compiler APIs</code>的应用</h2><p>基于<code>Compiler APIs</code>实现了一款React国际化工具 <a href="https://github.com/xiaomoer/ext-intl" target="_blank" rel="noopener">ext-intl</a>，实现了<code>React</code>项目词条提取、词条key生成、代码原处替换等功能。该工具目前是可用的，一定程度上可以提升<code>React</code>项目国际化效率。</p>
<p>使用方式：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ yarn add --dev ext-intl</span><br></pre></td></tr></table></figure>
<p>完。</p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://yoursite.com/2020/02/29/compiler-apis/" data-id="ckdjzjuar000d7gj6thy0xvcm" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://yoursite.com/2020/02/29/compiler-apis/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://yoursite.com/2020/02/29/compiler-apis/">评论</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-use-battery" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2020/02/21/use-battery/">Battery Status API 以及useBattery</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2020/02/21/use-battery/">
            <time datetime="2020-02-21T07:50:32.000Z" itemprop="datePublished">2020-02-21</time>
        </a>
    </div>


                        
                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/HTML5-API/">HTML5 API</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <blockquote>
<p><strong>Battery Status API</strong>提供了系统层级的电池信息(电量/充电信息等)，并且在这些状态改变的时候提供了一系列的<code>eventListener</code>。</p>
</blockquote>
<p>有了这些信息，我们可以对应用进行优化。例如：</p>
<ul>
<li>用户使用电池供电，想要达到好的续航效果，我们可以降低对资源的使用。</li>
<li>用户电量低，我们可以先对用户操作和数据进行缓存，避免数据丢失。</li>
<li>持续收集用户数据，进行用户群体分析。</li>
<li>……</li>
</ul>
<blockquote>
<p><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Battery_Status_API" target="_blank" rel="noopener">兼容性</a> <strong>Battery Status API</strong>的支持度有限，目前只有<em>Chrome</em>和<em>Opera</em>以及<em>Android webview</em>支持度是比较好的，并且官方并不推荐使用该功能，未来或被移除。</p>
</blockquote>
<h3 id="navigator-getBattery"><a href="#navigator-getBattery" class="headerlink" title="navigator.getBattery"></a><code>navigator.getBattery</code></h3><p><code>getBattery</code>返回一个<code>Promise</code>对象，<code>resolve</code>后返回一个<code>battery</code>对象，该对象包含了<code>{ charging, chargingTime, dischargingTime, level }</code>分别表示是否在充电，充电时长，剩余可用时间，电池电量。例如，<code>{
  &quot;charging&quot;: true,
  &quot;level&quot;: 1,
  &quot;chargingTime&quot;: 0,
  &quot;dischargingTime&quot;: null
}</code>。</p>
<p>除此之外，<code>battery</code>对象还包含了4个<code>eventlistener</code>(<code>chargingchange</code>/<code>chargingtimechange</code>/<code>dischargingtimechange</code>/<code>levelchange</code>)，用于监听4个属性的改变。</p>
<p>下面来写一个例子，获取某一时刻的系统电量信息:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">getBattery</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> nav = navigator</span><br><span class="line">  <span class="keyword">if</span> (!nav || <span class="keyword">typeof</span> nav.getBattery !== <span class="string">'function'</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> battery  = <span class="keyword">await</span> navigator.getBattery()</span><br><span class="line">  <span class="built_in">console</span>.log(battery.level)</span><br><span class="line">  <span class="keyword">return</span> battery</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">getBattery()</span><br><span class="line">  .then(<span class="function"><span class="params">battery</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// do something</span></span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure>
<h3 id="useBattery"><a href="#useBattery" class="headerlink" title="useBattery"></a>useBattery</h3><blockquote>
<p>如果我们要在<code>React</code>中使用<code>Battery Status API</code>，我们仍然可以向上面一样，也可以配合上<code>React hooks</code>来实现一个<code>useBattery</code> hook。</p>
</blockquote>
<p>在开始写这个钩子之前，我们先理一下，由于获取电量信息是一个异步的过程，所以这个钩子除了返回上面提到的4个电量信息属性以外，还需要额外的一个属性用于记录数据是否获取完毕。</p>
<p>判断浏览器兼容性只需要判断<code>navigator</code>对象是否包含<code>getBattery</code>函数即可</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> isSupported = navigator &amp;&amp; <span class="keyword">typeof</span> navigator.getBattery === <span class="string">'function'</span></span><br></pre></td></tr></table></figure>
<p>获取某一时刻电量信息的<code>hook</code>如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; useState, useEffect &#125; <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> isSupported = navigator &amp;&amp; <span class="keyword">typeof</span> navigator.getBattery === <span class="string">'function'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useBattery</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(!isSupported) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> [state, setState] = useState(&#123; <span class="attr">fetching</span>: <span class="literal">true</span> &#125;)</span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    navigator.getBattery()</span><br><span class="line">      .then(<span class="function"><span class="params">battery</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> newState = &#123;</span><br><span class="line">          fetching: <span class="literal">false</span>,</span><br><span class="line">          charging: battery.charging,</span><br><span class="line">          level: battery.level,</span><br><span class="line">          dischargingTime: battery.dischargingTime,</span><br><span class="line">          chargingTime: battery.chargingTime,</span><br><span class="line">        &#125;</span><br><span class="line">        setState(newState)</span><br><span class="line">      &#125;)</span><br><span class="line">  &#125;, [])</span><br><span class="line">  <span class="keyword">return</span> state</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在某些情况下，我们可能并不仅仅需要某一时刻的电量信息，显然这一版本的<code>useBattery</code>并不能满足需要。我们需要监听<code>eventListeners</code>，并且在改变后变更状态。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; useState, useEffect &#125; <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> isSupported = navigator &amp;&amp; <span class="keyword">typeof</span> navigator.getBattery === <span class="string">'function'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; isEqual &#125; <span class="keyword">from</span> <span class="string">'lodash'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> bat;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useBattery</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(!isSupported) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> [state, setState] = useState(&#123; <span class="attr">fetching</span>: <span class="literal">true</span> &#125;)</span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">dealChange</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">const</span> newState = &#123;</span><br><span class="line">        fetching: <span class="literal">false</span>,</span><br><span class="line">        charging: battery.charging,</span><br><span class="line">        level: battery.level,</span><br><span class="line">        dischargingTime: battery.dischargingTime,</span><br><span class="line">        chargingTime: battery.chargingTime,</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (!isEqual(state, newState)) &#123;</span><br><span class="line">        setState(newState)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    navigator.getBattery()</span><br><span class="line">      .then(<span class="function"><span class="params">battery</span> =&gt;</span> &#123;</span><br><span class="line">        bat = battery</span><br><span class="line">        dealChange()</span><br><span class="line">        bat.addEventListener(<span class="string">'chargingchange'</span>, dealChange)</span><br><span class="line">        bat.addEventListener(<span class="string">'chargingtimechange'</span>, dealChange)</span><br><span class="line">        bat.addEventListener(<span class="string">'dischargingtimechange'</span>, dealChange)</span><br><span class="line">        bat.addEventListener(<span class="string">'levelchange'</span>, dealChange)</span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">          bat.removeEventListener(<span class="string">'chargingchange'</span>, dealChange)</span><br><span class="line">          bat.removeEventListener(<span class="string">'chargingtimechange'</span>, dealChange)</span><br><span class="line">          bat.removeEventListener(<span class="string">'dischargingtimechange'</span>, dealChange)</span><br><span class="line">          bat.removeEventListener(<span class="string">'levelchange'</span>, dealChange)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">  &#125;, [])</span><br><span class="line">  <span class="keyword">return</span> state</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面版本的<code>useBattery</code>已经比较完善了，针对每个属性都添加了<code>eventHandler</code>，当属性改变时获取新的state，并通过比较决定是否应用更改。</p>
<p><code>useEffect</code>第一个参数如果返回一个函数，那么将在<code>unmount</code>的时候执行，所以，上面的代码进行了<code>removeEventListener</code>。</p>
<h3 id="尾巴"><a href="#尾巴" class="headerlink" title="尾巴"></a>尾巴</h3><p>最近两周本该是上班的时间，由于疫情，我不得不在家待岗。起初的一周，睡睡懒觉， 看会儿NBA，再玩玩游戏，一天就浑浑噩噩的过了。可当游戏也玩得无聊了，懒觉也睡够了，我才发现我是真的没什么事做了，这种日子过得真的很难受！</p>
<p>今天给好久没打开过的<code>Mac</code>充电，翻翻上学时的记忆，无论是文档，代码，邮件…思绪回到六七年前，高中时代的自己，就是因为我对智能手机的狂热追求，我才选择了如今的职业。除此之外，还有一层不变的对游戏的热爱。我喜欢玩游戏，也曾想过做游戏，在上海的那一段日子，我畏畏缩缩的迈出过第一步(想法/剧本)，后来也不了了之。</p>
<p>是时候重新出发，在未来的很长一段时间里，想要摸索着迈出第二步。</p>
<p>完。</p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://yoursite.com/2020/02/21/use-battery/" data-id="ckdjzjubh001p7gj6z3zfx7b6" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://yoursite.com/2020/02/21/use-battery/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://yoursite.com/2020/02/21/use-battery/">评论</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-global-component" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2019/12/19/global-component/">React 实现全局组件</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2019/12/19/global-component/">
            <time datetime="2019-12-19T10:04:50.000Z" itemprop="datePublished">2019-12-19</time>
        </a>
    </div>


                        
                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/React/">React</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h3 id="React-实现全局组件"><a href="#React-实现全局组件" class="headerlink" title="React 实现全局组件"></a>React 实现全局组件</h3><blockquote>
<p>有一个这样的需求：用户进入首页时可能会有不同类型的对话框弹出，默认的情况下所有对话框都是打开的，这很影响用户体验。在无法减少对话框的前提下，需要实现一种机制，能够让对话框依次弹出。</p>
</blockquote>
<p>在<code>React-Native</code>中，一种不那么好的实现就是使用<code>DeviceEventEmitter</code>(一种类似<code>Node</code>中的事件机制)，并且创建一个容器组件用于管理对话框弹出，关闭。最终把容器组件挂载到页面中即可。</p>
<p>为了实现这样的需求，除了消息的收发管理，难点还在于如何把<em>容器组件</em>挂载到应用中，由于<code>React-Native</code>中并不存在<code>DOM</code>，所以要采用其它的方式，确保该容器挂载后，整个<code>App</code>使用阶段不会被卸载即可。</p>
<p>就此打住。</p>
<blockquote>
<p>React中实现全局组件的思想与之类似，下面就来实现一个<code>message</code>全局组件。</p>
</blockquote>
<p>最终的实现应该是这样使用的：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">import</span> message <span class="keyword">from</span> <span class="string">'./message'</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  handleClick = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    message(<span class="string">'这是一条message'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">Button</span> <span class="attr">onClick</span>=<span class="string">&#123;this.handleClick&#125;</span>&gt;</span>点击<span class="tag">&lt;/<span class="name">Button</span>&gt;</span></span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="容器组件"><a href="#容器组件" class="headerlink" title="容器组件"></a>容器组件</h4><p>容器组件用于管理<code>message</code>（提供一系列增删接口），并且渲染到<code>DOM</code>。</p>
<p>一个简易的容器组件可以是下面这样：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'./style.css'</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Message</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  state = &#123;</span><br><span class="line">    messageList: []</span><br><span class="line">  &#125;</span><br><span class="line">  add = <span class="function">(<span class="params">content</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; messageList &#125; = <span class="keyword">this</span>.state</span><br><span class="line">    <span class="keyword">this</span>.setState(&#123; <span class="attr">messageList</span>: [content, ...messageList]&#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  remove = <span class="function">(<span class="params">key</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; messageList &#125; = <span class="keyword">this</span>.state</span><br><span class="line">    <span class="keyword">const</span> result = messageList.filter(<span class="function"><span class="params">item</span> =&gt;</span> item.key !== key)</span><br><span class="line">    <span class="keyword">this</span>.setState(&#123; <span class="attr">messageList</span>: result &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  clear() &#123;</span><br><span class="line">    <span class="keyword">this</span>.setState(&#123; <span class="attr">messageList</span>: [] &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; messageList &#125; = <span class="keyword">this</span>.state</span><br><span class="line">    <span class="keyword">const</span> nodes = messageList.map(<span class="function"><span class="params">item</span> =&gt;</span> item.component ? item.component : <span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"message-item"</span>&gt;</span>&#123;item.content&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>)</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div className=<span class="string">"message-container"</span>&gt;</span><br><span class="line">        &#123; nodes &#125;</span><br><span class="line">      &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">    )</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure></p>
<p>上面实现的容器组件提供了<code>add</code>/<code>remove</code>/<code>clear</code>三个方法来对<code>message</code>进行管理，并最终渲染当前<code>messageList</code>中所有的消息。</p>
<p>接下来需要考虑如何把<em>容器组件</em>渲染到<code>DOM</code>，也可以说是把<em>容器组件</em>插入到<code>DOM</code>中。有多种方式可以选择：</p>
<ol>
<li><code>ReactDOM.render(element, container[, callback])</code>，这个方法的作用是把<code>React</code>元素渲染到指定的容器中，也是我们最常用的一种渲染到<code>DOM</code>的方法。</li>
<li><code>ReactDOM.createPortal(child, container)</code>，该方法的作用是<strong>将子节点渲染到存在于父组件以外的 DOM 节点中</strong>，该方法是这样使用的：<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 见：[https://zh-hans.reactjs.org/docs/portals.html]</span></span><br><span class="line">render() &#123;</span><br><span class="line">  <span class="comment">// React 并*没有*创建一个新的 div。它只是把子元素渲染到 `domNode` 中。</span></span><br><span class="line">  <span class="comment">// `domNode` 是一个可以在任何位置的有效 DOM 节点。</span></span><br><span class="line">  <span class="keyword">return</span> ReactDOM.createPortal(</span><br><span class="line">    <span class="keyword">this</span>.props.children,</span><br><span class="line">    domNode</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>既然是全局<code>message</code>组件，那么其一个理想的挂载的地方可以是<code>body</code>或者指定的<code>DOM</code>节点。下面，分别实现以上两种方式。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Message.init = <span class="function"><span class="params">container</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 创建内容容器</span></span><br><span class="line">  <span class="keyword">let</span> root = <span class="built_in">document</span>.createElement(<span class="string">'div'</span>)</span><br><span class="line">  <span class="keyword">if</span> (container) &#123;</span><br><span class="line">    container.appendChild(root)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">document</span>.body.appendChild(root)</span><br><span class="line">  &#125;</span><br><span class="line">  render(<span class="xml"><span class="tag">&lt;<span class="name">Message</span> /&gt;</span>, root)</span></span><br><span class="line"><span class="xml">&#125;</span></span><br></pre></td></tr></table></figure>
<p>在<code>Message</code>上新增了一个静态函数<code>init</code>，调用该函数就会把<code>Message</code>组件渲染到指定的<code>DOM</code>元素或者是<code>document.body</code>上。</p>
<p>这里有一个疑问，<code>Message</code>组件中提供了一系列接口来管理<code>message</code>，但通过以上的方式地区把<code>Message</code>组件挂载到<code>DOM</code>上了，却没法暴露接口供外部方法。这里有多种方式，第一种是<code>ReactDOM.render(element, container[, callback])</code>的返回值是其实是组件实例的引用，有了这个引用，外部就可以调用这些接口。这种方式已经不推荐使用，而推荐的方式也就是第二种方式<code>callback ref</code>，我们可以给组件绑定一个回调类型的<code>ref</code>，而这个<code>callback</code>以组件实例作为参数，我们可以通过这种方式来向外部暴露组件实例。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">Message.init = <span class="function">(<span class="params">container, callback</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 创建内容容器</span></span><br><span class="line">  <span class="keyword">let</span> root = <span class="built_in">document</span>.createElement(<span class="string">'div'</span>)</span><br><span class="line">  <span class="keyword">if</span> (container) &#123;</span><br><span class="line">    container.appendChild(root)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">document</span>.body.appendChild(root)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// callback</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">ref</span>(<span class="params">message</span>) </span>&#123;</span><br><span class="line">    callback(&#123;</span><br><span class="line">      add(content)&#123;</span><br><span class="line">        message.add(content)</span><br><span class="line">      &#125;,</span><br><span class="line">      remove(key) &#123;</span><br><span class="line">        message.remove(key)</span><br><span class="line">      &#125;,</span><br><span class="line">      clear() &#123;</span><br><span class="line">        message.clear()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  render(<span class="xml"><span class="tag">&lt;<span class="name">Message</span> <span class="attr">ref</span>=<span class="string">&#123;ref&#125;</span> /&gt;</span>, root)</span></span><br><span class="line"><span class="xml">&#125;</span></span><br></pre></td></tr></table></figure></p>
<p>我们给<code>init</code>方法增加了一个callback参数，通过这个callback就可以把组件实例暴露到外部中去。在<code>callback ref</code>中，我们调用<code>init</code>传入的<code>callback</code>参数，并把组件实例作为<code>callback</code>的参数，实际上，暴露整个组件实例是非常危险的，因此这里只是暴露了实例的几个外部调用接口。</p>
<h4 id="外部接口"><a href="#外部接口" class="headerlink" title="外部接口"></a>外部接口</h4><p>接下来实现外部接口，也就是我们外部调用的方法<code>message(content)</code>。实现容器组件的时候，我们实现了一个静态方法<code>Message.init</code>，该方法初始化了一个容器并挂载到<code>DOM</code>，并通过<code>callback</code>的方式对外暴露接口来管理<code>messageList</code>。因此，这个外部调用的方式只需要去实现<code>实现这个callback</code>。例如，我们实现的这个<code>message(content)</code>调用后三秒后就会消失。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Message <span class="keyword">from</span> <span class="string">'./message'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> messageInstance;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> index = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addMessage</span>(<span class="params">content</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> key = <span class="string">`<span class="subst">$&#123;index++&#125;</span>_MESSAGE_UNIQ_KEY`</span></span><br><span class="line">  messageInstance.add(&#123; key, content &#125;)</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    messageInstance.remove(key)</span><br><span class="line">  &#125;, <span class="number">3000</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">message</span>(<span class="params">content</span>) </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">callback</span>(<span class="params">instance</span>) </span>&#123;</span><br><span class="line">    messageInstance = instance</span><br><span class="line">    addMessage(content)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span>(!messageInstance) &#123;</span><br><span class="line">    Message.init(<span class="literal">null</span>, callback)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    addMessage(content)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> message</span><br></pre></td></tr></table></figure>
<p>上面的代码通过<code>callback</code>拿到了组件对外的接口并对外缓存<code>messageInstance</code>，针对每条消息生成了一个<code>UNIQUE_KEY</code>用于后续的消息移除。这里需要注意的是，<code>Message</code>只能实例化一次。</p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>至此，一个全局组件<code>message</code>已经完成了。当然，如果你想要看到更好的效果，还需要对容器和消息本身添加样式。我们还可以自定义消息组件，将接口通过<code>props</code>传入到组件中，更好的管理消息。</p>
<p><code>React</code>也提供了<code>ReactDOM.unmountComponentAtNode(container)</code>方法来卸载一个组件，当<code>message</code>组件不再需要的时候，最好将它从<code>DOM</code>中移除。</p>
<p>前面提到过<code>ReactDOM.createPortal(child, container)</code>同样可以将节点渲染到<code>DOM</code>。不多想要这种方式并不是很适合这种场景，因为对外暴露接口是一个难题，这里就不在演示了。</p>
<p>完。</p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://yoursite.com/2019/12/19/global-component/" data-id="ckdjzjuaw000k7gj67hx74tjs" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://yoursite.com/2019/12/19/global-component/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://yoursite.com/2019/12/19/global-component/">评论</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-dynamic-navigator" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2019/11/30/dynamic-navigator/">React-Navigation实现动态Tab路由</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2019/11/30/dynamic-navigator/">
            <time datetime="2019-11-30T04:49:36.000Z" itemprop="datePublished">2019-11-30</time>
        </a>
    </div>


                        
                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/React-Native/">React-Native</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <blockquote>
<p>有一个需求：在用户未登录和已经登陆的情况下，需要渲染不同的底部导航菜单，而该导航栏其实是<code>react-navigation-tabs</code>的实例，并且不支持动态导航。</p>
</blockquote>
<p>这个是一个很常见的需求，在这个<a href="https://github.com/react-navigation/react-navigation/issues/3945" target="_blank" rel="noopener">issue</a>下面有很多讨论，针对此需求，也提供了一系列解决方案。</p>
<h3 id="动态导航"><a href="#动态导航" class="headerlink" title="动态导航"></a>动态导航</h3><p>我们使用<code>createBottomTabNavigator(RouteConfigs, TabNavigatorConfig)</code>来创建<code>tab</code>导航，其中<code>RouteConfigs</code>接受一个导航名称和路由的映射对象，一般情况下，<code>RouteConfigs</code>是确定的，比如：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// tab nav配置</span></span><br><span class="line"><span class="keyword">const</span> RouteConfigs: TabOptions = &#123;</span><br><span class="line">  Home: &#123; <span class="attr">screen</span>: Home &#125;,</span><br><span class="line">  Purchase: &#123; <span class="attr">screen</span>: Purchase &#125;,</span><br><span class="line">  Brand: &#123; <span class="attr">screen</span>: Brand &#125;,</span><br><span class="line">  Sell: &#123; <span class="attr">screen</span>: Sell &#125;,</span><br><span class="line">  Management: &#123; <span class="attr">screen</span>: Management &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 创建底部tab路由</span></span><br><span class="line"><span class="keyword">const</span> BottomTabRoutes = createBottomTabNavigator(RouteConfigs, &#123;</span><br><span class="line">  ...TabNavigatorConfig</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// 接入到App路由中</span></span><br><span class="line"><span class="keyword">const</span> AppNavigator = createStackNavigator(</span><br><span class="line">  &#123;</span><br><span class="line">    TabRouter: &#123; <span class="attr">screen</span>: BottomTabRoutes &#125;,</span><br><span class="line">    ...pageRoutes</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p><code>createBottomTabNavigator</code>接收<code>RouteConfigs</code>作为参数，返回一个类型为<code>NavigationContainer</code>的值：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// NavigationContainer 类型定义</span></span><br><span class="line">interface NavigationContainer extends React.ComponentClass&lt;NavigationContainerProps NavigationNavigatorProps&lt;any&gt;&gt; &#123;...&#125;</span><br></pre></td></tr></table></figure></p>
<p>通过查看<code>NavigationContainer</code>的定义，可以发现其是一个<code>React</code>组件。所以第一种方式就是自定义一个组件，在该组件中返回<code>NavigationContainer</code>实例即可。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DynamicTabNavigater</span> <span class="keyword">extends</span> <span class="title">Compoent</span> </span>&#123;</span><br><span class="line">  _genNav() &#123;</span><br><span class="line">    <span class="keyword">let</span> NavConfig = [....]</span><br><span class="line">    <span class="comment">// 对`NavConfig`的一系列的处理</span></span><br><span class="line">    <span class="keyword">return</span> createBottomTabNavigator(NavConfig, &#123; ...otherConfig &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">const</span> Tabs = <span class="keyword">this</span>._genNav()</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">Tabs</span> /&gt;</span></span></span><br><span class="line"><span class="xml">  &#125;</span></span><br><span class="line"><span class="xml">&#125;</span></span><br><span class="line"><span class="xml">const AppNavigator = createStackNavigator(</span></span><br><span class="line"><span class="xml">  &#123;</span></span><br><span class="line"><span class="xml">    TabRouter: &#123; screen: DynamicTabNavigator &#125;,</span></span><br><span class="line"><span class="xml">    ...otherRouter</span></span><br><span class="line"><span class="xml">  &#125;</span></span><br><span class="line"><span class="xml">)</span></span><br></pre></td></tr></table></figure>
<p>这种方式在该<a href="https://github.com/react-navigation/react-navigation/issues/3945" target="_blank" rel="noopener">issue</a>被证实是可行的，但是在<code>React Navigation</code><strong><em>3.x</em></strong>版本中报错，显示缺少<code>AppContainer</code>，所以还需要使用<code>createAppContainer</code>创建一个容器。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">render() &#123;</span><br><span class="line">  <span class="keyword">const</span> Tabs = createAppContainer(<span class="keyword">this</span>._genNav())</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">Tabs</span> /&gt;</span></span></span><br><span class="line"><span class="xml">&#125;</span></span><br></pre></td></tr></table></figure>
<p>这样动态路由就实现了，并且能够在<strong>绝大部分情况下</strong>使用正常，由于使用<code>createAppContainer</code>创建了一个<em>容器</em>，如果该容器并无法包含所有路由，那么还需要的<code>AppContainer</code>，此时就会导航异常。</p>
<h3 id="实现二"><a href="#实现二" class="headerlink" title="实现二"></a>实现二</h3><p>继续关注<code>createBottomTabNavigator(RouteConfigs, TabNavigatorConfig)</code>方法，第二个参数<code>TabNavigatorConfig</code>包含一个属性<code>tabBarComponent?: React.ReactType</code>，该属性用于设置<code>tabBar</code>如何显示，该属性设置为一个组件。</p>
<p>所以机会来了！</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> React <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> &#123; BottomTabBar &#125; <span class="keyword">from</span> <span class="string">'react-navigation-tabs'</span></span><br><span class="line"><span class="keyword">import</span> &#123; DeviceEventEmitter &#125; <span class="keyword">from</span> <span class="string">'react-native'</span></span><br><span class="line"></span><br><span class="line">interface NavigatorState &#123;</span><br><span class="line">  showBrandPage: boolean</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DynamicTabNavigator</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span>&lt;<span class="title">any</span>, <span class="title">NavigatorState</span>&gt; </span>&#123;</span><br><span class="line">  state: NavigatorState = &#123;</span><br><span class="line">    showBrandPage: <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">  subscribe: any</span><br><span class="line">  componentDidMount() &#123;</span><br><span class="line">    <span class="keyword">this</span>.subscribe = DeviceEventEmitter.addListener(</span><br><span class="line">      <span class="string">'showBrand'</span>,</span><br><span class="line">      (data: boolean) =&gt; &#123;</span><br><span class="line">        <span class="keyword">this</span>.setState(&#123; <span class="attr">showBrandPage</span>: data &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">  componentWillUnmount() &#123;</span><br><span class="line">    <span class="comment">// tslint:disable-next-line: no-unused-expression</span></span><br><span class="line">    <span class="keyword">this</span>.subscribe &amp;&amp; <span class="keyword">this</span>.subscribe.remove()</span><br><span class="line">  &#125;</span><br><span class="line">  _tabNav = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; routes, index &#125; = <span class="keyword">this</span>.props.navigation.state</span><br><span class="line">    <span class="keyword">const</span> finalRoutes = [...routes]</span><br><span class="line">    <span class="keyword">const</span> &#123; showBrandPage &#125; = <span class="keyword">this</span>.state</span><br><span class="line">    <span class="comment">// ...一系列的操作</span></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      state: &#123;</span><br><span class="line">        index: finalRoutes.findIndex(<span class="function"><span class="params">route</span> =&gt;</span> currentRoute.key === route.key),</span><br><span class="line">        routes: finalRoutes</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; navigation, ...restProps &#125; = <span class="keyword">this</span>.props</span><br><span class="line">    <span class="keyword">const</span> tabNavConfig = <span class="keyword">this</span>._tabNav()</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">BottomTabBar</span> &#123;<span class="attr">...restProps</span>&#125; <span class="attr">navigation</span>=<span class="string">&#123;tabNavConfig&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="xml">  &#125;</span></span><br><span class="line"><span class="xml">&#125;</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">export default DynamicTabNavigator</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">const BottomTabRoutes = createBottomTabNavigator(tabNav, &#123;</span></span><br><span class="line"><span class="xml">  tabBarComponent: DynamicTabNavigator</span></span><br><span class="line"><span class="xml">&#125;)</span></span><br></pre></td></tr></table></figure>
<p>通过<code>eventListener</code>的方式接收路由变更信号，最终渲染<code>BottomTabBar</code>时使用修改过后的配置即可。</p>
<p>这种方式其实是一种<em>障眼法</em>，我们需要在配置静态Tab路由<code>RouteConfigs</code>时配置所有的Tab路由，在<code>DynamicTabNavigator</code>中通过<code>props</code>注入的<code>navigation.state.routes</code>拿到配置的静态路由，并经过一系列的处理最终得到渲染到<code>BottomTabBar</code>中的路由。需要注意的是，如果最终的路由相比静态路由有调整，那么需要更新<code>index</code>，否则点击路由跳转时会出现错误。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><blockquote>
<p>针对<code>React Navigation</code>无法支持动态路由的问题，以上给出了两种方案，能够在一定程度解决。</p>
</blockquote>
<ol>
<li>第一种方案按需挂载路由，可以算是“真”动态路由；</li>
<li>第二种方案从可定制的<code>tabBarComponent</code>入手，不改变路由配置，而是在渲染层进行控制，条件渲染<code>BottomTabBar</code>。</li>
</ol>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://yoursite.com/2019/11/30/dynamic-navigator/" data-id="ckdjzjuay000n7gj69culi9y5" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://yoursite.com/2019/11/30/dynamic-navigator/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://yoursite.com/2019/11/30/dynamic-navigator/">评论</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-polyfill" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2019/08/21/polyfill/">从@babel/preset-env谈多浏览支持构建</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2019/08/21/polyfill/">
            <time datetime="2019-08-21T11:35:57.000Z" itemprop="datePublished">2019-08-21</time>
        </a>
    </div>


                        
                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/Webpack/">Webpack</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h1 id="从-babel-preset-env谈多浏览支持构建"><a href="#从-babel-preset-env谈多浏览支持构建" class="headerlink" title="从@babel/preset-env谈多浏览支持构建"></a>从<code>@babel/preset-env</code>谈多浏览支持构建</h1><p>最近需要把一个在特定浏览器环境运行的Web应用移植到多浏览器，特别是要支持部分<strong>IE</strong>浏览器。项目打包完成，在<strong>IE 11</strong>下运行，并不能成功，提示<em>Map()未定义</em>。很显然，<strong>IE浏览器</strong>并不支持<code>ES6</code>语法，而在构建中也没有使用相应的<strong>填补</strong>。</p>
<p>在基于<code>Webpack</code> + <code>Babel</code>构建的应用中，我们一般会使用到<code>@babel/preset-env</code>这个包，它使用了各种工具转译我们编写的<code>ES6</code>代码，我们一般这么使用它：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// .babelrc</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"presets"</span>: [<span class="string">"@babel/preset-env"</span>]</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 或</span></span><br><span class="line"><span class="comment">// webpack.config.js</span></span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="built_in">module</span>: &#123;</span><br><span class="line">    rules: [</span><br><span class="line">      &#123;</span><br><span class="line">        test: <span class="regexp">/\.jsx?$/</span>,</span><br><span class="line">        loader: <span class="string">'babel-loader'</span>,</span><br><span class="line">        options: &#123;</span><br><span class="line">          presets: [</span><br><span class="line">            <span class="string">"@babel/preset-env"</span></span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不做额外配置的情况下，<code>@babel/preset-env</code>并不知道哪些<code>ES6+</code>的语法需要转译，所以最终的结果就是并没有转译。</p>
<h2 id="babel-preset-env的targets属性"><a href="#babel-preset-env的targets属性" class="headerlink" title="@babel/preset-env的targets属性"></a><code>@babel/preset-env</code>的<code>targets</code>属性</h2><p>为了兼容多浏览器，我们需要告知哪些应用构件时需要支持哪些浏览器，<code>@babel/preset-env</code>提供了<code>targets</code>属性进行配置，例如为<code>IE 10</code>构建，可以这样配置：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  targets: <span class="string">"ie 10"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们可以使用<code>browserslist</code>包来指定构建的目标浏览器，可以在<code>.browserslistrc</code>或是<code>package.json</code>中进行配置：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"browserslist"</span>: [</span><br><span class="line">  <span class="string">"&gt;0.2%"</span>,</span><br><span class="line">  <span class="string">"not dead"</span>,</span><br><span class="line">  <span class="string">"not ie &lt;= 10"</span>,</span><br><span class="line">  <span class="string">"not op_mini all"</span></span><br><span class="line">],</span><br></pre></td></tr></table></figure>
<p>上面的配置中包含4条查询语句，<code>&gt;0.2%</code>表示大于<code>0.2%</code>的市场份额，<code>not dead</code>表示近24个月还在支持的浏览器，所有查询语句见<a href="https://www.npmjs.com/package/browserslist" target="_blank" rel="noopener">npm</a>。</p>
<p>配置完成后，可以运行<code>npx browserslist</code>查看具体支持的浏览器版本。</p>
<h2 id="必不可少的useBuiltIns属性"><a href="#必不可少的useBuiltIns属性" class="headerlink" title="必不可少的useBuiltIns属性"></a>必不可少的<code>useBuiltIns</code>属性</h2><p>设置<code>browserslist</code>后构建的代码仍然不能很好的运行，这是因为项目中并没有加入<code>polyfill</code>，并且也未告知<code>@babel/preset-env</code>该如何处理<code>pliyfill</code>。<code>useBuiltIns</code>正是用来解决这一问题。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">useBuiltIns: <span class="literal">false</span> | <span class="string">"entry"</span> | <span class="string">"usage"</span></span><br></pre></td></tr></table></figure></p>
<p>当<code>useBuiltIns</code>设置为<code>&quot;entry&quot; | &quot;usage&quot;</code>的时候，<code>@babel/preset-env</code>将会使用<code>core-js</code>提供的填补。</p>
<p><code>&quot;entry&quot;</code>的意思就是，当我们在某个文件中<code>import &#39;core-js&#39;</code>但是该文件中只使用了到了<code>ES6</code>中的<code>String.prototype.padStart</code>方法，那么就上一句<code>import</code>就会在构建的时候被替换成<code>import &#39;core-js/modules/es.string.pad-start&#39;</code>。</p>
<p><code>&quot;usage&quot;</code>的作用同其字面意义，即为：按需加载。如果我们在某个文件中使用了<code>Map</code>，如果构建目标支持<code>Map</code>，那么就不会使用相应填补，否则会在构建时加上<code>import &#39;core-js/modules/es.map&#39;</code>。</p>
<p>现在设置<code>useBuiltIns: &quot;usage&quot;</code>。</p>
<h2 id="core-js及其使用"><a href="#core-js及其使用" class="headerlink" title="core-js及其使用"></a><code>core-js</code>及其使用</h2><p><code>core-js</code>是一个<code>ES6+</code>语法的<code>polyfill</code>，简单而言就是使用<code>ES3</code>的语法实现了到目前为止几乎所有<code>ES</code>新特性。并且可以按需加载且不会污染全局命名空间。</p>
<blockquote>
<p><code>core-js</code>有<code>2.x</code>和<code>3.x</code>两个版本，其区别就是<code>2.x</code>不支持目前最新的语法，这里可以按需选择<code>2.x</code>或者<code>3.x</code>版本安装。</p>
</blockquote>
<p>安装<code>core-js</code>：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add core-js</span><br></pre></td></tr></table></figure></p>
<p>使用<code>core-js</code>的需要注意的是该包需要在入口文件顶部导入，因为只有这样填补才会被完全用到。<br>对已使用<code>webpack</code>构建的项目可以在<code>config</code>中在入口中引入：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">entry: [<span class="string">'core-js/stable'</span>, <span class="string">'index.js'</span>]</span><br></pre></td></tr></table></figure></p>
<p>也可以在入口文件(一般为<code>src/index.js</code>)的顶部引入：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.js</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">'core-js/stable'</span></span><br></pre></td></tr></table></figure></p>
<p>引入完毕，再进行构建，不出意外已经能够在指定版本的浏览器中运行了。</p>
<h2 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h2><p><code>ES6+</code>语法的多浏览器兼容的确告一段落了，但是<code>浏览器API</code>，<code>CSS</code>兼容还有很多问题，浏览器兼容才刚刚开始。</p>
<p>比如，<code>IE</code>并不支持<code>fetch API</code>，所以要么我们需要一个<code>polyfill</code>，要么就修改业务代码。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add whatwg-fetch</span><br></pre></td></tr></table></figure></p>
<p>然后在入口文件中引入，<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">'whatwg-fetch'</span>;</span><br></pre></td></tr></table></figure></p>
<p>某些<code>CSS3</code>支持得也不够好，需要我们一个个去考虑。</p>
<p>兼容性是前端开发无法规避的问题，而解决兼容的过程是”痛苦的”，特别是当业务开发完成后才考虑兼容的问题，痛苦加倍。</p>
<p>痛苦并快乐着。</p>
<p>完。</p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://yoursite.com/2019/08/21/polyfill/" data-id="ckdjzjub2000x7gj69ff6x9ip" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://yoursite.com/2019/08/21/polyfill/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://yoursite.com/2019/08/21/polyfill/">评论</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-barrage" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2019/08/07/barrage/">从globalCompositeOperatio到蒙版弹幕</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2019/08/07/barrage/">
            <time datetime="2019-08-07T12:29:05.000Z" itemprop="datePublished">2019-08-07</time>
        </a>
    </div>


                        
                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/canvas/">canvas</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h1 id="从globalCompositeOperation到蒙版弹幕"><a href="#从globalCompositeOperation到蒙版弹幕" class="headerlink" title="从globalCompositeOperation到蒙版弹幕"></a>从<code>globalCompositeOperation</code>到<strong>蒙版弹幕</strong></h1><h2 id="globalCompositeOperation属性"><a href="#globalCompositeOperation属性" class="headerlink" title="globalCompositeOperation属性"></a><code>globalCompositeOperation</code>属性</h2><p><em>Canvas</em> 有一个不那么常用的属性<code>globalCompositeOperation</code>，作用是<strong>设置如何将一个源图像绘制到目标图像上</strong>。该如何理解？</p>
<p>在使用<em>Canvas</em>绘制图像时，我们可以多次调用<code>ctx.drawImage()</code>或者是其它绘图函数<code>ctx.fillRect()</code>等进行绘制。而<code>globalCompositeOperation</code>属性就指定了当前将要绘制的图像在画布上如果和已绘制的图形重合该怎样显示。该属性有多个可选值：</p>
<ul>
<li><code>source-over</code>默认值，目标图像重合部分将显示在上方(源图像被覆盖)。</li>
<li><code>source-in</code>目标图像中显示源图像。源图像只显示重合的部分，目标图像透明。</li>
<li><code>source-out</code>在目标图像之外显示源图像。只会显示非重合的部分，目标图像透明。</li>
<li><code>lighter</code> 显示源图像+目标图像。</li>
<li><code>copy</code> 只显示源图像。</li>
<li><code>xor</code> 亦或。</li>
<li><code>destination-*</code></li>
</ul>
<p>例如：当设置属性值为<code>source-over</code>时，下例将会显示为：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> canvas = <span class="built_in">document</span>.getElementById(<span class="string">'canvas'</span>);</span><br><span class="line"><span class="keyword">const</span> ctx = canvas.getContext(<span class="string">'2d'</span>);</span><br><span class="line">ctx.fillStyle = <span class="string">'red'</span>;</span><br><span class="line">ctx.fillRect(<span class="number">10</span>, <span class="number">10</span>, <span class="number">80</span>, <span class="number">40</span>);</span><br><span class="line">ctx.globalCompositeOperation = <span class="string">'source-over'</span>;</span><br><span class="line">ctx.fillStyle = <span class="string">'green'</span>;</span><br><span class="line">ctx.fillRect(<span class="number">20</span>, <span class="number">20</span>, <span class="number">80</span>, <span class="number">40</span>);</span><br></pre></td></tr></table></figure></p>
<p><img src="../images/sourceover.jpg" alt="source-over"></p>
<p>可以看到，后绘制的绿色图像(源图像)和先绘制的红色图像(目标图像)发生了重叠，而源图像在层叠上层。</p>
<p>再来看看属性值为<code>source-in</code>的情况：</p>
<p><img src="../images/sourcein.bmp" alt="source-in"></p>
<p>源图像和目标图像发生了重合，结果只显示了源图像的重合部分。</p>
<h2 id="蒙版弹幕"><a href="#蒙版弹幕" class="headerlink" title="蒙版弹幕"></a><strong>蒙版弹幕</strong></h2><p>不考虑弹幕内容、显示等因素，使用<code>Canvas</code>实现弹幕就是一个不断擦除和绘制的过程，弹幕本身是绘制在画布上的，和内容(视频、图片等)是分层显示的，并无直接关系。</p>
<p><code>Canvas</code>弹幕且不论性能，如果弹幕过多往往会挡住内容本身，体验并不好。<em>B站</em>的弹幕使用了名为<strong>蒙版弹幕</strong>的技术，这种技术可以让弹幕不遮挡内容主体。这里不讨论<em>B站</em>的<strong>蒙版弹幕</strong>是如何实现的，先来看看<code>CSS</code>中一个名叫<code>mask</code>的属性。</p>
<p><code>mask</code>属性用来设置<strong>遮罩</strong>，那么何为遮罩呢？简单点来说就是使用一张图片来遮住另一张图片，并且如果用于遮罩的图片包含透明的部分，透明部分将会被遮住，非透明部分将会显示为被遮罩图片的内容。</p>
<p><code>mask</code>的内容到此为止，是不是和<code>globalCompositeOperation = &#39;source-in&#39;</code>很像？其实我认为不是很像。</p>
<p>修改上面的例子，如果将两个图形绘制的区域完全重合，那么设置<code>globalCompositeOperation = &#39;source-in&#39;</code>后，不出意外，源图像将会完全覆盖目标图像。</p>
<p>如果我们把目标图像和源图像均换成两张等宽高的图片，那么源图片将会完全遮挡目标图片。</p>
<p>如果目标图像和源图像存在透明区域(<em>RGBA</em> 中 <em>Alpha</em> 为<code>0</code>的区域)，那么源图像会完全遮住目标图像，但是目标图像的透明区域仍然是透明的。</p>
<p>如果反向抠图后，目标图像只有主体是透明的，那么源图像将会覆盖目标图像的非主体区域，主体区域由于是透明的，无能为力。</p>
<p>把目标图像换成蒙版图片，把源图像换成包含弹幕的图像，那么，蒙版图像透明区域不会被覆盖。</p>
<p>此时再把覆盖后的图片渲染在<code>Canvas</code>上，大功告成。</p>
<p>回顾一下<code>globalCompositeOperation = &#39;source-in&#39;</code>的解释：<br><strong>目标图像中显示源图像。源图像只显示重合的部分，目标图像透明。</strong><br>目标图像会被完全覆盖，而源图像只显示重合的部分，由于透明区域并不属于目标图像，所以在透明区域并不会显示源图像。</p>
<p>先来看一个例子：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ctx.fillStyle = <span class="string">'red'</span>;</span><br><span class="line">ctx.beginPath();</span><br><span class="line">ctx.moveTo(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">ctx.lineTo(<span class="number">0</span>, <span class="number">150</span>);</span><br><span class="line">ctx.lineTo(<span class="number">150</span>, <span class="number">0</span>);</span><br><span class="line">ctx.fill();</span><br><span class="line">ctx.moveTo(<span class="number">150</span>, <span class="number">0</span>);</span><br><span class="line">ctx.lineTo(<span class="number">300</span>, <span class="number">150</span>);</span><br><span class="line">ctx.lineTo(<span class="number">300</span>, <span class="number">0</span>);</span><br><span class="line">ctx.fill();</span><br></pre></td></tr></table></figure>
<p>在<code>300</code>*<code>150</code>的画布上先绘制两个红色的三角形，作为目标图像，此时画布中间的区域是透明的。</p>
<p><img src="../images/source.bmp" alt="目标图像"></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ctx.globalCompositeOperation = <span class="string">'source-in'</span>;</span><br><span class="line">ctx.fillStyle = <span class="string">'green'</span>;</span><br><span class="line">ctx.fillRect(<span class="number">0</span>, <span class="number">0</span>, <span class="number">300</span>, <span class="number">150</span>);</span><br></pre></td></tr></table></figure>
<p>然后再绘制一个充满画布的矩形覆盖到目标图像上，此时的结果是这样的：</p>
<p><img src="../images/result.bmp" alt="覆盖结果"></p>
<p>目标图像(两个红色的三角形)已经被完全覆盖了，而透明区域仍然透明。</p>
<h2 id="简易实现"><a href="#简易实现" class="headerlink" title="简易实现"></a>简易实现</h2><p>为了实现<strong>蒙版弹幕</strong>，需要准备：</p>
<ul>
<li>原版图像</li>
<li>蒙版图像</li>
<li>Canvas弹幕</li>
</ul>
<p>这里原版图像使用下面这张<strong>菊花图</strong>：</p>
<p><img src="../images/flower.jpg" alt="原版图片"></p>
<p>经过抠图(主体变成透明)，生成的蒙版图片如下：</p>
<p><img src="../images/flower1.png" alt="蒙版图像"></p>
<p>弹幕系统的实现不做过多的介绍，这里只关注绘制，和上例的绘制过程一致，首先绘制蒙版图像，再绘制弹幕内容到蒙版上进行覆盖。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">drawBarrages() &#123;</span><br><span class="line">  <span class="keyword">let</span> context = <span class="keyword">this</span>.useMask ? <span class="keyword">this</span>.bgCtx : <span class="keyword">this</span>.ctx;</span><br><span class="line">  <span class="keyword">if</span>(<span class="keyword">this</span>.barrageList.length) &#123;</span><br><span class="line">    context.clearRect(<span class="number">0</span>, <span class="number">0</span>, <span class="keyword">this</span>.width, <span class="keyword">this</span>.height);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>; i &lt; <span class="keyword">this</span>.barrageList.length; i++) &#123;</span><br><span class="line">      <span class="comment">// 此时弹幕将要移除画布</span></span><br><span class="line">      <span class="keyword">let</span> barrage = <span class="keyword">this</span>.barrageList[i];</span><br><span class="line">      <span class="keyword">if</span>(barrage.left + barrage.width &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.barrageList.splice(i, <span class="number">1</span>); <span class="comment">// 移除该弹幕</span></span><br><span class="line">        i -= <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span>((barrage.left + barrage.width+<span class="number">600</span>) &lt; <span class="keyword">this</span>.width &amp;&amp; barrage.isChecked === <span class="literal">false</span>) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 此时已经完全出跑道并且还没有发起检查。</span></span><br><span class="line">        <span class="keyword">let</span> index = vm.statics.findIndex(<span class="function">(<span class="params">item</span>) =&gt;</span> item === barrage.top);</span><br><span class="line">        barrage.isChecked = <span class="literal">true</span>;</span><br><span class="line">        used[index] = <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      barrage.left = barrage.left - barrage.offset;</span><br><span class="line">      <span class="keyword">this</span>.drawOneBarrage(barrage);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// #1 擦除上次绘制</span></span><br><span class="line">    <span class="keyword">this</span>.ctx.clearRect(<span class="number">0</span>, <span class="number">0</span>, <span class="keyword">this</span>.width, <span class="keyword">this</span>.height);</span><br><span class="line">    <span class="comment">// #2 绘制蒙版图像</span></span><br><span class="line">    <span class="keyword">this</span>.ctx.putImageData(<span class="keyword">this</span>.maskImage, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// #3 设置compose类型</span></span><br><span class="line">    <span class="keyword">this</span>.ctx.globalCompositeOperation = <span class="string">'source-in'</span>;</span><br><span class="line">    <span class="comment">// #4 绘制弹幕</span></span><br><span class="line">    <span class="keyword">this</span>.ctx.drawImage(<span class="keyword">this</span>.bgCanvas, <span class="number">0</span>, <span class="number">0</span>, <span class="keyword">this</span>.width, <span class="keyword">this</span>.height);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">this</span>.stop = requestAnimationFrame(<span class="keyword">this</span>.drawBarrages.bind(<span class="keyword">this</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的代码是完整绘制一帧的逻辑，跳过绘制弹幕文本的循环，关注整体绘制和层叠逻辑。其中绘制总分为四步，擦除上一帧结果，绘制蒙版(作为目标图像)，设置<code>compose</code>类型为<code>source-in</code>，绘制弹幕(作为源图像)。</p>
<p>注意到，蒙版图像使用<code>ctx.putImageData</code>绘制，这表示蒙版图像是<code>ImageData</code>类型，可以通过<code>ctx.getImageData()</code>拿到(需先绘制在画布上)，这里也可以<code>png</code>图片作为蒙版图片直接绘制在画布上。</p>
<p><code>this.ctx.drawImage(this.bgCanvas, 0, 0, this.width, this.height)</code>用于绘制弹幕，<code>this.bgCanvas</code>是绘制了弹幕文本的<code>Canvas</code>画布，这里使用了<em>离屏Canvas</em> 技术，该画布并不会单独绘制在屏幕上。</p>
<p>绘制结果如下图：</p>
<p><img src="../images/maskdemo.bmp" alt="弹幕绘制结果"></p>
<p>可以看到，弹幕并没有遮挡我们的主体(<strong>菊花</strong>)，实现了<strong>蒙版弹幕</strong>的预期效果。</p>
<h2 id="尾巴"><a href="#尾巴" class="headerlink" title="尾巴"></a>尾巴</h2><p>我们的确实现了蒙版弹幕，其主体是使用<em>Canvas</em>绘制蒙版图片和弹幕在同一张画布上，并且设置<code>globalCompositeOperation = &#39;source-in&#39;</code>来达到弹幕完全覆盖蒙版的效果。</p>
<p>简易实现的内容主体是一张静态的图片，如果要实现视频<strong>蒙版弹幕</strong>效果，需要提供每一帧的蒙版图像。在渲染某一帧时，最终的结果使用该帧的蒙版图像和实时弹幕组合而成。</p>
<p>其实<strong>蒙版弹幕</strong>的关键是提供蒙版图像，对于单个图片还好，我们可以针对这张图片单独制作一张蒙版图像。但是对于视频<strong>蒙版弹幕</strong>，我们需要逐帧生成蒙版图像，工作量之大可想而知。并且如何生成蒙版图像，如何标注主体是关键中的关键。这一部分理应借助机器学习，进行图像识别和分割。</p>
<p>一个可行的办法是事先针对每个视频，先逐帧生成蒙版图像，在进行流媒体播放的时候同时传递蒙版图像，最终在前端进行组装，完成视频<strong>蒙版弹幕</strong>。</p>
<p>完。</p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://yoursite.com/2019/08/07/barrage/" data-id="ckdjzjuaz000p7gj6jayknjs9" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://yoursite.com/2019/08/07/barrage/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://yoursite.com/2019/08/07/barrage/">评论</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-hooks" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2019/07/07/hooks/">记一次React Hooks的使用</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2019/07/07/hooks/">
            <time datetime="2019-07-07T00:48:50.000Z" itemprop="datePublished">2019-07-07</time>
        </a>
    </div>


                        
                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/React/">React</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <blockquote>
<p>有这么一个需求：需要渲染一个表格，表格的内容会随着用户的操作而重新请求数据，并且在用户离开这个表格所在的页面(路由)后缓存数据，再次进入该页面的时使用已缓存数据。</p>
</blockquote>
<blockquote>
<p>目前在使用的表格组件是纯函数组件，只负责渲染，数据请求则写在其父组件，数组则存在<code>Redux</code>中。经过考虑，需要把数据请求的逻辑移入表格组件中，使得表格组件承担更多的职责，在<code>React 16.8</code>之前，我们不得不把表格组件写成<code>class</code>组件。</p>
</blockquote>
<p>而现在，可以使用<code>hooks</code>，以最少的更改，来实现这一需求。</p>
<h3 id="需要哪些hooks"><a href="#需要哪些hooks" class="headerlink" title="需要哪些hooks?"></a>需要哪些<code>hooks</code>?</h3><p>我们的需求是把请求数据的逻辑移入到表格组件中，表格的数据仍然保存在<code>Redux</code>中。众所周知，<em>数据获取</em>是一个有副作用的操作，而<code>useEffect</code>这个<code>hooks</code>就是用来处理有副作用的操作。</p>
<p>在使用<code>hooks</code>之前，我们一般在<code>componentDidMount</code>和<code>componentDidUpdate</code>或者是很少使用的<code>componentWillUnMount</code>来进行DOM操作，数据请求等副作用操作。而<code>useEffect</code>则可以简单的看做是这三个生命周期函数的合集，其在组件的这三个生命周期时，都会被调用到。</p>
<p>所以，使用<code>useEffect</code>解决了所有问题。</p>
<h4 id="“真”解决了所有问题？"><a href="#“真”解决了所有问题？" class="headerlink" title="“真”解决了所有问题？"></a>“真”解决了所有问题？</h4><p>先把代码写起来:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useEffect &#125; <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">const</span> MyTable = <span class="function">(<span class="params">&#123; fetchData, param &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    fetchData(param);</span><br><span class="line">  &#125;, [param])</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;Table /&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> connect(stateToProps,actionToProps)(MyTable);</span><br></pre></td></tr></table></figure></p>
<p>仅仅三行代码，就搞定了。更改<code>params</code>，一切正常；从其它页面进入，看起来也很正常。可为什么是看起来正常呢？因为你打开控制台，查看<code>network xhr</code>，再进入页面，请求发送了！并没有使用缓存的数据！</p>
<p>所以，问题并没有解决。</p>
<h3 id="如何更好的利用缓存数据"><a href="#如何更好的利用缓存数据" class="headerlink" title="如何更好的利用缓存数据"></a>如何更好的利用缓存数据</h3><blockquote>
<p>问题：既然<code>useEffect</code>能够在上述三个生命周期中都执行，那么有没有办法区分出首次渲染和更新呢？</p>
</blockquote>
<p>答案是肯定的！在上面的代码中，我们使用了<code>useEffect(func, [param])</code>的形式，其实<code>useEffect</code>的第二个参数如果指定，那么<code>useEffect</code>就不是每次都执行了，而是只有<code>param</code>改变了才会执行。并且特别的，如果第二个参数传入<code>[]</code>空数组，那么<code>useEffect</code>只会执行一次，也就是说，<code>useEffect</code>只会在<code>componentDidMount</code>执行！代码写起来：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 其它代码不变，再加一个hook</span></span><br><span class="line">useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (data.status !== <span class="string">'fulfilled'</span>) &#123;</span><br><span class="line">    fetchData(param);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;, [])</span><br></pre></td></tr></table></figure></p>
<p>上面的<code>hook</code>会在初次渲染完成后执行，如果缓存数据的状态不是<code>fulfilled</code>，才请求数据。</p>
<h3 id="问题仍然没有解决"><a href="#问题仍然没有解决" class="headerlink" title="问题仍然没有解决"></a>问题仍然没有解决</h3><blockquote>
<p>很显而易见的是，即便是加了一个<code>hook</code>，而第二个<code>useEffect</code>仍然会执行，所以仍然会在初次加载完成后请求数据。</p>
</blockquote>
<p>这时候，就需要另一个<code>hook</code>出场了，那就是<code>useState</code>，我们需要在组件中维持一个是否是首次渲染的状态，只有当非首次渲染的时候，才会去执行第一个<code>hook</code>，因此可以避免不必要的的数据请求。代码码起来：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> [isInitial, changeInitialToFalse] = useState(<span class="literal">true</span>);</span><br><span class="line">useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (!isInitial) &#123;</span><br><span class="line">    fetchData(param);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;, [param]);</span><br><span class="line">useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  changeInitialToFalse(<span class="literal">false</span>);</span><br><span class="line">  <span class="keyword">if</span> (data.status !== <span class="string">'fulfilled'</span>) &#123;</span><br><span class="line">    fetchData(param);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;, []);</span><br></pre></td></tr></table></figure></p>
<p>经过测试，这一次是真一切正常了，缓存也已经用上。</p>
<h3 id="尾巴"><a href="#尾巴" class="headerlink" title="尾巴"></a>尾巴</h3><p>这是一次再普通不过的组件改造，这也是我在实际项目中第一次使用<code>hooks</code>。并且经历了从最开始遇到需求到决定使用<code>hooks</code>来最小化修改，到遇到问题差点改成更熟悉的<code>class</code>组件，到最终解决问题。最大的收货是，我对<code>useEffect</code>的了解又深刻了一些。把数据请求逻辑移到组件内部，除了降低组件间的耦合，更大程度上可以配合前一篇提到的<code>ScrollLoad</code>来做真正的滚动加载。毕竟数据才是组件的灵魂，数据都不懒加载，组件懒加载的意义就减了一半，手动狗头。</p>
<p>完。</p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://yoursite.com/2019/07/07/hooks/" data-id="ckdjzjub0000s7gj60vwgan4z" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://yoursite.com/2019/07/07/hooks/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://yoursite.com/2019/07/07/hooks/">评论</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-resolve" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2019/07/07/resolve/">Webpack resolve解析</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2019/07/07/resolve/">
            <time datetime="2019-07-07T00:48:39.000Z" itemprop="datePublished">2019-07-07</time>
        </a>
    </div>


                        
                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/Webpack/">Webpack</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <blockquote>
<p>虽然在实际开发过程中，我们经常会使用<em>脚手架</em>来初始化一个项目，而<em>脚手架</em>一般都包含了完善的<code>webpack</code>配置，例如<strong>create-react-app</strong>这个脚手架，其把所有关于构建的内容封装在了<code>react-scripts</code>包中，在实际开发中，我们只需要运行<code>yarn run start/build/test</code>即可，它就可以帮我们搞定代码压缩、分隔，<code>jsx</code>和<code>es6</code>代码编译到<code>es5</code>等。</p>
</blockquote>
<p>回到<code>webpack</code>，我们都知道一个完整的<code>webpack</code>配置必定是要包含<em>入口(entry)</em>、<em>输出(output)</em>，可能还需要<em>模块-加载器(loader)</em>来处理不同类型的模块、或是使用<em>插件(plugin)</em>来在构建过程中自定义某些动作。除此之外，还有<code>webpack4</code>中才引入的用于性能和构建优化的<em>optimization</em>，还有用于开发环境的<em>开发服务器(devServer)</em>。还有不那么常用和深入人心的<em>解析(resolve)</em>。本篇将以<code>react-scripts</code>包的webpack配置中关于<code>resolve</code>的使用为基础，介绍如何在实际项目中可能会用到的自定义解析。</p>
<h4 id="他们是怎么写的"><a href="#他们是怎么写的" class="headerlink" title="他们是怎么写的"></a>他们是怎么写的</h4><p>首先来看看<code>react-scripts</code>关于<code>resolve</code>的配置：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">resolve: &#123;</span><br><span class="line">  modules: [<span class="string">'node_modules'</span>, paths.appNodeModules].concat(</span><br><span class="line">    modules.additionalModulePaths || []</span><br><span class="line">  ),</span><br><span class="line">  extensions: paths.moduleFileExtensions</span><br><span class="line">    .map(<span class="function"><span class="params">ext</span> =&gt;</span> <span class="string">`.<span class="subst">$&#123;ext&#125;</span>`</span>)</span><br><span class="line">    .filter(<span class="function"><span class="params">ext</span> =&gt;</span> useTypeScript || !ext.includes(<span class="string">'ts'</span>)),</span><br><span class="line">  alias: &#123;</span><br><span class="line">    <span class="string">'react-native'</span>: <span class="string">'react-native-web'</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  plugins: [</span><br><span class="line">    PnpWebpackPlugin,</span><br><span class="line">    <span class="keyword">new</span> ModuleScopePlugin(paths.appSrc, [paths.appPackageJson]),</span><br><span class="line">  ],</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure></p>
<ol>
<li><p><code>modules</code>属性：其指定了<code>webpack</code>在进行模块解析时应该搜索的目录，该属性可通过数组的方式指定一系列的路径，默认值是: <code>[&quot;node_modules&quot;]</code>，也就是说，在不指定该属性的情况下，如果我们引入<code>import xx from xx</code>，则<code>webpack</code>会默认在根目录的<code>node_modules</code>目录下查找该模块。上面的配置中指定了额外两种模块解析路径，其分别是<code>path.appNodeModules</code>和<code>modules.additionalModulePaths</code>，其中<code>path.appNodeModules</code>最终指向的是<code>path.resolve(fs.realpathSync(process.cwd()), &#39;node_modules&#39;)</code>也就是说，在默认情况下，该路径是<code>node_modules</code>的<strong>决定路径</strong>。<code>modules.additionalModulePaths</code>指向一个自定义路径，并通过<code>getAdditionalModulePaths(config)</code>方法生成该路径，如果<code>config</code>等于<code>{}</code>，则返回<code>process.env.NODE_PATH</code>(经过一些列的处理)，否则的话如果<code>config.baseUrl</code>存在且等于<code>modules.additionalModulePaths</code>或者<code>appSrc</code>则返回，否则抛出错误。也就是说，我们可以通过<code>jsconfig.json</code>来指定<code>baseUrl</code>属性，并且该属性只能是<code>node_modules</code>目录或<code>src</code>目录。</p>
</li>
<li><p><code>extensions</code>属性：自动解析的确定的扩展，默认值是<code>[&#39;.js&#39;, &#39;.json&#39;]</code>，也就是说，在默认情况下，我们<code>import ClsA from &#39;./clsa&#39;</code>，可以解析到<code>clsa.js</code>或是<code>cls.json</code>。上面的配置重写了<code>extensions</code>，定义了更多的扩展，并根据当前是否是<code>typescript</code>项目而是用对应的拓展。<code>paths.moduleFileExtensions</code>定义如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> moduleFileExtensions = [</span><br><span class="line">  <span class="string">'web.mjs'</span>,</span><br><span class="line">  <span class="string">'mjs'</span>,</span><br><span class="line">  <span class="string">'web.js'</span>,</span><br><span class="line">  <span class="string">'js'</span>,</span><br><span class="line">  <span class="string">'web.ts'</span>,</span><br><span class="line">  <span class="string">'ts'</span>,</span><br><span class="line">  <span class="string">'web.tsx'</span>,</span><br><span class="line">  <span class="string">'tsx'</span>,</span><br><span class="line">  <span class="string">'json'</span>,</span><br><span class="line">  <span class="string">'web.jsx'</span>,</span><br><span class="line">  <span class="string">'jsx'</span>,</span><br><span class="line">];</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>如何判别当前项目是<code>typescript</code>项目呢？<br><code>useTypeScript</code>是这样定义的：<code>const useTypeScript = fs.existsSync(paths.appTsConfig);</code>，很明显，通过判断是否存在<code>paths.appTsConfig</code>指向的文件也就是<code>tsconfig.json</code>，如果存在该文件，则表示该项目是中可以引用那些以<code>ts</code>为后缀的文件而不需要指定扩展名。</p>
<ol start="3">
<li>alias属性：创建模块的别名，确保在引入某些模块时可以变得简单。在上面中<code>alias</code>的配置是：<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">alias: &#123;</span><br><span class="line">  <span class="string">'react-native'</span>: <span class="string">'react-native-web'</span>,</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>也就是在我们使用名为<code>react-native</code>的模块时，其默认指向的是<code>react-native-web</code>模块，例如：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; View &#125; <span class="keyword">from</span> <span class="string">'react-native'</span>;</span><br></pre></td></tr></table></figure></p>
<p>此时项目中根本没安装<code>react-native</code>，仅安装了<code>react-native-web</code>，也就是说<code>react-native</code>成了<code>react-native-web</code>的别名。那么问题来了：为什么我们不直接写<code>import { View } from &#39;react-native-web&#39;</code>呢？</p>
<p>其实这涉及到<code>React-Native</code>强调的<code>一次编写，处处使用</code>，这里的使用并不仅仅是<strong>iOS</strong>和<strong>Android</strong>代码共用，而是<code>React-Native</code>和<code>Web</code>之间的代码共享。<code>react-native-web</code>就是这样一个库，它把<code>react-native</code>实现的组件实现成为<code>Web</code>组件，并且表现和<code>react-native</code>组件一致。这样，如果我们拿到的是一份<code>react-native</code>的代码，添加别名过后，就无需把所有的<code>react-native</code>全都改成<code>react-native-web</code>，这样就保证了两端代码的统一。</p>
<p>扯远了，继续。</p>
<ol start="4">
<li><code>plugins</code>属性：如果在配置解析的过程中需要插件的话，就可以在这里指定。上面的代码使用了<code>pnp-webpack-plugin</code>和<code>react-dev-utils/ModuleScopePlugin</code>，<code>pnp-webpack-plugin</code>是为了解决<code>require()</code>时过多的<code>I/O</code>操作带来的性能消耗，<code>pnp</code>思想来自<code>Yarn</code>团队，目的是为了解决安装和引用依赖效率过低问题。其建立了一张映射表，这张表记录了依赖版本关联和依赖与依赖之间的关联以及依赖存放的位置。有了这张表，就可以跳过繁琐的查找过程直接确定依赖在文件中的位置，从而提高性能。详情见<a href="https://stackoverflow.com/questions/53135221/what-does-yarn-pnp" target="_blank" rel="noopener">stackoverflow</a>。<code>ModuleScopePlugin</code>插件的官方解释是：该插件可以确保来自源程序目录(也就是<code>/src</code>)的相对导入不会使用到外部依赖。<code>new ModuleScopePlugin(paths.appSrc, [paths.appPackageJson])</code>接收两个参数，分别指定了源程序目录<code>/src</code>和<code>allowedFiles</code>指向了<code>package.json</code>文件。</li>
</ol>
<h4 id="更多的配置"><a href="#更多的配置" class="headerlink" title="更多的配置"></a>更多的配置</h4><ol>
<li><code>mainFields</code>属性：该属性是为了指定在不同环境中，默认使用哪个<code>webpack</code>的字段作为导入的入口。例如某个模块的<code>package.json</code>文件中执行了以下入口:<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="built_in">module</span>: <span class="string">'index.js'</span>,</span><br><span class="line">  main: <span class="string">'build/index.node.js'</span>,</span><br><span class="line">  browser: <span class="string">'build/index.js'</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>那么在<code>Node</code>环境下，默认会使用<code>build/index.node.js</code>导入，而在浏览器环境中，默认使用<code>build/index.js</code>导入。</p>
<ol start="2">
<li><code>mainFiles</code>属性：解析目录是默认使用的文件名。这个在实际开发中使用得比较多，例如我们开发的某个页面，文件路径为<code>/src/views/Home/index.js</code>，那么在实际使用这个页面的时候直接使用<code>import Home from &#39;./src/views/Home&#39;</code>即可，因为<code>mainFiles</code>默认的配置是：<code>[&#39;index&#39;]</code>，这个属性不建议自定义。</li>
</ol>
<p><code>resolve</code>还有很多属性，可以让我们充分自定义整个解析过程，但从<code>react-scripts</code>的实践上来看，其也是针对某些属性进行了定制，并没有一味的自定义。在对某个属性不是很熟悉并且没有过实践，建议不要盲目的修改。并且<code>resolve</code>的所有属性都提供了适应绝普通场景的默认值。最后，<code>resolve</code>使用愉快。</p>
<p>完。</p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://yoursite.com/2019/07/07/resolve/" data-id="ckdjzjub400117gj6q04og120" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://yoursite.com/2019/07/07/resolve/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://yoursite.com/2019/07/07/resolve/">评论</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-scrollload" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2019/06/27/scrollload/">来，实现一个“滚动加载”</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2019/06/27/scrollload/">
            <time datetime="2019-06-27T12:37:20.000Z" itemprop="datePublished">2019-06-27</time>
        </a>
    </div>


                        
                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/React/">React</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h3 id="从问题入手，实现一个滚动加载"><a href="#从问题入手，实现一个滚动加载" class="headerlink" title="从问题入手，实现一个滚动加载"></a>从问题入手，实现一个滚动加载</h3><h4 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h4><p>懒加载的实现很简单，例如图片需要懒加载的时候，在初始加载时并不直接加载图片，而是用一个其它的图片或者占位符占位，当其它优先级更高的内容加载完成后，再使用真实的图片替换占位图。具体呢就是在初始加载时并不知道图片的<code>src</code>或者<code>src</code>指向一个占位图片，而真实图片的路径则是放在<code>data-src</code>这样的自定义属性中，当需要加载时，使用<code>data-src</code>替换<code>src</code>即可。</p>
<p>在React中，如果我们需要懒加载一个组件，实现原理也类似：当不需要加载的时候渲染占位符，当需要加载的时候再去加载真正的加载。滚动加载就是懒加载的一种特殊情况，其触发方式是滚动，只有当组件在可视区域中时，才开始加载。</p>
<p>实现滚动加载并不简单，我们需要考虑以下几个问题：</p>
<ol>
<li>如何找到组件所处的滚动容器。</li>
<li>如何判定组件是否可见。</li>
<li>如何使用“更好”组件占位符。</li>
<li>处理性能瓶颈。</li>
</ol>
<h4 id="ScrollLoad实现"><a href="#ScrollLoad实现" class="headerlink" title="ScrollLoad实现"></a>ScrollLoad实现</h4><p>懒加载使用最为广泛的实现是<a href="https://www.npmjs.com/package/react-lazy-load" target="_blank" rel="noopener">react-lazy-load</a>，使用起来也很方便：<code>&lt;LazyLoad&gt;&lt;MyComponent /&gt;&lt;/LazyLoad&gt;</code>，使用提供的<code>LazyLoad</code>组件包裹需要懒加载的组件即可，并且它提供了多个属性，例如<code>height</code>可以设置当内容未加载时的高度，<code>offset</code>则可以指定组件开始加载时需要偏移的距离(单位:<code>px</code>)，除此之外，我们还可以指定懒加载是否使用防抖和节流来提升性能，具体的使用见<a href="https://www.npmjs.com/package/react-lazy-load" target="_blank" rel="noopener">react-lazy-load</a>。</p>
<p>虽然<code>react-lazy-load</code>是一个使用广泛的懒加载解决方案，但是在最近的项目中，我却不得不放弃使用它。因为<code>react-lazy-load</code>会更改<strong>原有的DOM结构!!!</strong>，所以如果要使用<code>react-lazy-load</code>，我必须更改原本的样式，这将会是一个浩大的工程。</p>
<p>所以，接下来将会实现一个不需要额外DOM结构的滚动加载组件<code>ScrollLoad</code>组件。</p>
<h5 id="问题1：如果找到组件所在的可滚动元素"><a href="#问题1：如果找到组件所在的可滚动元素" class="headerlink" title="问题1：如果找到组件所在的可滚动元素"></a>问题1：如果找到组件所在的可滚动元素</h5><p>这个问题其实是：<em>如何找到组件所在的最近的可滚动的父元素</em>。</p>
<p>但是为什么需要找到那个可滚动的父元素呢？因为需要在该父元素上绑定<code>scroll eventListener</code>，当父元素在滚动时，就可以根据监听函数实时获取滚动的距离，并依此决定组件显示与否。</p>
<p>那怎么样才能找到<strong>最近可滚动父元素</strong>呢？为了定位父元素，我们需要定位当前元素，然后再向上遍历，去查找<code>overflow</code>显式设置为<code>auto|scroll</code>的元素。</p>
<p>查找可滚动父元素代码如下：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getScrollParent</span>(<span class="params">element</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> style = <span class="function">(<span class="params">elem, prop</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (getComputedStyle !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> getComputedStyle(elem, <span class="literal">null</span>).getPropertyValue(prop);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> elem.style[prop];</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">const</span> overflow = <span class="function"><span class="params">node</span> =&gt;</span> style(node, <span class="string">'overflow'</span>) + style(node, <span class="string">'overflow-x'</span>) + style(node, <span class="string">'overflow-y'</span>);</span><br><span class="line">  <span class="comment">// 循环判断父节点是否可滚动这里暂不添加，直接去直接父元素</span></span><br><span class="line">  <span class="keyword">if</span> (!(element <span class="keyword">instanceof</span> HTMLElement)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">window</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> parent = element;</span><br><span class="line">  <span class="keyword">while</span> (parent) &#123;</span><br><span class="line">    <span class="comment">// 当前节点是body或者document</span></span><br><span class="line">    <span class="keyword">if</span> (parent === <span class="built_in">document</span>.body || parent === <span class="built_in">document</span>.documentElement) &#123;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 当期元素无父节点</span></span><br><span class="line">    <span class="keyword">if</span> (!parent.parentNode) &#123;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 判断节点是否含有overflow等属性的值</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="regexp">/(scroll|auto|inherit)/</span>.test(overflow(parent))) &#123;</span><br><span class="line">      <span class="keyword">return</span> parent;</span><br><span class="line">    &#125;</span><br><span class="line">    parent = parent.parentNode;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">window</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>实现参考了<code>react-lazy-load</code>的实现，通过当前节点向上查找直到找到第一个可滚动的父元素或遍历到顶层元素，并且每进行一次遍历，会通过正则检查当前元素的样式的<code>overflow overflow-x overflow-y</code>，如果为<code>scroll|auto</code>，则返回该父元素。</p>
<p>那么怎么得到当前元素呢？可以通过<code>ReactDOM.findDOMNode(component)</code>访问真实的DOM节点，如果有多个子节点的话，默认返回第一个。因为<code>ScrollLoad</code>组件并没有添加额外的DOM结构，所以通过<code>findDOMNode(this)</code>拿到的节点就是目标节点，也就是占位节点(因为就算组件初始状态下可见，那么也要等应用挂载后才去判断，所以首次渲染的是占位组件)。</p>
<h5 id="问题2：如何判定组件是否可见"><a href="#问题2：如何判定组件是否可见" class="headerlink" title="问题2：如何判定组件是否可见"></a>问题2：如何判定组件是否可见</h5><p>如果只考虑上下滚动的话，一个很简单的判断公式是：<code>offsetTop &lt; seenHeight + scrollTop</code>，就是：<strong>组件相对于可滚动父元素的偏移</strong> &lt; <strong>可滚动父元素的可视高度</strong> + <strong>可滚动父元素的滚动距离</strong>。上面的三个计算量中<code>offsetTop</code>和<code>seenHeight</code>都是固定不变的，所以一个组件是否可见取决于父元素当前滚动的距离。<code>seenHeight</code>很好计算：<code>parent.clientHeight</code>即可，<code>scrollTop</code>也很简单：<code>parent.scrollTop</code>，<code>offsetTop</code>计算稍微复杂。</p>
<p>如何计算<code>offsetTop</code>？如果最近可滚动父元素是直接父元素的话，直接通过<code>elem.offsetTop</code>就可以得到，如果包含多层嵌套，那么<code>offsetTop</code>就需要每一层元素相对于父元素的<code>offsetTop</code>相加，直到父元素等于目标父元素。简单的实现如下：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 该函数没有考虑节点异常的情况</span></span><br><span class="line"><span class="keyword">let</span> getNodeOffsetTop = <span class="function">(<span class="params">node, parent</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> current = node;</span><br><span class="line">  <span class="keyword">let</span> offsetTop = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> (current !== parent) &#123;</span><br><span class="line">    offsetTop += current.offsetTop;</span><br><span class="line">    current = current.parentElement;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> offsetTop;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>最后是判断组件是否可见的实现：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> checkVisible = <span class="function">(<span class="params">node, parent</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (!node || !parent) &#123;</span><br><span class="line">    <span class="keyword">this</span>.setState(&#123; <span class="attr">visible</span>: <span class="literal">true</span> &#125;);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; visible &#125; = <span class="keyword">this</span>.state;</span><br><span class="line">    <span class="keyword">if</span> (visible) &#123;</span><br><span class="line">      <span class="keyword">this</span>.parent.removeEventListener(<span class="string">'scroll'</span>, <span class="keyword">this</span>.scrollHandler);</span><br><span class="line">      <span class="keyword">return</span>; <span class="comment">// 直接返回不执行当次eventListener</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> seenHeight = parent.clientHeight;</span><br><span class="line">    <span class="keyword">let</span> scrollHeight = parent.scrollTop;</span><br><span class="line">    <span class="keyword">let</span> currentNode = findDOMNode(<span class="keyword">this</span>); <span class="comment">// 获取最新的dom结构</span></span><br><span class="line">    <span class="keyword">let</span> offsetTop = <span class="keyword">this</span>.getNodeOffsetTop(currentNode, parent);</span><br><span class="line">    <span class="comment">// 1. 当偏移高度小于可见高度</span></span><br><span class="line">    <span class="comment">// 2. 初始不可见的时候，当可视高度+滚动高度大于了偏移高度</span></span><br><span class="line">    <span class="keyword">if</span> (offsetTop &lt;= seenHeight + scrollHeight) &#123;</span><br><span class="line">      <span class="keyword">this</span>.setState(&#123; <span class="attr">visible</span>: <span class="literal">true</span> &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h5 id="问题3：如何使用“更好”组件占位符"><a href="#问题3：如何使用“更好”组件占位符" class="headerlink" title="问题3：如何使用“更好”组件占位符"></a>问题3：如何使用“更好”组件占位符</h5><p>理想情况下，一个好的占位组件应该是和真实组件一样大的<code>size</code>，这样的话初始情况和加载完成的情况下滚动条的长度都是一样长的，且在组件由不可见到可见这个过程中页面并不会因为组件前后的<code>size</code>而出现抖动。</p>
<p>而实际的情况是，我们并不能很好的拿到目标组件的样式并作用到占位组件上，因为占位组件总是先渲染。所以折中的做法是让<code>ScrollLoad</code>的使用者去提供占位组件，这样就把如何提供一个好的占位组件交给了使用者。</p>
<p>还有一种办法是，既然一个好的(只是我认为的)占位组件的<code>size</code>是等于目标组件的，那么我直接把用于布局的样式从目标组件上拿过来不就行了！所以无论是目标组件渲染后的真实DOM上的<code>className id style...</code>全部拿过来，如果高度是内容撑开的话，我们就拿渲染完成的高度直接设置到占位组件上。经过尝试，这种方法的确可行，但是需要付出的代价是需要花费时间在获取目标组件的样式和样式整理上，并且代码的可读性将一定程度的降低。</p>
<p>所以，关于占位组件，我暂时没有好的方法。</p>
<h5 id="问题4：性能瓶颈"><a href="#问题4：性能瓶颈" class="headerlink" title="问题4：性能瓶颈"></a>问题4：性能瓶颈</h5><p>在前面介绍<code>react-lazy-load</code>的时候提到过我们可以决定是否使用节流或防抖来解决性能问题。所以，在<code>ScrollLoad</code>上，也是用了<em>节流</em>来控制<code>scroll</code>触发的频率。代码如下：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.scrollHandler = throttle(<span class="keyword">this</span>.checkVisible(dom, parent), <span class="number">100</span>);</span><br><span class="line">parent.addEventListener(<span class="string">'scroll'</span>, <span class="keyword">this</span>.scrollHandler, &#123; <span class="attr">passive</span>: <span class="literal">true</span> &#125;);</span><br></pre></td></tr></table></figure></p>
<p>这里使用了<code>lodash/throttle</code>来实现节流，这样默认情况下，<code>scroll</code>事件只会每隔<code>100ms</code>触发一次。</p>
<p>上面的代码在使用<code>addEventListener</code>绑定监听函数时还是用到了该函数的第三个参数：<code>{ passive: true }</code>，<code>passive</code>的意思是<code>消极的、被动的</code>，如果不指定，在新版的<code>Chrome</code>中会有性能提示：<code>[Violation] Added non-passive event listener to a scroll-blocking &lt;some&gt; event. Consider marking event handler as &#39;passive&#39; to make the page more responsive.</code></p>
<p>其实在监听滚动事件是，我们可以通过<code>event.preventDefault()</code>来阻止浏览器的默认滚动行为，可当滚动触发时，浏览器并不知道我们的监听函数中是否阻止了默认行为，所以浏览器会等待，直到监听函数执行完，此时浏览器才会选择滚动与否。而执行监听函数往往需要时间，性能就会受到影响。</p>
<p>而设置<code>{ passive: true }</code>，可以在执行监听函数之前就告诉浏览器，并没有阻止默认滚动，因此在滚动触发时，浏览器就不会等待，直接滚动。显然<code>ScrollLoad</code>是需要执行浏览器滚动的，因此设置<code>{ passive: true }</code>可以提升性能。</p>
<p>在<code>checkVisible</code>函数中，有一段代码：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; visible &#125; = <span class="keyword">this</span>.state;</span><br><span class="line"><span class="keyword">if</span> (visible) &#123;</span><br><span class="line">  <span class="keyword">this</span>.parent.removeEventListener(<span class="string">'scroll'</span>, <span class="keyword">this</span>.scrollHandler);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这段代码很好理解，除了在组件卸载之前需要移除<code>listener</code>之外，一旦当某个组件可见，那么此时就没必要再监听滚动了，所以需要移除监听函数。</p>
<p>上面的代码还有一个问题，如果当某两次触发监听函数组件的状态刚好从<code>visible</code>为<code>false</code>切换到<code>true</code>，此时移除了监听函数，但当次函数还会再次执行，所以在移除监听函数后，直接返回，可以避免执行下面不必要的逻辑。因此，这段代码应该是：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; visible &#125; = <span class="keyword">this</span>.state;</span><br><span class="line"><span class="keyword">if</span> (visible) &#123;</span><br><span class="line">  <span class="keyword">this</span>.parent.removeEventListener(<span class="string">'scroll'</span>, <span class="keyword">this</span>.scrollHandler);</span><br><span class="line">  <span class="keyword">return</span>; <span class="comment">// 直接返回不执行当次eventListener</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="结尾"><a href="#结尾" class="headerlink" title="结尾"></a>结尾</h3><p>到此为止，一个基本可用的<code>ScrollLoad</code>组件就实现了，其实对于不同的使用场景，<code>ScrollLoad</code>的实现也可以略有不同，例如如果当前需要<code>scrollload</code>的组件是一些列表项组件，每个组件的样式外观都是一致的。这样的话，我们在写<code>lazyload</code>组件的时候，就可以把所有组件使用一个<code>LazyLoad</code>组件包裹起来，然后绑定一个监听函数，使用可显示的组件个数作为组件状态，每次滚动时监听函数根据已经滚动的高度去计算可见组件的个数，最后在渲染的时候遍历<code>this.props.children</code>，选择渲染组件或是占位组件即可。</p>
<p>附 <code>LazyLoad</code>实现代码：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; findDOMNode &#125; <span class="keyword">from</span> <span class="string">'react-dom'</span>;</span><br><span class="line"><span class="keyword">import</span> throttle <span class="keyword">from</span> <span class="string">'lodash/throttle'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Spin &#125; <span class="keyword">from</span> <span class="string">'@xx/xx-ui'</span>;</span><br><span class="line"><span class="keyword">import</span> ReactPlaceHolder <span class="keyword">from</span> <span class="string">'react-placeholder'</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getScrollParent</span>(<span class="params">element</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> style = <span class="function">(<span class="params">elem, prop</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (getComputedStyle !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> getComputedStyle(elem, <span class="literal">null</span>).getPropertyValue(prop);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> elem.style[prop];</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">const</span> overflow = <span class="function"><span class="params">node</span> =&gt;</span> style(node, <span class="string">'overflow'</span>) + style(node, <span class="string">'overflow-x'</span>) + style(node, <span class="string">'overflow-y'</span>);</span><br><span class="line">  <span class="comment">// 循环判断父节点是否可滚动这里暂不添加，直接去直接父元素</span></span><br><span class="line">  <span class="keyword">if</span> (!(element <span class="keyword">instanceof</span> HTMLElement)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">window</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> parent = element;</span><br><span class="line">  <span class="keyword">while</span> (parent) &#123;</span><br><span class="line">    <span class="comment">// 当前节点是body或者document</span></span><br><span class="line">    <span class="keyword">if</span> (parent === <span class="built_in">document</span>.body || parent === <span class="built_in">document</span>.documentElement) &#123;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 当期元素无父节点</span></span><br><span class="line">    <span class="keyword">if</span> (!parent.parentNode) &#123;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 判断节点是否含有overflow等属性的值</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="regexp">/(scroll|auto|inherit)/</span>.test(overflow(parent))) &#123;</span><br><span class="line">      <span class="keyword">return</span> parent;</span><br><span class="line">    &#125;</span><br><span class="line">    parent = parent.parentNode;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">window</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> EmptyCompBox = <span class="function">(<span class="params">&#123; ...props &#125;</span>) =&gt;</span> (</span><br><span class="line">  &lt;div &#123;...props&#125;&gt;</span><br><span class="line">    &lt;Spin size=<span class="string">"large"</span> className=<span class="string">"lazyload-center-spin"</span> /&gt;</span><br><span class="line">  &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">);</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">class ScrollLoad extends React.Component &#123;</span></span><br><span class="line"><span class="regexp">  state = &#123;</span></span><br><span class="line"><span class="regexp">    visible: false,</span></span><br><span class="line"><span class="regexp">  &#125;;</span></span><br><span class="line"><span class="regexp">  componentDidMount() &#123;</span></span><br><span class="line"><span class="regexp">    let dom = findDOMNode(this); /</span><span class="regexp">/ 取得当前节点</span></span><br><span class="line"><span class="regexp">    let parent = getScrollParent(dom);</span></span><br><span class="line"><span class="regexp">    this.parent = parent;</span></span><br><span class="line"><span class="regexp">    let visible = this.checkVisible(dom, parent); /</span><span class="regexp">/ 初始化检查是否可见</span></span><br><span class="line"><span class="regexp">    visible();</span></span><br><span class="line"><span class="regexp">    this.scrollHandler = throttle(this.checkVisible(dom, parent), 100);</span></span><br><span class="line"><span class="regexp">    parent.addEventListener('scroll', this.scrollHandler, &#123; passive: true &#125;);</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">  componentWillUnmount() &#123;</span></span><br><span class="line"><span class="regexp">    this.parent.removeEventListener('scroll', this.scrollHandler);</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">  getNodeOffsetTop = (node, parent) =&gt; &#123;</span></span><br><span class="line"><span class="regexp">    let current = node;</span></span><br><span class="line"><span class="regexp">    let offsetTop = 0;</span></span><br><span class="line"><span class="regexp">    while (current !== parent) &#123;</span></span><br><span class="line"><span class="regexp">      offsetTop += current.offsetTop;</span></span><br><span class="line"><span class="regexp">      current = current.parentElement;</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">    return offsetTop;</span></span><br><span class="line"><span class="regexp">  &#125;;</span></span><br><span class="line"><span class="regexp">  checkVisible = (node, parent) =&gt; &#123;</span></span><br><span class="line"><span class="regexp">    if (!node || !parent) &#123;</span></span><br><span class="line"><span class="regexp">      this.setState(&#123; visible: true &#125;);</span></span><br><span class="line"><span class="regexp">      return null;</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">    let seenHeight = parent.clientHeight;</span></span><br><span class="line"><span class="regexp">    let scrollHeight = parent.scrollTop;</span></span><br><span class="line"><span class="regexp">    return () =&gt; &#123;</span></span><br><span class="line"><span class="regexp">      const &#123; visible &#125; = this.state;</span></span><br><span class="line"><span class="regexp">      if (visible) &#123;</span></span><br><span class="line"><span class="regexp">        this.parent.removeEventListener('scroll', this.scrollHandler);</span></span><br><span class="line"><span class="regexp">        return; /</span><span class="regexp">/ 直接返回不执行当次eventListener</span></span><br><span class="line"><span class="regexp">      &#125;</span></span><br><span class="line"><span class="regexp">      let currentNode = findDOMNode(this); /</span><span class="regexp">/ 获取最新的dom结构</span></span><br><span class="line"><span class="regexp">      let offsetTop = this.getNodeOffsetTop(currentNode, parent);</span></span><br><span class="line"><span class="regexp">      /</span><span class="regexp">/ 1. 当偏移高度小于可见高度</span></span><br><span class="line"><span class="regexp">      /</span><span class="regexp">/ 2. 初始不可见的时候，当可视高度+滚动高度大于了偏移高度</span></span><br><span class="line"><span class="regexp">      if (offsetTop &lt;= seenHeight + scrollHeight) &#123;</span></span><br><span class="line"><span class="regexp">        this.setState(&#123; visible: true &#125;);</span></span><br><span class="line"><span class="regexp">      &#125;</span></span><br><span class="line"><span class="regexp">    &#125;;</span></span><br><span class="line"><span class="regexp">  &#125;;</span></span><br><span class="line"><span class="regexp">  render() &#123;</span></span><br><span class="line"><span class="regexp">    const &#123; visible &#125; = this.state;</span></span><br><span class="line"><span class="regexp">    const &#123; id, className, style &#125; = this.props;</span></span><br><span class="line"><span class="regexp">    return (</span></span><br><span class="line"><span class="regexp">      &lt;ReactPlaceHolder</span></span><br><span class="line"><span class="regexp">        ready=&#123;visible&#125;</span></span><br><span class="line"><span class="regexp">        customPlaceholder=&#123;&lt;EmptyCompBox id=&#123;id&#125; className=&#123;className&#125; style=&#123;style&#125; /</span>&gt;&#125;</span><br><span class="line">      &gt;</span><br><span class="line">        &#123;<span class="keyword">this</span>.props.children&#125;</span><br><span class="line">      &lt;<span class="regexp">/ReactPlaceHolder&gt;</span></span><br><span class="line"><span class="regexp">    );</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">export default ScrollLoad;</span></span><br></pre></td></tr></table></figure></p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://yoursite.com/2019/06/27/scrollload/" data-id="ckdjzjub1000u7gj6gmew9v3a" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://yoursite.com/2019/06/27/scrollload/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://yoursite.com/2019/06/27/scrollload/">评论</a>
    

        </footer>
    </div>
    
</article>



    <nav id="page-nav">
        <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/2/">下一页 &raquo;</a>
    </nav>
</section>
            
                
<aside id="sidebar">
   
        
    
        
    <div class="widget-wrap">
        <h3 class="widget-title">归档</h3>
        <div class="widget">
            <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">八月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">二月 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">十二月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">十一月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">八月 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">七月 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">六月 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">二月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">一月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">四月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">十月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">八月 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">七月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">五月 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">四月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">三月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">二月 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">一月 2017</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">十二月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">十一月 2016</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">十月 2016</a><span class="archive-list-count">5</span></li></ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">标签</h3>
        <div class="widget">
            <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/CSS/">CSS</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTML5-API/">HTML5 API</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JavaScript/">JavaScript</a><span class="tag-list-count">14</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Node-js/">Node.js</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/React/">React</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/React-Native/">React-Native</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TypeScript-AST/">TypeScript AST</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vue/">Vue</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Webpack/">Webpack</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/canvas/">canvas</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/webpack/">webpack</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/心灵记事/">心灵记事</a><span class="tag-list-count">1</span></li></ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">标签云</h3>
        <div class="widget tagcloud">
            <a href="/tags/CSS/" style="font-size: 12.5px;">CSS</a> <a href="/tags/HTML5-API/" style="font-size: 10px;">HTML5 API</a> <a href="/tags/JavaScript/" style="font-size: 20px;">JavaScript</a> <a href="/tags/Node-js/" style="font-size: 10px;">Node.js</a> <a href="/tags/React/" style="font-size: 17.5px;">React</a> <a href="/tags/React-Native/" style="font-size: 10px;">React-Native</a> <a href="/tags/TypeScript-AST/" style="font-size: 10px;">TypeScript AST</a> <a href="/tags/Vue/" style="font-size: 10px;">Vue</a> <a href="/tags/Webpack/" style="font-size: 15px;">Webpack</a> <a href="/tags/canvas/" style="font-size: 10px;">canvas</a> <a href="/tags/webpack/" style="font-size: 10px;">webpack</a> <a href="/tags/心灵记事/" style="font-size: 10px;">心灵记事</a>
        </div>
    </div>

    
        
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">链接</h3>
        <div class="widget">
            <ul>
                
                    <li>
                        <a href="http://smithyang.cn">smithyang</a>
                    </li>
                
            </ul>
        </div>
    </div>


    
    <div id="toTop" class="fa fa-angle-up"></div>
</aside>

            
        </div>
        <footer id="footer">
    <div class="outer">
        <div id="footer-info" class="inner">
            &copy; 2020 Limoer<br>
            Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>. Theme by <a href="http://github.com/ppoffice">PPOffice</a>
        </div>
    </div>
</footer>
        
    
    <script>
    var disqus_config = function () {
        
        this.page.identifier = 'undefined';
    };
    (function() { 
        var d = document, s = d.createElement('script');  
        s.src = '//' + 'limoer' + '.disqus.com/count.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>




    
        <script src="/libs/lightgallery/js/lightgallery.min.js"></script>
        <script src="/libs/lightgallery/js/lg-thumbnail.min.js"></script>
        <script src="/libs/lightgallery/js/lg-pager.min.js"></script>
        <script src="/libs/lightgallery/js/lg-autoplay.min.js"></script>
        <script src="/libs/lightgallery/js/lg-fullscreen.min.js"></script>
        <script src="/libs/lightgallery/js/lg-zoom.min.js"></script>
        <script src="/libs/lightgallery/js/lg-hash.min.js"></script>
        <script src="/libs/lightgallery/js/lg-share.min.js"></script>
        <script src="/libs/lightgallery/js/lg-video.min.js"></script>
    
    
        <script src="/libs/justified-gallery/jquery.justifiedGallery.min.js"></script>
    
    



<!-- Custom Scripts -->
<script src="/js/main.js"></script>

    </div>
</body>
</html>